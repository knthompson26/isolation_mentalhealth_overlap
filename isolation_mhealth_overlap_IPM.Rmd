---
title: "The overlap between social isolation and mental health problems: independent pathway model" 
output:  
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: false
    number_sections: false
    highlight: monochrome
    theme: flatly
    code_folding: show
    includes:
      after_body: footer.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      comment = NA,
                      prompt = FALSE,
                      cache = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      results = 'markup')

options(bitmapType = 'quartz') # to render fonts better
```

```{r Clear global environment, include=FALSE}
remove(list = ls())
```

```{r Load packages, include=FALSE}
library(knitr)
library(haven)
library(psych) 
library(bestNormalize)
library(OpenMx)
library(tidyr)
library(tidyverse)
library(dplyr) #conflicts with tidyverse for e.g. rename and row_number
```

# Source functions

```{r source functions, include=FALSE}
source("isolation_mhealth_functions.R")
```

# Read in data

```{r source the data file path, include=FALSE}
# source raw data directory
source("../isolation_mentalhealth_data_path.R")
```

```{r read in dta data file, include=FALSE}
dat.raw <- read_dta(paste0(data_path_raw, "Katie_23Sep22.dta"))
colnames(dat.raw)
```



### Column names

```{r select variables needed}
dat <- dat.raw %>%
  dplyr::select(
         atwinid,
         btwinid,
         familyid,
         rorderp5,
         torder,
         zygosity,
         sampsex,
         sisoe12,
         sisoy12,
         masce12,     # anxiety
         mascy12,   
         cdie12,      # depression
         cdiy12,
         conec12,     # antisocial behaviour / conduct disorder
         conyc12,
         psysympe12,  # psychosis - why is this not the tot scale variable - to give more variation?
         psysympy12,
         socisoe18,
         socisoy18,
         gadsxe18,    # anxiety
         gadsxy18,
         mdesxe18,    # depression
         mdesxy18,
         cdsxe18,     # antisocial behaviour / conduct disorder
         cdsxy18,
         psyexpe18,   # psychotic experiences
         psyexpy18
  )

colnames(dat)
```

### Recode variables into factors {.tabset .tabset-fade}

#### Sex

```{r recode sex}
dat <- dat %>%
  mutate(
    sex = 
      recode_factor(as_factor(sampsex),
        "1" = "Male",
        "2" = "Female"))

table(dat$sex)
```

#### Zygosity

```{r recode zygosity}
dat <- dat %>%
  mutate(
    zygosity = 
      recode_factor(as_factor(zygosity),
        "1" = "MZ",
        "2" = "DZ"))
table(dat$zygosity)
```

### Convert variables to numeric

```{r create numeric isolation variables}
dat <- dat %>%
  mutate(
    sisoe12 = as.numeric(sisoe12),
    sisoy12 = as.numeric(sisoy12),
    masce12 = as.numeric(masce12),       # anxiety
    mascy12 = as.numeric(mascy12),   
    cdie12 = as.numeric(cdie12),         # depression
    cdiy12 = as.numeric(cdiy12),
    conec12 = as.numeric(conec12),       # antisocial behaviour / conduct disorder
    conyc12 = as.numeric(conyc12),
    psysympe12 = as.numeric(psysympe12), # psychosis - why is this not the tot scale variable - to give more variation?
    psysympy12 = as.numeric(psysympy12),
    socisoe18 = as.numeric(socisoe18),
    socisoy18 = as.numeric(socisoy18),
    gadsxe18 = as.numeric(gadsxe18),     # anxiety
    gadsxy18 = as.numeric(gadsxy18),
    mdesxe18 = as.numeric(mdesxe18),     # depression
    mdesxy18 = as.numeric(mdesxy18),
    cdsxe18 = as.numeric(cdsxe18),       # antisocial behaviour / conduct disorder
    cdsxy18 = as.numeric(cdsxy18),
    psyexpe18 = as.numeric(psyexpe18),   # psychotic experiences
    psyexpy18 = as.numeric(psyexpy18)
  ) %>%
  select(                                # remove variables not needed
    -c(sampsex)
  )
```

# Variables lists

```{r select variables - raw}
# anxiety
selvars_anxe <- c("sisoe12", "masce12", "socisoe18", "gadsxe18")
selvars_anx <- c("sisoe12", "masce12", "socisoe18", "gadsxe18", 
                 "sisoy12", "mascy12", "socisoy18", "gadsxy18")

# depression
selvars_depe <- c("sisoe12", "cdie12", "socisoe18", "mdesxe18")
selvars_dep <- c("sisoe12", "cdie12", "socisoe18", "mdesxe18", 
                 "sisoy12", "cdiy12", "socisoy18", "mdesxy18")

# conduct
selvars_cone <- c("sisoe12", "conec12", "socisoe18", "cdsxe18")
selvars_con <- c("sisoe12", "conec12", "socisoe18", "cdsxe18", 
                 "sisoy12", "conyc12", "socisoy18", "cdsxy18")

# psychosis
selvars_psye <- c("sisoe12", "psysympe12", "socisoe18", "psyexpe18")
selvars_psy <- c("sisoe12", "psysympe12", "socisoe18", "psyexpe18",
                 "sisoy12", "psysympy12", "socisoy18", "psyexpy18")

# all 
selvars_anx_dep <- c("sisoe12", "masce12", "cdie12", "socisoe18", "gadsxe18", "mdesxe18",
                     "sisoy12", "mascy12", "cdiy12", "socisoy18", "gadsxy18", "mdesxy18")

selvars_dep_con <- c("sisoe12", "cdie12", "conec12", "socisoe18", "mdesxe18", "cdsxe18",
                     "sisoy12", "cdiy12", "conyc12", "socisoy18", "mdesxy18", "cdsxy18")

selvars <- c("sisoe12", "masce12", "cdie12", "conec12", "psysympe12", 
             "socisoe18", "gadsxe18", "mdesxe18", "cdsxe18", "psyexpe18",
             "sisoy12", "mascy12", "cdiy12", "conyc12", "psysympy12", 
             "socisoy18", "gadsxy18", "mdesxy18", "cdsxy18", "psyexpy18")

selvars_elder <- c("sisoe12", "masce12", "cdie12", "conec12", "psysympe12", 
                   "socisoe18", "gadsxe18", "mdesxe18", "cdsxe18", "psyexpe18")
```

```{r select variables - normalised}
# anxiety
selvars_anxe_norm <- c("sisoe12norm", "masce12norm", "socisoe18norm", "gadsxe18norm")
selvars_anx_norm <- c("sisoe12norm", "masce12norm", "socisoe18norm", "gadsxe18norm", 
                      "sisoy12norm", "mascy12norm", "socisoy18norm", "gadsxy18norm")

# depression
selvars_depe_norm <- c("sisoe12norm", "cdie12norm", "socisoe18norm", "mdesxe18norm")
selvars_dep_norm <- c("sisoe12norm", "cdie12norm", "socisoe18norm", "mdesxe18norm", 
                      "sisoy12norm", "cdiy12norm", "socisoy18norm", "mdesxy18norm")

# conduct
selvars_cone_norm <- c("sisoe12norm", "conec12norm", "socisoe18norm", "cdsxe18norm")
selvars_con_norm <- c("sisoe12norm", "conec12norm", "socisoe18norm", "cdsxe18norm", 
                      "sisoy12norm", "conyc12norm", "socisoy18norm", "cdsxy18norm")

# psychosis
selvars_psye_norm <- c("sisoe12norm", "psysympe12norm", "socisoe18norm", "psyexpe18norm")
selvars_psy_norm <- c("sisoe12norm", "psysympe12norm", "socisoe18norm", "psyexpe18norm",
                      "sisoy12norm", "psysympy12norm", "socisoy18norm", "psyexpy18norm")

# all 
selvars_norm <- c("sisoe12norm", "masce12norm", "cdie12norm", "conec12norm", "psysympe12norm", "socisoe18norm", "gadsxe18norm", "mdesxe18norm", "cdsxe18norm", "psyexpe18norm",
             "sisoy12norm", "mascy12norm", "cdiy12norm", "conyc12norm", "psysympy12norm", "socisoy18norm", "gadsxy18norm", "mdesxy18norm", "cdsxy18norm", "psyexpy18norm")

# all with non-normalised - not in the twin modelling specific order here only used to standardise all variables at once
selvars_norm_all <- c("sisoe12", "sisoy12", "masce12", "mascy12", "cdie12", "cdiy12", "conec12", "conyc12", "psysympe12", "psysympy12", 
                      "socisoe18", "socisoy18", "gadsxe18", "gadsxy18", "mdesxe18", "mdesxy18", "cdsxe18", "cdsxy18", "psyexpe18", "psyexpy18",
                      "sisoe12norm", "sisoy12norm", "masce12norm", "mascy12norm", "cdie12norm", "cdiy12norm", "conec12norm", "conyc12norm", "psysympe12norm", "psysympy12norm", 
                      "socisoe18norm", "socisoy18norm", "gadsxe18norm", "gadsxy18norm", "mdesxe18norm", "mdesxy18norm", "cdsxe18norm", "cdsxy18norm", "psyexpe18norm", "psyexpy18norm")
```

```{r select variables - normalised and sex regressed}
# anxiety
selvars_anxe_norm_reg <- c("sisoe12norm_reg", "masce12norm_reg", "socisoe18norm_reg", "gadsxe18norm_reg")
selvars_anx_norm_reg <- c("sisoe12norm_reg", "masce12norm_reg", "socisoe18norm_reg", "gadsxe18norm_reg", 
                 "sisoy12norm_reg", "mascy12norm_reg", "socisoy18norm_reg", "gadsxy18norm_reg")

# depression
selvars_depe_norm_reg <- c("sisoe12norm_reg", "cdie12norm_reg", "socisoe18norm_reg", "mdesxe18norm_reg")
selvars_dep_norm_reg <- c("sisoe12norm_reg", "cdie12norm_reg", "socisoe18norm_reg", "mdesxe18norm_reg", 
                 "sisoy12norm_reg", "cdiy12norm_reg", "socisoy18norm_reg", "mdesxy18norm_reg")

# conduct
selvars_cone_norm_reg <- c("sisoe12norm_reg", "conec12norm_reg", "socisoe18norm_reg", "cdsxe18norm_reg")
selvars_con_norm_reg <- c("sisoe12norm_reg", "conec12norm_reg", "socisoe18norm_reg", "cdsxe18norm_reg", 
                 "sisoy12norm_reg", "conyc12norm_reg", "socisoy18norm_reg", "cdsxy18norm_reg")

# psychosis
selvars_psye_norm_reg <- c("sisoe12norm_reg", "psysympe12norm_reg", "socisoe18norm_reg", "psyexpe18norm_reg")
selvars_psy_norm_reg <- c("sisoe12norm_reg", "psysympe12norm_reg", "socisoe18norm_reg", "psyexpe18norm_reg",
                 "sisoy12norm_reg", "psysympy12norm_reg", "socisoy18norm_reg", "psyexpy18norm_reg")

# all 
selvars_noanx_norm_reg <- c("sisoe12norm_reg", "cdie12norm_reg", "conec12norm_reg", "psysympe12norm_reg", 
                      "socisoe18norm_reg",  "mdesxe18norm_reg", "cdsxe18norm_reg", "psyexpe18norm_reg",
                      "sisoy12norm_reg",  "cdiy12norm_reg", "conyc12norm_reg", "psysympy12norm_reg",
                      "socisoy18norm_reg", "mdesxy18norm_reg", "cdsxy18norm_reg", "psyexpy18norm_reg")

selvars_norm_reg <- c("sisoe12norm_reg", "masce12norm_reg", "cdie12norm_reg", "conec12norm_reg", "psysympe12norm_reg", 
                      "socisoe18norm_reg", "gadsxe18norm_reg", "mdesxe18norm_reg", "cdsxe18norm_reg", "psyexpe18norm_reg",
                      "sisoy12norm_reg", "mascy12norm_reg", "cdiy12norm_reg", "conyc12norm_reg", "psysympy12norm_reg",
                      "socisoy18norm_reg", "gadsxy18norm_reg", "mdesxy18norm_reg", "cdsxy18norm_reg", "psyexpy18norm_reg")

# all with non-norm_regalised - not in the twin modelling specific order here only used to standardise all variables at once
selvars_norm_reg_all <- c("sisoe12", "sisoy12", "masce12", "mascy12", "cdie12", "cdiy12", "conec12", "conyc12", "psysympe12", "psysympy12", 
                      "socisoe18", "socisoy18", "gadsxe18", "gadsxy18", "mdesxe18", "mdesxy18", "cdsxe18", "cdsxy18", "psyexpe18", "psyexpy18",
                      "sisoe12norm_reg", "sisoy12norm_reg", "masce12norm_reg", "mascy12norm_reg", "cdie12norm_reg", "cdiy12norm_reg", "conec12norm_reg", "conyc12norm_reg", "psysympe12norm_reg", "psysympy12norm_reg", 
                      "socisoe18norm_reg", "socisoy18norm_reg", "gadsxe18norm_reg", "gadsxy18norm_reg", "mdesxe18norm_reg", "mdesxy18norm_reg", "cdsxe18norm_reg", "cdsxy18norm_reg", "psyexpe18norm_reg", "psyexpy18norm_reg")
```

# Data prep

## Skewness

```{r histograms}
# isolation
hist(dat$sisoe12)    # not normal
hist(dat$socisoe18)  # not normal
# anxiety
hist(dat$masce12)    # normal
hist(dat$gadsxe18)   # not normal
# depression
hist(dat$cdie12)     # not normal
hist(dat$mdesxe18)   # not normal
# conduct
hist(dat$conec12)    # not normal
hist(dat$cdsxe18)    # not normal
# psychosis
hist(dat$psysympe12) # not normal
hist(dat$psyexpe18)  # not normal
```

## Rank transformation

Almost all variables are non-normal. We will use the van der Waerden's rank-based transformation as used in [Rimfeld et al 2021](https://acamh.onlinelibrary.wiley.com/doi/full/10.1002/jcv2.12053). For analyses using transformed data, they conducted the van der Waerden transformation prior to residualizing for age and sex as recommended by [Pain et al. 2018](https://www.nature.com/articles/s41431-018-0159-6).  

I will transform all variables to get the normalised estimate.

```{r rank transform variables elder variables}
# isolation age 12
sisoe12_n <- bestNormalize(dat$sisoe12)    # select the type of transformation needed
dat$sisoe12norm <- predict(sisoe12_n)      # create normalised variable
hist(dat$sisoe12norm)                  
summary(dat$sisoe12norm)

# isolation age 18
socisoe18_n <- bestNormalize(dat$socisoe18)    
dat$socisoe18norm <- predict(socisoe18_n)  
hist(dat$socisoe18norm)                  
summary(dat$socisoe18norm)

# anxiety age 12 - wont actually use this as it's already normally distributed
masce12_n <- bestNormalize(dat$masce12)    
dat$masce12norm <- predict(masce12_n)  
hist(dat$masce12norm)                  
summary(dat$masce12norm)

# anxiety age 18
gadsxe18_n <- bestNormalize(dat$gadsxe18)    
dat$gadsxe18norm <- predict(gadsxe18_n)  
hist(dat$gadsxe18norm)                  
summary(dat$gadsxe18norm)

# depression age 12
cdie12_n <- bestNormalize(dat$cdie12)    
dat$cdie12norm <- predict(cdie12_n)  
hist(dat$cdie12norm)                  
summary(dat$cdie12norm)

# depression age 18
mdesxe18_n <- bestNormalize(dat$mdesxe18)    
dat$mdesxe18norm <- predict(mdesxe18_n)  
hist(dat$mdesxe18norm)                  
summary(dat$mdesxe18norm)

# conduct age 12
conec12_n <- bestNormalize(dat$conec12)    
dat$conec12norm <- predict(conec12_n)  
hist(dat$conec12norm)                  
summary(dat$conec12norm)

# conduct age 18
cdsxe18_n <- bestNormalize(dat$cdsxe18)    
dat$cdsxe18norm <- predict(cdsxe18_n)  
hist(dat$cdsxe18norm)                  
summary(dat$cdsxe18norm)

# psychosis age 12
psysympe12_n <- bestNormalize(dat$psysympe12)    
dat$psysympe12norm <- predict(psysympe12_n)  
hist(dat$psysympe12norm)                  
summary(dat$psysympe12norm)

# psychosis age 18
psyexpe18_n <- bestNormalize(dat$psyexpe18)    
dat$psyexpe18norm <- predict(psyexpe18_n)  
hist(dat$psyexpe18norm)                  
summary(dat$psyexpe18norm)
```

```{r rank transform variables younger variables}
# isolation age 12
sisoy12_n <- bestNormalize(dat$sisoy12)    # select the type of transformation needed
dat$sisoy12norm <- predict(sisoy12_n)  # create normalised variable
hist(dat$sisoy12norm)                  
summary(dat$sisoy12norm)

# isolation age 18
socisoy18_n <- bestNormalize(dat$socisoy18)    
dat$socisoy18norm <- predict(socisoy18_n)  
hist(dat$socisoy18norm)                  
summary(dat$socisoy18norm)

# anxiety age 12 - wont actually use this as it's already normally distributed
mascy12_n <- bestNormalize(dat$mascy12)    
dat$mascy12norm <- predict(mascy12_n)  
hist(dat$mascy12norm)                  
summary(dat$mascy12norm)

# anxiety age 18
gadsxy18_n <- bestNormalize(dat$gadsxy18)    
dat$gadsxy18norm <- predict(gadsxy18_n)  
hist(dat$gadsxy18norm)                  
summary(dat$gadsxy18norm)

# depression age 12
cdiy12_n <- bestNormalize(dat$cdiy12)    
dat$cdiy12norm <- predict(cdiy12_n)  
hist(dat$cdiy12norm)                  
summary(dat$cdiy12norm)

# depression age 18
mdesxy18_n <- bestNormalize(dat$mdesxy18)    
dat$mdesxy18norm <- predict(mdesxy18_n)  
hist(dat$mdesxy18norm)                  
summary(dat$mdesxy18norm)

# conduct age 12
conyc12_n <- bestNormalize(dat$conyc12)    
dat$conyc12norm <- predict(conyc12_n)  
hist(dat$conyc12norm)                  
summary(dat$conyc12norm)

# conduct age 18
cdsxy18_n <- bestNormalize(dat$cdsxy18)    
dat$cdsxy18norm <- predict(cdsxy18_n)  
hist(dat$cdsxy18norm)                  
summary(dat$cdsxy18norm)

# psychosis age 12
psysympy12_n <- bestNormalize(dat$psysympy12)    
dat$psysympy12norm <- predict(psysympy12_n)  
hist(dat$psysympy12norm)                  
summary(dat$psysympy12norm)

# psychosis age 18
psyexpy18_n <- bestNormalize(dat$psyexpy18)    
dat$psyexpy18norm <- predict(psyexpy18_n)  
hist(dat$psyexpy18norm)                  
summary(dat$psyexpy18norm)
```

## Regress out sex

We first normalised the twin variables, then regress out sex. We don't regress out age here as all twins were measured as close to thir birthday as possible. 

```{r Regress out age and sex}
# twin 1 - elder
## isolation
dat$sisoe12norm_reg <- (resid(lm(data = dat, sisoe12norm ~ sex, na.action = na.exclude))) 
dat$socisoe18norm_reg <- (resid(lm(data = dat, socisoe18norm ~ sex, na.action = na.exclude)))
## anxiety
dat$masce12norm_reg <- (resid(lm(data = dat, masce12norm ~ sex, na.action = na.exclude)))
dat$gadsxe18norm_reg <- (resid(lm(data = dat, gadsxe18norm ~ sex, na.action = na.exclude)))
## depression
dat$cdie12norm_reg <- (resid(lm(data = dat, cdie12norm ~ sex, na.action = na.exclude)))
dat$mdesxe18norm_reg <- (resid(lm(data = dat, mdesxe18norm ~ sex, na.action = na.exclude)))
## conduct
dat$conec12norm_reg <- (resid(lm(data = dat, conec12norm ~ sex, na.action = na.exclude)))
dat$cdsxe18norm_reg <- (resid(lm(data = dat, cdsxe18norm ~ sex, na.action = na.exclude)))
## psychosis
dat$psysympe12norm_reg <- (resid(lm(data = dat, psysympe12norm ~ sex, na.action = na.exclude)))
dat$psyexpe18norm_reg <- (resid(lm(data = dat, psyexpe18norm ~ sex, na.action = na.exclude)))

# twin 2 - younger
## isolation
dat$sisoy12norm_reg <- (resid(lm(data = dat, sisoy12norm ~ sex, na.action = na.exclude))) 
dat$socisoy18norm_reg <- (resid(lm(data = dat, socisoy18norm ~ sex, na.action = na.exclude)))
## anxiety
dat$mascy12norm_reg <- (resid(lm(data = dat, mascy12norm ~ sex, na.action = na.exclude)))
dat$gadsxy18norm_reg <- (resid(lm(data = dat, gadsxy18norm ~ sex, na.action = na.exclude)))
## depression
dat$cdiy12norm_reg <- (resid(lm(data = dat, cdiy12norm ~ sex, na.action = na.exclude)))
dat$mdesxy18norm_reg <- (resid(lm(data = dat, mdesxy18norm ~ sex, na.action = na.exclude)))
## conduct
dat$conyc12norm_reg <- (resid(lm(data = dat, conyc12norm ~ sex, na.action = na.exclude)))
dat$cdsxy18norm_reg <- (resid(lm(data = dat, cdsxy18norm ~ sex, na.action = na.exclude)))
## psychosis
dat$psysympy12norm_reg <- (resid(lm(data = dat, psysympy12norm ~ sex, na.action = na.exclude)))
dat$psyexpy18norm_reg <- (resid(lm(data = dat, psyexpy18norm ~ sex, na.action = na.exclude)))
```

## Create twin dataset

To remove the double entry in the data, we will remove everyone who has a "random twin order" variable of 0. This will then remove any birth order effects. 

```{r remove one twin pair row}
dat.twin <- dat %>% filter(rorderp5 == "1")
```

```{r datasets for MZ and DZ}
dat.twin.MZ <- dat.twin %>% filter(zygosity == "MZ")
dat.twin.DZ <- dat.twin %>% filter(zygosity == "DZ")

# male only
dat.twin.MZm <- dat.twin.MZ %>% filter(sex == "Male")
dat.twin.DZm <- dat.twin.DZ %>% filter(sex == "Male")
# female only
dat.twin.MZf <- dat.twin.MZ %>% filter(sex == "Female")
dat.twin.DZf <- dat.twin.DZ %>% filter(sex == "Female")
```

## Summary of MZ and DZ data

### Overall

```{r describe MZ and DZ data}
MZ_summary <- describe(dat.twin.MZ, 
                       skew = FALSE, 
                       range = FALSE)

DZ_summary <- describe(dat.twin.DZ, 
                       skew = FALSE, 
                       range = FALSE)
```

### Correlation matrices

```{r check again the phenotypic correlations}
# overall
cor(dat.twin[, selvars], use = "complete")

# MZ
cor(dat.twin.MZ[, selvars], use = "complete")

# DZ
cor(dat.twin.DZ[, selvars], use = "complete")
```

#### Heat map

```{r function to order the heatmap}
reorder_cor_matrix <- function(cor_matrix){
 dd <- as.dist((1-cor_matrix)/2)  # use correlation between variables as distance
 hc <- hclust(dd)
 cor_matrix <- cor_matrix[hc$order, hc$order]
}

# Get upper triangle of the correlation matrix
get_upper_tri <- function(cor_matrix){
    cor_matrix[lower.tri(cor_matrix)]<- NA
    return(cor_matrix)
  }
```

```{r list of variables for heatmap}
name.list <- c(
  "Isolation12",
  "Anxiety12",
  "Depression12",
  "Conduct12",
  "Psychosis12",
  "Isolation18",
  "Anxiety18",
  "Depression18",
  "Conduct18",
  "Psychosis18"
)
```

```{r heat map of all correlations}
# create data frame with just numeric antecedent variables
variable_data_frame <- as.data.frame(dat[,selvars_elder])
colnames(variable_data_frame) <- name.list

# get correlation matrix
isolation_cor_matrix <- cor(variable_data_frame, method = "pearson", use = "complete.obs")

# Reorder the correlation matrix
cor_matrix_full <- reorder_cor_matrix(isolation_cor_matrix)
  
#melt the values
metled_cor_matrix <- reshape::melt(cor_matrix_full, na.rm = TRUE)

#correlation heat map
correlation_heat_map <- ggplot(metled_cor_matrix, aes(X2, X1, fill = value)) +
 geom_tile(color = "white") +
 scale_fill_gradient2(low = "#343d99", high = "#a50026", mid = "white",
   midpoint = 0, limit = c(-1,1), space = "Lab",
    name="Pearson\nCorrelation") +
  theme_minimal() +
  labs(y = "",
       x = "",
       title = "Correlation heat map") +
 theme(axis.text.x = element_text(angle = 45, vjust = 1, size = 12, hjust = 1),
       axis.text.y = element_text(size = 12),
       plot.margin=grid::unit(c(0,0,0,0), "mm"),
       plot.title = element_text(size = 20),
       )+
 coord_fixed() +
  geom_text(aes(X2, X1, label = round(value, digits = 2)), color = "black", size = 4)

correlation_heat_map
```

```{r test significance of correlations}
# isolation12
cor.test(dat$sisoe12, dat$cdie12, use = "complete")
cor.test(dat$sisoe12, dat$conec12, use = "complete")
cor.test(dat$sisoe12, dat$psysympe12, use = "complete")
cor.test(dat$sisoe12, dat$socisoe18, use = "complete")
cor.test(dat$sisoe12, dat$mdesxe18, use = "complete")
cor.test(dat$sisoe12, dat$cdsxe18, use = "complete")
cor.test(dat$sisoe12, dat$psyexpe18, use = "complete")

# depression12
cor.test(dat$cdie12, dat$conec12, use = "complete")
cor.test(dat$cdie12, dat$psysympe12, use = "complete")
cor.test(dat$cdie12, dat$socisoe18, use = "complete")
cor.test(dat$cdie12, dat$mdesxe18, use = "complete")
cor.test(dat$cdie12, dat$cdsxe18, use = "complete")
cor.test(dat$cdie12, dat$psyexpe18, use = "complete")

# conduct12
cor.test(dat$conec12, dat$psysympe12, use = "complete")
cor.test(dat$conec12, dat$socisoe18, use = "complete")
cor.test(dat$conec12, dat$mdesxe18, use = "complete")
cor.test(dat$conec12, dat$cdsxe18, use = "complete")
cor.test(dat$conec12, dat$psyexpe18, use = "complete")

# psychosis12
cor.test(dat$psysympe12, dat$socisoe18, use = "complete")
cor.test(dat$psysympe12, dat$mdesxe18, use = "complete")
cor.test(dat$psysympe12, dat$cdsxe18, use = "complete")
cor.test(dat$psysympe12, dat$psyexpe18, use = "complete")

# isolation18
cor.test(dat$socisoe18, dat$mdesxe18, use = "complete")
cor.test(dat$socisoe18, dat$cdsxe18, use = "complete")
cor.test(dat$socisoe18, dat$psyexpe18, use = "complete")

# depression18
cor.test(dat$mdesxe18, dat$cdsxe18, use = "complete")
cor.test(dat$mdesxe18, dat$psyexpe18, use = "complete")

# conduct18
cor.test(dat$cdsxe18, dat$psyexpe18, use = "complete")
```

Here, all the correlations with anxiety are relatively low. We may have to consider removing it, and going for a 4 vairable model (at 2 time points).

```{r pheno correlations}
cor(dat[, selvars_anxe], use = "complete")
cor(dat[, selvars_depe], use = "complete")
cor(dat[, selvars_cone], use = "complete")
cor(dat[, selvars_psye], use = "complete")

round(cor(dat[, selvars_anxe_norm], use = "complete"),3)
round(cor(dat[, selvars_depe_norm], use = "complete"),3)
round(cor(dat[, selvars_cone_norm], use = "complete"),3)
round(cor(dat[, selvars_psye_norm], use = "complete"),3)
```

#### MZ

```{r MZ matrices}
# covariance matrix
covar.mz <- cov(dat.twin.MZ[, selvars], use = "complete")
# correlation matrix (standardized covariance)
cor.mz <- cor(dat.twin.MZ[, selvars], use = "complete")
# round(cor.mz, 3)
```

#### DZ

```{r DZ matrices}
# covariance matrix
covar.dz <- cov(dat.twin.DZ[, selvars], use = "complete")
# correlation matrix (standardized covariance)
cor.dz <- cor(dat.twin.DZ[, selvars], use = "complete")
# round(cor.dz, 3)
```


****

# IPM

This code is adapted from [Waszczuk et al 2021](https://link.springer.com/article/10.1007/s00787-020-01515-6) using a 2A, 2C, and 2E factor independent pathway model.

This model has two common ACE factors that span two time points, as well as specific factors that are specific for each variable no matter the time point.

![This IPM looks like this:](multivar_ipm.png)

Decisions to make for our analyses:

* We need to decide which sex differences we are modelling (means only or different paths). I think we should include means anyway in the model as it more accurately represents the data. 
* We need to think about if we want to consider reporter differences here - run different models for mum and teacher?
* Decide on constraints for common and specific factors
* Do we need a 1 factor IPM at 12 and 18 to compare our results to? 
* Once all models have been decided on, need to convert the specifying IPM into the functions created in ipm_functions.R
  
# All variables 

We will first run the full model with all variables included: Social isolation, anxiety, depression, conduct disorder, psychosis at age 12 and 18. 

```{r number of variables (phenotypes)}
# number of variables
nv <- 10    					    # number of variables - 2 for each construct (2*5)
ntv <- nv*2 				      # number of twin variables
nlower <- nv*(nv+1)/2 		# number of free elements in an nv*nv lower matrix 

# number of common factors 
nfAc <- 2 # change dimension of A factor matrix Ac to have *2* common factors

# Set if the parameters are estimated (TRUE) or not (FALSE) 
Ac2Free   <- c(rep(TRUE, nv), rep(FALSE, nv/2), rep(TRUE, nv/2))  

# Create start values for 2 common ACE Factors - set the start values for common 
Ac2Values <- c(rep(.1, nv),  rep(0, nv/2), rep(.1, nv/2))  
Cc2Values <- c(rep(.1, nv),  rep(0, nv/2), rep(.1, nv/2))
Ec2Values <- c(rep(.1, nv),  rep(0, nv/2), rep(.1, nv/2))

# default optimiser 
mxOption(NULL, "Default optimizer", "CSOLNP") # change to NPSOL and see?

set.seed(2468)
```

* For `Ac2Free`, we want to indicate `TRUE` for the first 4 variables (all variables), then for the **second** A factor, we want this to be only for the second set of 2 variables (at age 18), so for this we want the first two variables (age 12) set to `FALSE`. 
* Similarly, we then want to set the second common start values to be 0 using `Ac2Values`. 

```{r labels for IPM_allvar}
# labels for common paths
aclab <- c("ac1", "ac2", "ac3", "ac4", "ac5", "ac6", "ac7", "ac8", "ac9", "ac10", 
           "ac11", "ac12", "ac13", "ac14", "ac15", "ac16", "ac17", "ac18", "ac19", "ac20")
cclab <- c("cc1", "cc2", "cc3", "cc4", "cc5", "cc6", "cc7", "cc8", "cc9", "cc10", 
           "cc11", "cc12", "cc13", "cc14", "cc15", "cc16", "cc17", "cc18", "cc19", "cc20")
eclab <- c("ec1", "ec2", "ec3", "ec4", "ec5", "ec6", "ec7", "ec8", "ec9", "ec10", 
           "ec11", "ec12", "ec13", "ec14", "ec15", "ec16", "ec17", "ec18", "ec19", "ec20")

# labels for specific paths
aslab <- c("as1", "as2", "as3", "as4", "as5", "as6", "as7", "as8", "as9", "as10")
cslab <- c("cs1", "cs2", "cs3", "cs4", "cs5", "cs6", "cs7", "cs8", "cs9", "cs10")
eslab <- c("es1", "es2", "es3", "es4", "es5", "es6", "es7", "es8", "es9", "es10")
```

## No sex differences

### ACE

#### Specify

```{r ACE model for IPM_allvar}
IPM_allvar <- mxModel("IPM_allvar",
	mxModel("ACE",
    # Common ace paths
    mxMatrix("Full", nrow = nv, ncol = nfAc, free = Ac2Free, labels = aclab, values = Ac2Values, name = "ac"),
    mxMatrix("Full", nrow = nv, ncol = nfAc, free = Ac2Free, labels = cclab, values = Cc2Values, name = "cc"),
    mxMatrix("Full", nrow = nv, ncol = nfAc, free = Ac2Free, labels = eclab, values = Ec2Values, name = "ec"),
    		
    # Specific ace paths
    mxMatrix("Diag", nrow = nv, ncol = nv, free = TRUE, labels = aslab, values = 0.6,  name = "as"),
    mxMatrix("Diag", nrow = nv, ncol = nv, free = TRUE, labels = cslab, values = 0.01, name = "cs"),
    mxMatrix("Diag", nrow = nv, ncol = nv, free = TRUE, labels = eslab, values = 0.6,  name = "es"),
		
		# ACE variance components
    mxAlgebra(ac %*% t(ac) + as %*% t(as), name = "A"), 
    mxAlgebra(cc %*% t(cc) + cs %*% t(cs), name = "C"),
    mxAlgebra(ec %*% t(ec) + es %*% t(es), name = "E"),
    mxAlgebra(A + C + E, name = "V"),
		
		# Calculate standard deviation for standardization
    mxMatrix("Iden", nrow = nv, ncol = nv, name = "I"),
    mxAlgebra(solve(sqrt(I*V)), name = "iSD"), # extracting the variances from the diagonal of the covariance matrix V 
		
		# Expected means vector
    mxMatrix("Full", nrow = 1, ncol = ntv, free = TRUE, values = 0.01, name = "expMean"), 

    # Genetic and environmental correlations (correlated factor solution)
    mxAlgebra(solve(sqrt(I*V)) %&% V, name = "Rph"),
    mxAlgebra(solve(sqrt(I*A)) %&% A, name = "Ra"),
    mxAlgebra(solve(sqrt(I*C)) %&% C, name = "Rc"),
    mxAlgebra(solve(sqrt(I*E)) %&% E, name = "Re"),

    # Standardised components of variance
    mxAlgebra(A/V, name = "h2"),
    mxAlgebra(C/V, name = "c2"),
    mxAlgebra(E/V, name = "e2"),
    
    # Standardise common parameters (unsquared)
    mxAlgebra(iSD %*% ac, name = "stac"),
    mxAlgebra(iSD %*% cc, name = "stcc"),
    mxAlgebra(iSD %*% ec, name = "stec"),
    
    # Standardise common parameters (Squared)
    mxAlgebra(stac*stac, name = "stac2"),
    mxAlgebra(stcc*stcc, name = "stcc2"),
    mxAlgebra(stec*stec, name = "stec2"),
    
    # Standardise specific parameters (unsquared)
    mxAlgebra(iSD %*% as, name = "stas"),
    mxAlgebra(iSD %*% cs, name = "stcs"),
    mxAlgebra(iSD %*% es, name = "stes"),
    
    # Standardise specific parameters (Squared)
    mxAlgebra(stas*stas, name = "stas2"),
    mxAlgebra(stcs*stcs, name = "stcs2"),
    mxAlgebra(stes*stes, name = "stes2"),	
	
		# MZ expected covariance matrix
		mxAlgebra(rbind(cbind(A+C+E, A+C), cbind(A+C, A+C+E)), name = "expCovMZ"),
		
		# DZ expected covariance matrix
		mxAlgebra(rbind(cbind(A+C+E, (0.5%x%A)+C), cbind((0.5%x%A)+C, A+C+E)), name = "expCovDZ")
		
	),
	
	mxModel("MZ",
		mxData(observed = dat.twin.MZ, type = "raw"),
		mxExpectationNormal(covariance = "ACE.expCovMZ", means = "ACE.expMean", dimnames = selvars_norm_reg),
		mxFitFunctionML()
	),
	mxModel("DZ",
		mxData(observed = dat.twin.DZ, type = "raw"),
		mxExpectationNormal(covariance = "ACE.expCovDZ", means = "ACE.expMean", dimnames = selvars_norm_reg),
		mxFitFunctionML()
	),

	mxAlgebra(MZ.objective + DZ.objective, name = "m2LL"),
	mxFitFunctionAlgebra("m2LL"),
	mxCI(c("ACE.stac2", "ACE.stcc2", "ACE.stec2", "ACE.stas2", "ACE.stcs2", "ACE.stes2", "ACE.Rph"))
)
```

```{r run ACE mdoel for all variables}
IPM_allvar_fit <- mxTryHard(IPM_allvar, intervals = FALSE)
summary(IPM_allvar_fit)
```

#### Output 

```{r output for IPM_allvar_nopsy_fit}
IPM_esitmates_ACE_10var_noCI(data = IPM_allvar_fit,
                  variable1 = "Isolation12",
                  variable2 = "Anxiety12",
                  variable3 = "Depression12",
                  variable4 = "Conduct12",
                  variable5 = "Psychosis12",
                  variable6 = "Isolation18",
                  variable7 = "Anxiety18",
                  variable8 = "Depression18",
                  variable9 = "Conduct18",
                  variable10 = "Psychosis18",
                  model = "ACE",
                  uniACEestimates = TRUE,
                  pathestimates = TRUE,
                  A_percent = TRUE,
                  C_percent = TRUE,
                  E_percent = TRUE,
                  common_factor_contribution = TRUE)
```

*Univariate ACE estimates*
                   a2      c2       e2
Isolation 12     0.419   0.000    0.581
Anxiety 12       0.285   0.097    0.618
Depression 12    0.211   0.146    0.643
Conduct 12       0.197   0.249    0.554
Psychosis 12     0.103   0.187    0.710

Isolation 18     0.450   0.000    0.550
Anxiety 18       0.235   0.000    0.765
Depression 18    0.315   0.000    0.685
Conduct 18       0.195   0.270    0.535
Psychosis 18     0.237   0.042    0.721


#### Submodels

**NEED TO CHECK THAT THE ONES I AM DROPPING ARE NON-SIGNIFICANT - TO DO THIS RERUN ALL WITH INTERVALS = TRUE**

We now need to check if there are very small effects that we can constrain to be zero. According to Dirk Pelt, we also need to check for any negative variances and set these to be zero. 

Here we can check all the output to see if any of the variances are negative - this can sometimes be called  a Heywood case, which means that more than 100% of the variable's variance is explained by the (latent) factor(s), which implies that the residual variance is negative. For a model with one factor, it means that the (standardized) loading is larger than 1.00.

```{r checknegative variances for common and specific paths}
# common squared parameters - variances
mxEval(ACE.stac2, IPM_allvar_fit)
mxEval(ACE.stcc2, IPM_allvar_fit)
mxEval(ACE.stec2, IPM_allvar_fit)

# specific squared parameters - variances
mxEval(ACE.stas2, IPM_allvar_fit)
mxEval(ACE.stcs2, IPM_allvar_fit)
mxEval(ACE.stes2, IPM_allvar_fit)

# common unsquared parameters
mxEval(ACE.stac, IPM_allvar_fit)
mxEval(ACE.stcc, IPM_allvar_fit)
mxEval(ACE.stec, IPM_allvar_fit)

# specific unsquared parameters
mxEval(ACE.stas, IPM_allvar_fit)
mxEval(ACE.stcs, IPM_allvar_fit)
mxEval(ACE.stes, IPM_allvar_fit)
```

##### Common factors

Negative estimates for:
* C1 factors for *anxiety12(cc2)*, *psychosis12(cc5)* and *anxiety18(cc7)*
* E1 factors for *conduct18(ec9)* and *psychosis18(ec10)* 

Small estimates (0.05) for:
* C1 factors for *depression12(cc3)* and *depression18(cc8)* and *psychosis18(cc10)*
* E1 factors for *psychosis12(ec5)* and *anxiety18(ec7)* and *depression18(ec8)*

First, we will constrain the negative estimates to make sure the % contribution of ACE adds up to 100. Once constraining cc2, cc5, cc7, and ec10, we don't need to constrain ec9 for these %s to add up. 

```{r Common constrained submodel}
# create a "copy" of the model
IPM_allvar_sub1modelc <- mxModel(IPM_allvar_fit, name = "IPM_allvar_sub1c") 

# set parameters identified above to be zero
IPM_allvar_sub1modelc <- omxSetParameters(IPM_allvar_sub1modelc,
                                         labels = c("cc2", "cc5", "cc7"
                                                   ,"ec10"
                                                    ),
                                         free = FALSE, 
                                         values = 0)

IPM_allvar_sub1modelc <- omxAssignFirstParameters(IPM_allvar_sub1modelc)

# Run sunmodels
IPM_allvar_sub1modelc_fit <- mxTryHard(IPM_allvar_sub1modelc, intervals = FALSE)

# create summary
IPM_allvar_sub1modelc_sum <- summary(IPM_allvar_sub1modelc_fit)

# compare to original model   
mxCompare(IPM_allvar_fit, IPM_allvar_sub1modelc_fit)
```

```{r results from IPM_allvar_sub1models_fit}
IPM_esitmates_ACE_10var_noCI(data = IPM_allvar_sub1modelc_fit,
                  variable1 = "Isolation12",
                  variable2 = "Anxiety12",
                  variable3 = "Depression12",
                  variable4 = "Conduct12",
                  variable5 = "Psychosis12",
                  variable6 = "Isolation18",
                  variable7 = "Anxiety18",
                  variable8 = "Depression18",
                  variable9 = "Conduct18",
                  variable10 = "Psychosis18",
                  model = "ACE",
                  uniACEestimates = TRUE,
                  pathestimates = TRUE,
                  A_percent = TRUE,
                  C_percent = TRUE,
                  E_percent = TRUE,
                  common_factor_contribution = TRUE)
```

So these all now add up to 100, which is great. We can interpret the paths that have been set to zero - as these paths were very close to 0 anyway. Now we can check if we can constrain the very small estimates - we need to re-check the standardsied unsquared estimates. 

```{r recheck the standardised estimates}
# common unsquared parameters
mxEval(ACE.stac, IPM_allvar_sub1modelc_fit)
mxEval(ACE.stcc, IPM_allvar_sub1modelc_fit)
mxEval(ACE.stec, IPM_allvar_sub1modelc_fit)
```

The following have small estimates (0.05):
* C factors *isolation18(cc16)*
* E factors *psychosis12(ec5)* and *anxiety18(ec7)* and *depression18(ec8)* and *conduct18(ec9)*

```{r Common constrained submodel}
# create a "copy" of the model
IPM_allvar_sub2modelc <- mxModel(IPM_allvar_sub1modelc_fit, name = "IPM_allvar_sub2c") 

# set parameters identified above to be zero
IPM_allvar_sub2modelc <- omxSetParameters(IPM_allvar_sub2modelc,
                                         labels = c("cc16", 
                                                    "ec5", "ec7", "ec8", "ec9" 
                                                    ),
                                         free = FALSE, 
                                         values = 0)

IPM_allvar_sub2modelc <- omxAssignFirstParameters(IPM_allvar_sub2modelc)

# Run sunmodels
IPM_allvar_sub2modelc_fit <- mxTryHard(IPM_allvar_sub2modelc, intervals = FALSE)

# create summary
IPM_allvar_sub2modelc_sum <- summary(IPM_allvar_sub2modelc_fit)

# compare to original model   
mxCompare(IPM_allvar_fit, IPM_allvar_sub2modelc_fit)
```

```{r results from IPM_allvar_sub1models_fit}
IPM_esitmates_ACE_10var_noCI(data = IPM_allvar_sub2modelc_fit,
                  variable1 = "Isolation12",
                  variable2 = "Anxiety12",
                  variable3 = "Depression12",
                  variable4 = "Conduct12",
                  variable5 = "Psychosis12",
                  variable6 = "Isolation18",
                  variable7 = "Anxiety18",
                  variable8 = "Depression18",
                  variable9 = "Conduct18",
                  variable10 = "Psychosis18",
                  model = "ACE",
                  uniACEestimates = TRUE,
                  pathestimates = TRUE,
                  A_percent = TRUE,
                  C_percent = TRUE,
                  E_percent = TRUE,
                  common_factor_contribution = TRUE)
```

```{r check for negative estimatess}
mxEval(ACE.stac, IPM_allvar_sub2modelc_fit)
mxEval(ACE.stcc, IPM_allvar_sub2modelc_fit)
mxEval(ACE.stec, IPM_allvar_sub2modelc_fit)
```

*isolation18(ec6)* is now ~0.05 so we will constrain this to be 0 too - this model will be IPM_allvar_sub3modelc. 

```{r Common constrained submodel}
# create a "copy" of the model
IPM_allvar_sub3modelc <- mxModel(IPM_allvar_sub2modelc_fit, name = "IPM_allvar_sub3c") 

# set parameters identified above to be zero
IPM_allvar_sub3modelc <- omxSetParameters(IPM_allvar_sub3modelc,
                                         labels = c("ec6"
                                                    ),
                                         free = FALSE, 
                                         values = 0)

IPM_allvar_sub3modelc <- omxAssignFirstParameters(IPM_allvar_sub3modelc)

# Run sunmodels
IPM_allvar_sub3modelc_fit <- mxTryHard(IPM_allvar_sub3modelc, intervals = FALSE)

# create summary
IPM_allvar_sub3modelc_sum <- summary(IPM_allvar_sub3modelc_fit)

# compare to original model   
mxCompare(IPM_allvar_fit, IPM_allvar_sub3modelc_fit)
```

```{r results from IPM_allvar_sub1models_fit}
IPM_esitmates_ACE_10var_noCI(data = IPM_allvar_sub3modelc_fit,
                  variable1 = "Isolation12",
                  variable2 = "Anxiety12",
                  variable3 = "Depression12",
                  variable4 = "Conduct12",
                  variable5 = "Psychosis12",
                  variable6 = "Isolation18",
                  variable7 = "Anxiety18",
                  variable8 = "Depression18",
                  variable9 = "Conduct18",
                  variable10 = "Psychosis18",
                  model = "ACE",
                  uniACEestimates = TRUE,
                  pathestimates = TRUE,
                  A_percent = TRUE,
                  C_percent = TRUE,
                  E_percent = TRUE,
                  common_factor_contribution = TRUE)
```

```{r check for negative estimatess}
mxEval(ACE.stac, IPM_allvar_sub3modelc_fit)
mxEval(ACE.stcc, IPM_allvar_sub3modelc_fit)
mxEval(ACE.stec, IPM_allvar_sub3modelc_fit)
```

Based on this - IPM_allvar_sub3modelc_fit is the model to take forward. 

##### Specific factors

Now we will check the standardised specific paths to see which we need to constrain to be 0. We will constrain those that are very small in the stas/stcs/stes output. 

The standardised path coefficients (stac) are factor loadings, and in order to get this to a variance, we need to square it. When we have standardised and squared paths, we can add up each ACE contribution .

```{r checknegative variances for common and specific paths}
# specific unsquared parameters
mxEval(ACE.stas, IPM_allvar_fit)
mxEval(ACE.stcs, IPM_allvar_fit)
mxEval(ACE.stes, IPM_allvar_fit)
```

For the specific factors, we will be slightly more conservative in what we drop - as these make up all individual contributions to each construct - using the threshold of ~0.001. We also dont want to drop any specific E parameters as this includes measurement error. 

* A factors for *depression12 (as3)*, *depression18 (as8)*, and *conduct18 (as9)* 
* C factors for *isolation12 (cs1)*, *isolation18 (es6)*, *anxiety18 (cs7)*, *depression18 (cs8)*, *conduct18 (cs9)*, and *psychosis18 (cs10)*

We will first compare to the full model IPM_allvar_fit and then as a second step compare it to the chosen Common submodel. 

```{r specific constrained submodel}
# create a "copy" of the model
IPM_allvar_sub1models <- mxModel(IPM_allvar_fit, name = "IPM_allvar_sub1s")

# set parameters identified above to be zero
IPM_allvar_sub1models <- omxSetParameters(IPM_allvar_sub1models,
                                         labels = c("as3", "as8", "as9", 
                                                    "cs1", "cs6", "cs7", "cs8", "cs9", "cs10"), 
                                         free = FALSE, 
                                         values = 0)

# not sure what this does ? Ask Kunle
IPM_allvar_sub1models    <- omxAssignFirstParameters(IPM_allvar_sub1models)

# Run sunmodels
IPM_allvar_sub1models_fit <- mxTryHard(IPM_allvar_sub1models, intervals = FALSE)

# create summary
IPM_allvar_sub1models_sum <- summary(IPM_allvar_sub1models_fit)

# compare to original model      
mxCompare(IPM_allvar_fit, IPM_allvar_sub1models_fit)

# check
IPM_allvar_sub1models_fit$ACE$stas
```

```{r results from IPM_allvar_sub1models_fit}
IPM_esitmates_ACE_10var_noCI(data = IPM_allvar_sub1models_fit,
                  variable1 = "Isolation12",
                  variable2 = "Anxiety12",
                  variable3 = "Depression12",
                  variable4 = "Conduct12",
                  variable5 = "Psychosis12",
                  variable6 = "Isolation18",
                  variable7 = "Anxiety18",
                  variable8 = "Depression18",
                  variable9 = "Conduct18",
                  variable10 = "Psychosis18",
                  model = "ACE",
                  uniACEestimates = TRUE,
                  pathestimates = TRUE,
                  A_percent = TRUE,
                  C_percent = TRUE,
                  E_percent = TRUE,
                  common_factor_contribution = TRUE)
```

```{r checknegative variances for common and specific paths}
# specific unsquared parameters
mxEval(ACE.stas, IPM_allvar_sub1models_fit)
mxEval(ACE.stcs, IPM_allvar_sub1models_fit)
mxEval(ACE.stes, IPM_allvar_sub1models_fit)
```

This had a p values of very close to 1, so now we will add in the common constraints to get the best fitting submodel constraining both common and specific paths. *Note - there are still negative estimates in here - need to decide if this is a problem?*

##### Common and specific

Full list of common and specific paths constrained:

* Common C1 factors for *anxiety12(cc2)*, *psychosis12(cc5)*, *anxiety18(cc7)* and *isolation18(cc16)*
* Common E1 factors for *psychosis12(ec5)*, *isolation18(ec6)*, *anxiety18(ec7)*, *depression18(ec8)*, *conduct18(ec9)* and *psychosis18(ec10)* 
* Specific A factors for *depression12 (as3)*, *depression18 (as8)*, and *conduct18 (as9)* 
* Specific C factors for *isolation12 (cs1)*, *isolation18 (es6)*, *anxiety18 (cs7)*, *depression18 (cs8)*, *conduct18 (cs9)*, and *psychosis18 (cs10)*

```{r common and specific constrained submodel}
# create a "copy" of the model
IPM_allvar_submodel <- mxModel(IPM_allvar_fit, name = "IPM_allvar_sub")

# set parameters identified above to be zero
IPM_allvar_submodel <- omxSetParameters(IPM_allvar_submodel,
                                         labels = c(# common
                                                    "cc2", "cc5", "cc7", "cc16",  
                                                    "ec5", "ec6", "ec7", "ec8", "ec9", "ec10",
                                                    # specific
                                                    "as3", "as8", "as9", 
                                                    "cs1", "cs6", "cs7", "cs8", "cs9", "cs10"), 
                                         free = FALSE, 
                                         values = 0)

# assigns the same starting values
IPM_allvar_submodel   <- omxAssignFirstParameters(IPM_allvar_submodel)

# Run submodels
IPM_allvar_submodel_fit <- mxTryHard(IPM_allvar_submodel, intervals = FALSE)

# create summary
IPM_allvar_submodel_sum <- summary(IPM_allvar_submodel_fit)

# compare to original model      
mxCompare(IPM_allvar_fit, IPM_allvar_submodel_fit)
```

```{r results from IPM_allvar_sub1models_fit}
IPM_esitmates_ACE_10var_noCI(data = IPM_allvar_submodel_fit,
                  variable1 = "Isolation12",
                  variable2 = "Anxiety12",
                  variable3 = "Depression12",
                  variable4 = "Conduct12",
                  variable5 = "Psychosis12",
                  variable6 = "Isolation18",
                  variable7 = "Anxiety18",
                  variable8 = "Depression18",
                  variable9 = "Conduct18",
                  variable10 = "Psychosis18",
                  model = "ACE",
                  uniACEestimates = TRUE,
                  pathestimates = TRUE,
                  A_percent = TRUE,
                  C_percent = TRUE,
                  E_percent = TRUE,
                  common_factor_contribution = TRUE)
```


## Sex differences - IN PROGRESS

The following variables had quantitative sex differences:

* Social isolation age 12
* Anxiety age 18
* Depression age 18
* Conduct disorder age 12
* Psychosis age 12
* Psychosis age 18

### ACE - separate means

* The `Scalar` correction is `TRUE` only for the variables that need sex correction. This is based on variables that have quantitative or scalar sex differences (differences in proportions of ACE influences across sex).The scalar multiplier controls for the difference in total variance between males and females. 
* mxBounds() creates bounds for the objects, so that the estimates do not go below 0. 

#### Specify

```{r ACE model for IPM_allvar_sexmean}
IPM_allvar_sexmean <- mxModel("IPM_allvar_sexmean",
	mxModel("ACE",
    # Common ace paths
    mxMatrix("Full", nrow = nv, ncol = nfAc, free = Ac2Free, labels = aclab, values = Ac2Values, name = "ac"),
    mxMatrix("Full", nrow = nv, ncol = nfAc, free = Ac2Free, labels = cclab, values = Cc2Values, name = "cc"),
    mxMatrix("Full", nrow = nv, ncol = nfAc, free = Ac2Free, labels = eclab, values = Ec2Values, name = "ec"),

    # Specific ace paths
    mxMatrix("Diag", nrow = nv, ncol = nv, free = TRUE, labels = aslab, values = 0.6,  name = "as"),
    mxMatrix("Diag", nrow = nv, ncol = nv, free = TRUE, labels = cslab, values = 0.01, name = "cs"),
    mxMatrix("Diag", nrow = nv, ncol = nv, free = TRUE, labels = eslab, values = 0.6,  name = "es"),

		# ACE variance components
    mxAlgebra(ac %*% t(ac) + as %*% t(as), name = "A"),
    mxAlgebra(cc %*% t(cc) + cs %*% t(cs), name = "C"),
    mxAlgebra(ec %*% t(ec) + es %*% t(es), name = "E"),
    mxAlgebra(A + C + E, name = "V"),

		# Calculate standard deviation for standardization
    mxMatrix("Iden", nrow = nv, ncol = nv, name = "I"),
    mxAlgebra(solve(sqrt(I*V)), name = "iSD"), # extracting the variances from the diagonal of the covariance matrix V

		# Expected means vector
    mxMatrix("Full", nrow = 1, ncol = nv, free = TRUE, values = 0.01, name = "MeanM"), # mean for males
    mxAlgebra(cbind(MeanM, MeanM), name = "expMeanM"),

    mxMatrix("Full", nrow = 1, ncol = nv, free = TRUE, values = 0.01, name = "MeanF"), # mean for females
    mxAlgebra(cbind(MeanF,MeanF), name = "expMeanF"),

    # Genetic and environmental correlations (correlated factor solution)
    mxAlgebra(solve(sqrt(I*V)) %&% V, name = "Rph"),
    mxAlgebra(solve(sqrt(I*A)) %&% A, name = "Ra"),
    mxAlgebra(solve(sqrt(I*C)) %&% C, name = "Rc"),
    mxAlgebra(solve(sqrt(I*E)) %&% E, name = "Re"),

    # Standardised components of variance
    mxAlgebra(A/V, name = "h2"),
    mxAlgebra(C/V, name = "c2"),
    mxAlgebra(E/V, name = "e2"),

    # Standardise common parameters (unsquared)
    mxAlgebra(iSD %*% ac, name = "stac"),
    mxAlgebra(iSD %*% cc, name = "stcc"),
    mxAlgebra(iSD %*% ec, name = "stec"),

    # Standardise common parameters (Squared)
    mxAlgebra(stac*stac, name = "stac2"),
    mxAlgebra(stcc*stcc, name = "stcc2"),
    mxAlgebra(stec*stec, name = "stec2"),

    # Standardise specific parameters (unsquared)
    mxAlgebra(iSD %*% as, name = "stas"),
    mxAlgebra(iSD %*% cs, name = "stcs"),
    mxAlgebra(iSD %*% es, name = "stes"),

    # Standardise specific parameters (Squared)
    mxAlgebra(stas*stas, name = "stas2"),
    mxAlgebra(stcs*stcs, name = "stcs2"),
    mxAlgebra(stes*stes, name = "stes2"),

    # Scalar multiplier 
    mxMatrix("Diag", nrow = ntv, ncol = ntv, free = c( T, F, F, T, T, F, T, T, F, T,   # True for isolation12 conduct12, psychosis12, anxiety18, depression18, and psychosis18. 
                                                       T, F, F, T, T, F, T, T, F, T),
             values = 1,
             label  = c("sc1", "sc2", "sc3", "sc4", "sc5", "sc6", "sc7","sc8", "sc9", "sc10", 
                        "sc1", "sc2", "sc3", "sc4", "sc5", "sc6", "sc7","sc8", "sc9", "sc10"),
             name   = "Scalar"),

    mxBounds(c("sc1", "sc4", "sc5", "sc7", "sc8", "sc10"), 0, NA), # creates bounds for these objects when = TRUE

		# MZ expected covariance matrix
		mxAlgebra(Scalar %&% rbind(cbind(A+C+E, A+C), cbind(A+C, A+C+E)), name = "expCovMZm"), 
		mxAlgebra(rbind(cbind(A+C+E, A+C), cbind(A+C, A+C+E)), name = "expCovMZf"),

		# DZ expected covariance matrix
		mxAlgebra(Scalar %&% rbind(cbind(A+C+E, (0.5%x%A)+C), cbind((0.5%x%A)+C, A+C+E)), name = "expCovDZm"), 
		mxAlgebra(rbind(cbind(A+C+E, (0.5%x%A)+C), cbind((0.5%x%A)+C, A+C+E)), name = "expCovDZf")

	),

	mxModel("MZM",
		mxData(observed = dat.twin.MZm, type = "raw"),
		mxExpectationNormal(covariance = "ACE.expCovMZm", means = "ACE.expMeanM", dimnames = selvars_norm_reg),
		mxFitFunctionML()
	),
	mxModel("MZF",
		mxData(observed = dat.twin.MZf, type = "raw"),
		mxExpectationNormal(covariance = "ACE.expCovMZf", means = "ACE.expMeanF", dimnames = selvars_norm_reg),
		mxFitFunctionML()
	),
	mxModel("DZM",
		mxData(observed = dat.twin.DZm, type = "raw"),
		mxExpectationNormal(covariance = "ACE.expCovDZm", means = "ACE.expMeanM", dimnames = selvars_norm_reg),
		mxFitFunctionML()
	),
	mxModel("DZF",
		mxData(observed = dat.twin.DZf, type = "raw"),
		mxExpectationNormal(covariance = "ACE.expCovDZf", means = "ACE.expMeanF", dimnames = selvars_norm_reg),
		mxFitFunctionML()
	),

	mxAlgebra(MZM.objective + DZM.objective + MZF.objective + DZF.objective, name = "m2LL"),
	mxFitFunctionAlgebra("m2LL"),
	mxCI(c("ACE.stac2",
	       "ACE.stcc2",
	       "ACE.stec2",
	       "ACE.stas2",
	       "ACE.stcs2",
	       "ACE.stes2",
	       "ACE.Rph",
	       "ACE.h2",
	       "ACE.c2",
	       "ACE.e2"))
)
```

```{r run ACE mdoel for psychosis}
IPM_allvar_sexmean_fit <- mxTryHard(IPM_allvar_sexmean, intervals = FALSE)
summary(IPM_allvar_sexmean_fit, verbose = TRUE)
```

#### Output

```{r output for IPM_allvar_sexmean_fit}
IPM_esitmates_ACE_10var_noCI(data = IPM_allvar_sexmean_fit,
                  variable1 = "Isolation12",
                  variable2 = "Anxiety12",
                  variable3 = "Depression12",
                  variable4 = "Conduct12",
                  variable5 = "Psychosis12",
                  variable6 = "Isolation18",
                  variable7 = "Anxiety18",
                  variable8 = "Depression18",
                  variable9 = "Conduct18",
                  variable10 = "Psychosis18",
                  model = "ACE",
                  uniACEestimates = TRUE,
                  pathestimates = TRUE,
                  A_percent = TRUE,
                  C_percent = TRUE,
                  E_percent = TRUE,
                  common_factor_contribution = TRUE)


```

Same as when we were not accounting for sex differences, we need to check for negative loadings on the common paths and very small loadings for both common and specific paths. 

```{r check for negative loadings}
# common unsquared parameters
mxEval(ACE.stac, IPM_allvar_sexmean_fit)
mxEval(ACE.stcc, IPM_allvar_sexmean_fit)
mxEval(ACE.stec, IPM_allvar_sexmean_fit)

# specific unsquared parameters
mxEval(ACE.stas, IPM_allvar_sexmean_fit)
mxEval(ACE.stcs, IPM_allvar_sexmean_fit)
mxEval(ACE.stes, IPM_allvar_sexmean_fit)
```

#### Submodels - update with specific

##### Common factors

For the common factors there are negative stac/stcc/stec estimates coming from:
* C1 factors for *anxiety12(cc2)*, *psychosis12(cc5)* and *anxiety18(cc7)*
* E1 factors for *psychosis18(ec10)*

```{r Common constrained submodel}
# create a "copy" of the model
IPM_allvar_sexmean_sub1modelc <- mxModel(IPM_allvar_sexmean_fit, name = "IPM_allvar_sexmean_sub1c") 

# set parameters identified above to be zero
IPM_allvar_sexmean_sub1modelc <- omxSetParameters(IPM_allvar_sexmean_sub1modelc,
                                         labels = c("cc2", "cc5", "cc7",
                                                    "ec10"
                                                    ),
                                         free = FALSE, 
                                         values = 0)

IPM_allvar_sexmean_sub1modelc <- omxAssignFirstParameters(IPM_allvar_sexmean_sub1modelc)

# Run sunmodels
IPM_allvar_sexmean_sub1modelc_fit <- mxTryHard(IPM_allvar_sexmean_sub1modelc, intervals = FALSE)

# create summary
IPM_allvar_sexmean_sub1modelc_sum <- summary(IPM_allvar_sexmean_sub1modelc_fit)

# compare to original model   
mxCompare(IPM_allvar_sexmean_fit, IPM_allvar_sexmean_sub1modelc_fit)
```
```{r results from IPM_allvar_sub1models_fit}
IPM_esitmates_ACE_10var_noCI(data = IPM_allvar_sexmean_sub1modelc_fit,
                  variable1 = "Isolation12",
                  variable2 = "Anxiety12",
                  variable3 = "Depression12",
                  variable4 = "Conduct12",
                  variable5 = "Psychosis12",
                  variable6 = "Isolation18",
                  variable7 = "Anxiety18",
                  variable8 = "Depression18",
                  variable9 = "Conduct18",
                  variable10 = "Psychosis18",
                  model = "ACE",
                  uniACEestimates = TRUE,
                  pathestimates = TRUE,
                  A_percent = TRUE,
                  C_percent = TRUE,
                  E_percent = TRUE,
                  common_factor_contribution = TRUE)
```

*Here we really benefit by not constraining any E parameters - just C, will be interesting to see if we remove anxiety and include sex differences, do we need to constrain any parameters at all?*

```{r check}
# common unsquared parameters
mxEval(ACE.stac, IPM_allvar_sexmean_sub1modelc_fit)
mxEval(ACE.stcc, IPM_allvar_sexmean_sub1modelc_fit)
mxEval(ACE.stec, IPM_allvar_sexmean_sub1modelc_fit)

mxEval(ACE.stas, IPM_allvar_sexmean_sub1modelc_fit)
mxEval(ACE.stcs, IPM_allvar_sexmean_sub1modelc_fit)
mxEval(ACE.stes, IPM_allvar_sexmean_sub1modelc_fit)
```

##### Specific factors

For the specific factors there are negative stac/stcc/stec estimates coming from:
* A factors for *depression12(as2)*, *psychosis12(as5)*, *depression18(as8)*, and *conduct18(as9)*
* C factors for *isolation12(cs1)*, *conduct12(cs4)*, *isolation18(cs6)*, *anxiety18(cs7)*, *dperession18(cs8)*, *conduct18(cs9)* and *psychosis18(cs10)*

```{r Common constrained submodel}
# create a "copy" of the model
IPM_allvar_sexmean_sub2model <- mxModel(IPM_allvar_sexmean_fit, name = "IPM_allvar_sexmean_sub2") 

# set parameters identified above to be zero
IPM_allvar_sexmean_sub2model <- omxSetParameters(IPM_allvar_sexmean_sub2model,
                                         labels = c("cc2", "cc5", "cc7",
                                                    "ec10",
                                                    "as3", "as5", "as8", "as9",
                                                    "cs1", "cs4", "cs6", "cs7", "cs8", "cs9", "cs10" 
                                                    ),
                                         free = FALSE, 
                                         values = 0)

IPM_allvar_sexmean_sub2model <- omxAssignFirstParameters(IPM_allvar_sexmean_sub2model)

# Run sunmodels
IPM_allvar_sexmean_sub2model_fit <- mxTryHard(IPM_allvar_sexmean_sub2model, intervals = FALSE)

# create summary
IPM_allvar_sexmean_sub2model_sum <- summary(IPM_allvar_sexmean_sub2model_fit)

# compare to original model   
mxCompare(IPM_allvar_sexmean_fit, IPM_allvar_sexmean_sub2model_fit)
```

```{r results from IPM_allvar_sub2model_fit}
IPM_esitmates_ACE_10var_noCI(data = IPM_allvar_sexmean_sub2model_fit,
                  variable1 = "Isolation12",
                  variable2 = "Anxiety12",
                  variable3 = "Depression12",
                  variable4 = "Conduct12",
                  variable5 = "Psychosis12",
                  variable6 = "Isolation18",
                  variable7 = "Anxiety18",
                  variable8 = "Depression18",
                  variable9 = "Conduct18",
                  variable10 = "Psychosis18",
                  model = "ACE",
                  uniACEestimates = TRUE,
                  pathestimates = TRUE,
                  A_percent = TRUE,
                  C_percent = TRUE,
                  E_percent = TRUE,
                  common_factor_contribution = TRUE)
```

```{r check}
# common unsquared parameters
mxEval(ACE.stac, IPM_allvar_sexmean_sub2model_fit)
mxEval(ACE.stcc, IPM_allvar_sexmean_sub2model_fit)
mxEval(ACE.stec, IPM_allvar_sexmean_sub2model_fit)

mxEval(ACE.stas, IPM_allvar_sexmean_sub2model_fit)
mxEval(ACE.stcs, IPM_allvar_sexmean_sub2model_fit)
mxEval(ACE.stes, IPM_allvar_sexmean_sub2model_fit)
```

Some of these are still negative - do we need to constrain these?

***

# All variables - w/o anxiety

This section will run a model with all variables apart from anxiety as it seemed to cause some problems with the "all_var" model. 

```{r number of variables (phenotypes)}
# number of variables
nv <- 8    					      # number of variables - 2 for each construct (2*4)
ntv <- nv*2 				      # number of twin variables
nlower <- nv*(nv+1)/2 		# number of free elements in an nv*nv lower matrix 

# number of common factors 
nfAc <- 2 # change dimension of A factor matrix Ac to have *2* common factors

# Set if the parameters are estimated (TRUE) or not (FALSE) 
Ac2Free   <- c(rep(TRUE, nv), rep(FALSE, nv/2), rep(TRUE, nv/2))  

# Create start values for 2 common ACE Factors - set the start values for common 
Ac2Values <- c(rep(.1, nv),  rep(0, nv/2), rep(.1, nv/2))  
Cc2Values <- c(rep(.1, nv),  rep(0, nv/2), rep(.1, nv/2))
Ec2Values <- c(rep(.1, nv),  rep(0, nv/2), rep(.1, nv/2))
```

```{r labels for IPM_allvar}
# labels for common paths
aclab_noanx <- c("ac1", "ac2", "ac3", "ac4", "ac5", "ac6", "ac7", "ac8", 
           "ac11", "ac12", "ac13", "ac14", "ac15", "ac16", "ac17", "ac18")
cclab_noanx <- c("cc1", "cc2", "cc3", "cc4", "cc5", "cc6", "cc7", "cc8", 
           "cc11", "cc12", "cc13", "cc14", "cc15", "cc16", "cc17", "cc18")
eclab_noanx <- c("ec1", "ec2", "ec3", "ec4", "ec5", "ec6", "ec7", "ec8",  
           "ec11", "ec12", "ec13", "ec14", "ec15", "ec16", "ec17", "ec18")

# labels for specific paths
aslab_noanx <- c("as1", "as2", "as3", "as4", "as5", "as6", "as7", "as8")
cslab_noanx <- c("cs1", "cs2", "cs3", "cs4", "cs5", "cs6", "cs7", "cs8")
eslab_noanx <- c("es1", "es2", "es3", "es4", "es5", "es6", "es7", "es8")
```

## No sex differences

### ACE

#### Specify

```{r ACE model for IPM_allvar_noanx}
IPM_allvar_noanx <- mxModel("IPM_allvar_noanx",
	mxModel("ACE",
    # Common ace paths
    mxMatrix("Full", nrow = nv, ncol = nfAc, free = Ac2Free, labels = aclab_noanx, values = Ac2Values, name = "ac"),
    mxMatrix("Full", nrow = nv, ncol = nfAc, free = Ac2Free, labels = cclab_noanx, values = Cc2Values, name = "cc"),
    mxMatrix("Full", nrow = nv, ncol = nfAc, free = Ac2Free, labels = eclab_noanx, values = Ec2Values, name = "ec"),
    		
    # Specific ace paths
    mxMatrix("Diag", nrow = nv, ncol = nv, free = TRUE, labels = aslab_noanx, values = 0.6,  name = "as"),
    mxMatrix("Diag", nrow = nv, ncol = nv, free = TRUE, labels = cslab_noanx, values = 0.01, name = "cs"),
    mxMatrix("Diag", nrow = nv, ncol = nv, free = TRUE, labels = eslab_noanx, values = 0.6,  name = "es"),
		
		# ACE variance components
    mxAlgebra(ac %*% t(ac) + as %*% t(as), name = "A"), 
    mxAlgebra(cc %*% t(cc) + cs %*% t(cs), name = "C"),
    mxAlgebra(ec %*% t(ec) + es %*% t(es), name = "E"),
    mxAlgebra(A + C + E, name = "V"),
		
		# Calculate standard deviation for standardization
    mxMatrix("Iden", nrow = nv, ncol = nv, name = "I"),
    mxAlgebra(solve(sqrt(I*V)), name = "iSD"), # extracting the variances from the diagonal of the covariance matrix V 
		
		# Expected means vector
    mxMatrix("Full", nrow = 1, ncol = ntv, free = TRUE, values = 0.01, name = "expMean"), 

    # Genetic and environmental correlations (correlated factor solution)
    mxAlgebra(solve(sqrt(I*V)) %&% V, name = "Rph"),
    mxAlgebra(solve(sqrt(I*A)) %&% A, name = "Ra"),
    mxAlgebra(solve(sqrt(I*C)) %&% C, name = "Rc"),
    mxAlgebra(solve(sqrt(I*E)) %&% E, name = "Re"),

    # Standardised components of variance
    mxAlgebra(A/V, name = "h2"),
    mxAlgebra(C/V, name = "c2"),
    mxAlgebra(E/V, name = "e2"),
    
    # Standardise common parameters (unsquared)
    mxAlgebra(iSD %*% ac, name = "stac"),
    mxAlgebra(iSD %*% cc, name = "stcc"),
    mxAlgebra(iSD %*% ec, name = "stec"),
    
    # Standardise common parameters (Squared)
    mxAlgebra(stac*stac, name = "stac2"),
    mxAlgebra(stcc*stcc, name = "stcc2"),
    mxAlgebra(stec*stec, name = "stec2"),
    
    # Standardise specific parameters (unsquared)
    mxAlgebra(iSD %*% as, name = "stas"),
    mxAlgebra(iSD %*% cs, name = "stcs"),
    mxAlgebra(iSD %*% es, name = "stes"),
    
    # Standardise specific parameters (Squared)
    mxAlgebra(stas*stas, name = "stas2"),
    mxAlgebra(stcs*stcs, name = "stcs2"),
    mxAlgebra(stes*stes, name = "stes2"),	
	
		# MZ expected covariance matrix
		mxAlgebra(rbind(cbind(A+C+E, A+C), cbind(A+C, A+C+E)), name = "expCovMZ"),
		
		# DZ expected covariance matrix
		mxAlgebra(rbind(cbind(A+C+E, (0.5%x%A)+C), cbind((0.5%x%A)+C, A+C+E)), name = "expCovDZ")
		
	),
	
	mxModel("MZ",
		mxData(observed = dat.twin.MZ, type = "raw"),
		mxExpectationNormal(covariance = "ACE.expCovMZ", means = "ACE.expMean", dimnames = selvars_noanx_norm_reg),
		mxFitFunctionML()
	),
	mxModel("DZ",
		mxData(observed = dat.twin.DZ, type = "raw"),
		mxExpectationNormal(covariance = "ACE.expCovDZ", means = "ACE.expMean", dimnames = selvars_noanx_norm_reg),
		mxFitFunctionML()
	),

	mxAlgebra(MZ.objective + DZ.objective, name = "m2LL"),
	mxFitFunctionAlgebra("m2LL"),
	mxCI(c("ACE.stac2", "ACE.stcc2", "ACE.stec2", "ACE.stas2", "ACE.stcs2", "ACE.stes2", "ACE.Rph"))
)
```

```{r run ACE mdoel for anxiety}
IPM_allvar_noanx_fit <- mxTryHard(IPM_allvar_noanx, intervals = TRUE)
summary(IPM_allvar_noanx_fit)
```

#### Output 

```{r output for IPM_allvar_nopsy_fit}
IPM_esitmates_ACE_8var(data = IPM_allvar_noanx_fit,
                  variable1 = "Isolation12",
                  variable2 = "Depression12",
                  variable3 = "Conduct12",
                  variable4 = "Psychosis12",
                  variable5 = "Isolation18",
                  variable6 = "Depression18",
                  variable7 = "Conduct18",
                  variable8 = "Psychosis18",
                  model = "ACE",
                  uniACEestimates = TRUE,
                  pathestimates = TRUE,
                  A_percent = TRUE,
                  C_percent = TRUE,
                  E_percent = TRUE,
                  common_factor_contribution = TRUE)
```

Univariate heritabilities:
Isolation 12     0.419
Anxiety 12       0.272
Depression 12    0.211
Conduct 12       0.197
Isolation 18     0.450
Anxiety 18       0.235
Depression 18    0.315
Conduct 18       0.195


#### Submodels

```{r check for negative loadings}
# common unsquared parameters
mxEval(ACE.stac, IPM_allvar_noanx_fit)
mxEval(ACE.stcc, IPM_allvar_noanx_fit)
mxEval(ACE.stec, IPM_allvar_noanx_fit)

# specific unsquared parameters
mxEval(ACE.stas, IPM_allvar_noanx_fit)
mxEval(ACE.stcs, IPM_allvar_noanx_fit)
mxEval(ACE.stes, IPM_allvar_noanx_fit)
```

Without anxiety, small/negative common loadings (<0.05) are:
* A1 factors of *conduct18(ac7)* - also non-sig (according to 5 decimal places)
* A2 factors of *isolation18(ac15)* - also non-sig
* C1 factors of *psychosis18(cc4)* - also non-sig

Without anxiety, small specific loadings are:
* A factors of *depression12(as2)*, *depression18(as6)* - also non-sig
* C factors of *isolation12(cs1)*, *conduct12(cs3)*, *isolation18(cs5)*, *depression18(cs6)*, *conduct18(cs7)*, *psychosis18(cs8)* - also non-sig

We will constrain each of these one at a time. 

##### Common factors

Common factor a7 has a negative factor loading. 

```{r Common constrained submodel}
# create a "copy" of the model
IPM_allvar_noanx_sub1modelc <- mxModel(IPM_allvar_noanx_fit, name = "IPM_allvar_noanx_sub1c") 

# set parameters identified above to be zero
IPM_allvar_noanx_sub1modelc <- omxSetParameters(IPM_allvar_noanx_sub1modelc,
                                         labels = c("ac7"
                                                    ),
                                         free = FALSE, 
                                         values = 0)

IPM_allvar_noanx_sub1modelc <- omxAssignFirstParameters(IPM_allvar_noanx_sub1modelc)

# Run sunmodels
IPM_allvar_noanx_sub1modelc_fit <- mxTryHard(IPM_allvar_noanx_sub1modelc, intervals = FALSE)

# create summary
IPM_allvar_noanx_sub1modelc_sum <- summary(IPM_allvar_noanx_sub1modelc_fit)

# compare to original model   
mxCompare(IPM_allvar_noanx_fit, IPM_allvar_noanx_sub1modelc_fit)
```

```{r results from IPM_allvar_sub1models_fit}
# common unsquared parameters
mxEval(ACE.stac, IPM_allvar_noanx_sub1modelc_fit)
mxEval(ACE.stcc, IPM_allvar_noanx_sub1modelc_fit)
mxEval(ACE.stec, IPM_allvar_noanx_sub1modelc_fit)

# specific unsquared parameters
mxEval(ACE.stas, IPM_allvar_noanx_sub1modelc_fit)
mxEval(ACE.stcs, IPM_allvar_noanx_sub1modelc_fit)
mxEval(ACE.stes, IPM_allvar_noanx_sub1modelc_fit)
```

To constrain:
* A1 factors of *conduct18(ac7)* - constrained
* A2 factors of *isolation18(ac15)* 
* C1 factors of *psychosis18(cc4)* 
* A factors of *depression12(as2)*, *depression18(as6)*
* C factors of *isolation12(cs1)*, *conduct12(cs3)*, *isolation18(cs5)*, *depression18(cs6)*, *conduct18(cs7)*, *psychosis18(cs8)*
 
```{r Common constrained submodel}
# create a "copy" of the model
IPM_allvar_noanx_sub2modelc <- mxModel(IPM_allvar_noanx_fit, name = "IPM_allvar_noanx_sub2c") 

# set parameters identified above to be zero
IPM_allvar_noanx_sub2modelc <- omxSetParameters(IPM_allvar_noanx_sub2modelc,
                                         labels = c("ac7", 
                                                    "ac15"
                                                    ),
                                         free = FALSE, 
                                         values = 0)

IPM_allvar_noanx_sub2modelc <- omxAssignFirstParameters(IPM_allvar_noanx_sub2modelc)

# Run sunmodels
IPM_allvar_noanx_sub2modelc_fit <- mxTryHard(IPM_allvar_noanx_sub2modelc, intervals = FALSE)

# create summary
IPM_allvar_noanx_sub2modelc_sum <- summary(IPM_allvar_noanx_sub2modelc_fit)

# compare to original model   
mxCompare(IPM_allvar_noanx_fit, IPM_allvar_noanx_sub2modelc_fit)
```

```{r results from IPM_allvar_sub1models_fit}
# common unsquared parameters
mxEval(ACE.stac, IPM_allvar_noanx_sub2modelc_fit)
mxEval(ACE.stcc, IPM_allvar_noanx_sub2modelc_fit)
mxEval(ACE.stec, IPM_allvar_noanx_sub2modelc_fit)

# specific unsquared parameters
mxEval(ACE.stas, IPM_allvar_noanx_sub2modelc_fit)
mxEval(ACE.stcs, IPM_allvar_noanx_sub2modelc_fit)
mxEval(ACE.stes, IPM_allvar_noanx_sub2modelc_fit)
```

To constrain:
* A1 factors of *conduct18(ac7)* - constrained
* A2 factors of *isolation18(ac15)* - constrained
* C1 factors of *psychosis18(cc4)* 
* A factors of *depression12(as2)*, *depression18(as6)*
* C factors of *isolation12(cs1)*, *conduct12(cs3)*, *isolation18(cs5)*, *depression18(cs6)*, *conduct18(cs7)*, *psychosis18(cs8)*

```{r Common constrained submodel}
# create a "copy" of the model
IPM_allvar_noanx_sub3modelc <- mxModel(IPM_allvar_noanx_fit, name = "IPM_allvar_noanx_sub3c") 

# set parameters identified above to be zero
IPM_allvar_noanx_sub3modelc <- omxSetParameters(IPM_allvar_noanx_sub3modelc,
                                         labels = c("ac7", 
                                                    "ac15",
                                                    "cc4"
                                                    ),
                                         free = FALSE, 
                                         values = 0)

IPM_allvar_noanx_sub3modelc <- omxAssignFirstParameters(IPM_allvar_noanx_sub3modelc)

# Run sunmodels
IPM_allvar_noanx_sub3modelc_fit <- mxTryHard(IPM_allvar_noanx_sub3modelc, intervals = FALSE)

# create summary
IPM_allvar_noanx_sub3modelc_sum <- summary(IPM_allvar_noanx_sub3modelc_fit)

# compare to original model   
mxCompare(IPM_allvar_noanx_fit, IPM_allvar_noanx_sub3modelc_fit)
```


```{r results from IPM_allvar_sub1models_fit}
# common unsquared parameters
mxEval(ACE.stac, IPM_allvar_noanx_sub3modelc_fit)
mxEval(ACE.stcc, IPM_allvar_noanx_sub3modelc_fit)
mxEval(ACE.stec, IPM_allvar_noanx_sub3modelc_fit)

# specific unsquared parameters
mxEval(ACE.stas, IPM_allvar_noanx_sub3modelc_fit)
mxEval(ACE.stcs, IPM_allvar_noanx_sub3modelc_fit)
mxEval(ACE.stes, IPM_allvar_noanx_sub3modelc_fit)
```

##### Specific factors 

We will now constrain the specific factors only, before moving on to constrain both.

To constrain:
* A1 factors of *conduct18(ac7)* - constrained
* A2 factors of *isolation18(ac15)* - constrained
* C1 factors of *psychosis18(cc4)* - constrained
* A factors of *depression12(as2)*, *depression18(as6)*
* C factors of *isolation12(cs1)*, *conduct12(cs3)*, *isolation18(cs5)*, *depression18(cs6)*, *conduct18(cs7)*, *psychosis18(cs8)*

```{r specific constrained submodel}
# create a "copy" of the model
IPM_allvar_noanx_sub1models <- mxModel(IPM_allvar_noanx_fit, name = "IPM_allvar_noanx_sub1s")

# set parameters identified above to be zero
IPM_allvar_noanx_sub1models <- omxSetParameters(IPM_allvar_noanx_sub1models,
                                         labels = c("as2", "as6",
                                                    "cs1", "cs3", "cs5", "cs6", "cs7", "cs8"), 
                                         free = FALSE, 
                                         values = 0)

# not sure what this does ? Ask Kunle
IPM_allvar_noanx_sub1models    <- omxAssignFirstParameters(IPM_allvar_noanx_sub1models)

# Run sunmodels
IPM_allvar_noanx_sub1models_fit <- mxTryHard(IPM_allvar_noanx_sub1models, intervals = FALSE)

# create summary
IPM_allvar_noanx_sub1models_sum <- summary(IPM_allvar_noanx_sub1models_fit)

# compare to original model      
mxCompare(IPM_allvar_noanx_fit, IPM_allvar_noanx_sub1models_fit)
```

```{r results from IPM_allvar_sub1models_fit}
# common unsquared parameters
mxEval(ACE.stac, IPM_allvar_noanx_sub1models_fit)
mxEval(ACE.stcc, IPM_allvar_noanx_sub1models_fit)
mxEval(ACE.stec, IPM_allvar_noanx_sub1models_fit)

# specific unsquared parameters
mxEval(ACE.stas, IPM_allvar_noanx_sub1models_fit)
mxEval(ACE.stcs, IPM_allvar_noanx_sub1models_fit)
mxEval(ACE.stes, IPM_allvar_noanx_sub1models_fit)
```

All the previously constrained common factors (ac7, ac15, cc4) still need to be constrained, so we will constrain all together. 

##### Common and specific

To constrain:
* A1 factors of *conduct18(ac7)* - constrained
* A2 factors of *isolation18(ac15)* - constrained
* C1 factors of *psychosis18(cc4)* - constrained
* A factors of *depression12(as2)*, *depression18(as6)* - constrained
* C factors of *isolation12(cs1)*, *conduct12(cs3)*, *isolation18(cs5)*, *depression18(cs6)*, *conduct18(cs7)*, *psychosis18(cs8)* - constrained

```{r specific constrained submodel}
# create a "copy" of the model
IPM_allvar_noanx_submodel <- mxModel(IPM_allvar_noanx_fit, name = "IPM_allvar_noanx_sub")

# set parameters identified above to be zero
IPM_allvar_noanx_submodel <- omxSetParameters(IPM_allvar_noanx_submodel,
                                         labels = c("ac7","ac15",
                                                    "cc4",
                                                    "as2", "as6",
                                                    "cs1", "cs3", "cs5", "cs6", "cs7", "cs8"), 
                                         free = FALSE, 
                                         values = 0)

IPM_allvar_noanx_submodel    <- omxAssignFirstParameters(IPM_allvar_noanx_submodel)

# Run sunmodels
IPM_allvar_noanx_submodel_fit <- mxTryHard(IPM_allvar_noanx_submodel, intervals = TRUE)

# create summary
IPM_allvar_noanx_submodel_sum <- summary(IPM_allvar_noanx_submodel_fit)

# compare to original model      
mxCompare(IPM_allvar_noanx_fit, IPM_allvar_noanx_submodel_fit)
```

```{r results from IPM_allvar_sub2models_fit}
# common unsquared parameters
mxEval(ACE.stac, IPM_allvar_noanx_submodel_fit)
mxEval(ACE.stcc, IPM_allvar_noanx_submodel_fit)
mxEval(ACE.stec, IPM_allvar_noanx_submodel_fit)

# specific unsquared parameters
mxEval(ACE.stas, IPM_allvar_noanx_submodel_fit)
mxEval(ACE.stcs, IPM_allvar_noanx_submodel_fit)
mxEval(ACE.stes, IPM_allvar_noanx_submodel_fit)
```

```{r output for IPM_allvar_nopsy_fit}
IPM_esitmates_ACE_8var(data = IPM_allvar_noanx_submodel_fit,
                  variable1 = "Isolation12",
                  variable2 = "Depression12",
                  variable3 = "Conduct12",
                  variable4 = "Psychosis12",
                  variable5 = "Isolation18",
                  variable6 = "Depression18",
                  variable7 = "Conduct18",
                  variable8 = "Psychosis18",
                  model = "ACE",
                  uniACEestimates = TRUE,
                  pathestimates = TRUE,
                  A_percent = TRUE,
                  C_percent = TRUE,
                  E_percent = TRUE,
                  common_factor_contribution = TRUE)
```

## Sex differences - IN PROGRESS

The following variables had quantitative sex differences:

* Social isolation age 12
* Anxiety age 18
* Depression age 18
* Conduct disorder age 12
* Psychosis age 12
* Psychosis age 18


### ACE - separate means

* The `Scalar` correction is `TRUE` only for the variables that need sex correction. In our case this would be all variables apart from social isolation at age 12. **This is only based on linear regressions, rather than estimating sex differences in OpenMx**. 
* mxBounds() creates bounds for the objects, but I'm not entirely sure what these are??

#### Specify

```{r ACE model for IPM_allvar_noanx_sexmean}
IPM_allvar_noanx_sexmean <- mxModel("IPM_allvar_noanx_sexmean",
	mxModel("ACE",
    # Common ace paths
    mxMatrix("Full", nrow = nv, ncol = nfAc, free = Ac2Free, labels = aclab_noanx, values = Ac2Values, name = "ac"),
    mxMatrix("Full", nrow = nv, ncol = nfAc, free = Ac2Free, labels = cclab_noanx, values = Cc2Values, name = "cc"),
    mxMatrix("Full", nrow = nv, ncol = nfAc, free = Ac2Free, labels = eclab_noanx, values = Ec2Values, name = "ec"),

    # Specific ace paths
    mxMatrix("Diag", nrow = nv, ncol = nv, free = TRUE, labels = aslab_noanx, values = 0.6,  name = "as"),
    mxMatrix("Diag", nrow = nv, ncol = nv, free = TRUE, labels = cslab_noanx, values = 0.01, name = "cs"),
    mxMatrix("Diag", nrow = nv, ncol = nv, free = TRUE, labels = eslab_noanx, values = 0.6,  name = "es"),

		# ACE variance components
    mxAlgebra(ac %*% t(ac) + as %*% t(as), name = "A"),
    mxAlgebra(cc %*% t(cc) + cs %*% t(cs), name = "C"),
    mxAlgebra(ec %*% t(ec) + es %*% t(es), name = "E"),
    mxAlgebra(A + C + E, name = "V"),

		# Calculate standard deviation for standardization
    mxMatrix("Iden", nrow = nv, ncol = nv, name = "I"),
    mxAlgebra(solve(sqrt(I*V)), name = "iSD"), # extracting the variances from the diagonal of the covariance matrix V

		# Expected means vector
    mxMatrix("Full", nrow = 1, ncol = nv, free = TRUE, values = 0.01, name = "MeanM"), # mean for males
    mxAlgebra(cbind(MeanM, MeanM), name = "expMeanM"),

    mxMatrix("Full", nrow = 1, ncol = nv, free = TRUE, values = 0.01, name = "MeanF"), # mean for females
    mxAlgebra(cbind(MeanF,MeanF), name = "expMeanF"),

    # Genetic and environmental correlations (correlated factor solution)
    mxAlgebra(solve(sqrt(I*V)) %&% V, name = "Rph"),
    mxAlgebra(solve(sqrt(I*A)) %&% A, name = "Ra"),
    mxAlgebra(solve(sqrt(I*C)) %&% C, name = "Rc"),
    mxAlgebra(solve(sqrt(I*E)) %&% E, name = "Re"),

    # Standardised components of variance
    mxAlgebra(A/V, name = "h2"),
    mxAlgebra(C/V, name = "c2"),
    mxAlgebra(E/V, name = "e2"),

    # Standardise common parameters (unsquared)
    mxAlgebra(iSD %*% ac, name = "stac"),
    mxAlgebra(iSD %*% cc, name = "stcc"),
    mxAlgebra(iSD %*% ec, name = "stec"),

    # Standardise common parameters (Squared)
    mxAlgebra(stac*stac, name = "stac2"),
    mxAlgebra(stcc*stcc, name = "stcc2"),
    mxAlgebra(stec*stec, name = "stec2"),

    # Standardise specific parameters (unsquared)
    mxAlgebra(iSD %*% as, name = "stas"),
    mxAlgebra(iSD %*% cs, name = "stcs"),
    mxAlgebra(iSD %*% es, name = "stes"),

    # Standardise specific parameters (Squared)
    mxAlgebra(stas*stas, name = "stas2"),
    mxAlgebra(stcs*stcs, name = "stcs2"),
    mxAlgebra(stes*stes, name = "stes2"),

    # Scalar multiplier 
    mxMatrix("Diag", nrow = ntv, ncol = ntv, free = c( T, F, T, T, F, T, F, T,   # True for isolation12 conduct12, psychosis12, depression18, and psychosis18. 
                                                       T, F, T, T, F, T, F, T),
             values = 1,
             label  = c("sc1", "sc2", "sc3", "sc4", "sc5", "sc6", "sc7","sc8", 
                        "sc1", "sc2", "sc3", "sc4", "sc5", "sc6", "sc7","sc8"),
             name   = "Scalar"),

    mxBounds(c("sc1", "sc3", "sc4", "sc6", "sc8"), 0, NA), # creates bounds for these objects when = TRUE

		# MZ expected covariance matrix
		mxAlgebra(Scalar %&% rbind(cbind(A+C+E, A+C), cbind(A+C, A+C+E)), name = "expCovMZm"), 
		mxAlgebra(rbind(cbind(A+C+E, A+C), cbind(A+C, A+C+E)), name = "expCovMZf"),

		# DZ expected covariance matrix
		mxAlgebra(Scalar %&% rbind(cbind(A+C+E, (0.5%x%A)+C), cbind((0.5%x%A)+C, A+C+E)), name = "expCovDZm"), 
		mxAlgebra(rbind(cbind(A+C+E, (0.5%x%A)+C), cbind((0.5%x%A)+C, A+C+E)), name = "expCovDZf")

	),

	mxModel("MZM",
		mxData(observed = dat.twin.MZm, type = "raw"),
		mxExpectationNormal(covariance = "ACE.expCovMZm", means = "ACE.expMeanM", dimnames = selvars_noanx_norm_reg),
		mxFitFunctionML()
	),
	mxModel("MZF",
		mxData(observed = dat.twin.MZf, type = "raw"),
		mxExpectationNormal(covariance = "ACE.expCovMZf", means = "ACE.expMeanF", dimnames = selvars_noanx_norm_reg),
		mxFitFunctionML()
	),
	mxModel("DZM",
		mxData(observed = dat.twin.DZm, type = "raw"),
		mxExpectationNormal(covariance = "ACE.expCovDZm", means = "ACE.expMeanM", dimnames = selvars_noanx_norm_reg),
		mxFitFunctionML()
	),
	mxModel("DZF",
		mxData(observed = dat.twin.DZf, type = "raw"),
		mxExpectationNormal(covariance = "ACE.expCovDZf", means = "ACE.expMeanF", dimnames = selvars_noanx_norm_reg),
		mxFitFunctionML()
	),

	mxAlgebra(MZM.objective + DZM.objective + MZF.objective + DZF.objective, name = "m2LL"),
	mxFitFunctionAlgebra("m2LL"),
	mxCI(c("ACE.stac2",
	       "ACE.stcc2",
	       "ACE.stec2",
	       "ACE.stas2",
	       "ACE.stcs2",
	       "ACE.stes2",
	       "ACE.Rph",
	       "ACE.h2",
	       "ACE.c2",
	       "ACE.e2"))
)
```

```{r run ACE mdoel for psychosis}
IPM_allvar_noanx_sexmean_fit <- mxTryHard(IPM_allvar_noanx_sexmean, intervals = FALSE)
summary(IPM_allvar_noanx_sexmean_fit, verbose = TRUE)
```

#### Output

```{r output for IPM_allvar_noanx_sexmean_fit}
IPM_esitmates_ACE_8var_noCI(data = IPM_allvar_noanx_sexmean_fit,
                  variable1 = "Isolation12",
                  variable2 = "Depression12",
                  variable3 = "Conduct12",
                  variable4 = "Psychosis12",
                  variable5 = "Isolation18",
                  variable6 = "Depression18",
                  variable7 = "Conduct18",
                  variable8 = "Psychosis18",
                  model = "ACE",
                  uniACEestimates = TRUE,
                  pathestimates = TRUE,
                  A_percent = TRUE,
                  C_percent = TRUE,
                  E_percent = TRUE,
                  common_factor_contribution = TRUE)
```

```{r check for negative loadings}
# common unsquared parameters
mxEval(ACE.stac, IPM_allvar_noanx_sexmean_fit)
mxEval(ACE.stcc, IPM_allvar_noanx_sexmean_fit)
mxEval(ACE.stec, IPM_allvar_noanx_sexmean_fit)

# specific unsquared parameters
mxEval(ACE.stas, IPM_allvar_noanx_sexmean_fit)
mxEval(ACE.stcs, IPM_allvar_noanx_sexmean_fit)
mxEval(ACE.stes, IPM_allvar_noanx_sexmean_fit)
```

This is the same A1 factors as above that need constraining - conduct12. 

#### Submodels - update with specific

##### Common factors

For the common factors there are negative stac/stcc/stec estimates coming from:
* A1 factors for *conduct12(ac7)* and A2 for *isolation18(ac11)*

```{r Common constrained submodel}
# create a "copy" of the model
IPM_allvar_noanx_sexmean_sub1modelc <- mxModel(IPM_allvar_noanx_sexmean_fit, name = "IPM_allvar_noanx_sexmean_sub1c") 

# set parameters identified above to be zero
IPM_allvar_noanx_sexmean_sub1modelc <- omxSetParameters(IPM_allvar_noanx_sexmean_sub1modelc,
                                         labels = c("ac7", "ac11"
                                                    ),
                                         free = FALSE, 
                                         values = 0)

IPM_allvar_noanx_sexmean_sub1modelc <- omxAssignFirstParameters(IPM_allvar_noanx_sexmean_sub1modelc)

# Run sunmodels
IPM_allvar_noanx_sexmean_sub1modelc_fit <- mxTryHard(IPM_allvar_noanx_sexmean_sub1modelc, intervals = FALSE)

# create summary
IPM_allvar_noanx_sexmean_sub1modelc_sum <- summary(IPM_allvar_noanx_sexmean_sub1modelc_fit)

# compare to original model   
mxCompare(IPM_allvar_noanx_sexmean_fit, IPM_allvar_noanx_sexmean_sub1modelc_fit)
```

```{r results from IPM_allvar_noanx_sub1models_fit}
# common unsquared parameters
mxEval(ACE.stac, IPM_allvar_noanx_sexmean_sub1modelc_fit)
mxEval(ACE.stcc, IPM_allvar_noanx_sexmean_sub1modelc_fit)
mxEval(ACE.stec, IPM_allvar_noanx_sexmean_sub1modelc_fit)

# specific unsquared parameters
mxEval(ACE.stas, IPM_allvar_noanx_sexmean_sub1modelc_fit)
mxEval(ACE.stcs, IPM_allvar_noanx_sexmean_sub1modelc_fit)
mxEval(ACE.stes, IPM_allvar_noanx_sexmean_sub1modelc_fit)
```

We now need to constrain *ac15* and *cc4*.

***

