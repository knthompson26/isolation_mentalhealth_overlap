---
title: "The overlap between social isolation and mental health problems: ACE model" 
output:  
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: false
    number_sections: false
    highlight: monochrome
    theme: flatly
    code_folding: show
    includes:
      after_body: footer.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      comment = NA,
                      prompt = FALSE,
                      cache = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      results = 'markup')

options(bitmapType = 'quartz') # to render fonts better
```

```{r Clear global environment, include=FALSE}
remove(list = ls())
```

```{r Load packages, include=FALSE}
library(knitr)
library(haven)
library(psych)   
library(bestNormalize)
library(OpenMx)
library(tidyr)
library(tidyverse)
library(dplyr)     # conflicts with tidyverse for e.g. rename and row_number
```

# Source functions

```{r source functions, include=FALSE}
source("isolation_mhealth_functions.R")
```

# Read in data

```{r source the data file path, include=FALSE}
# source raw data directory
source("../isolation_mentalhealth_data_path.R")
```

```{r read in dta data file, include=FALSE}
dat.raw <- read_dta(paste0(data_path_raw, "Katie_23Sep22.dta"))
colnames(dat.raw)
```

### Column names

```{r select variables needed}
dat <- dat.raw %>%
  dplyr::select(
         atwinid,
         btwinid,
         familyid,
         rorderp5,
         torder,
         zygosity,
         sampsex,
         sisoe12,
         sisoy12,
         masce12,     # anxiety
         mascy12,   
         cdie12,      # depression
         cdiy12,
         conec12,     # antisocial behaviour / conduct disorder
         conyc12,
         psysympe12,  # psychosis - why is this not the tot scale variable - to give more variation?
         psysympy12,
         socisoe18,
         socisoy18,
         gadsxe18,    # anxiety
         gadsxy18,
         mdesxe18,    # depression
         mdesxy18,
         cdsxe18,     # antisocial behaviour / conduct disorder
         cdsxy18,
         psyexpe18,   # psychotic experiences
         psyexpy18
  )

colnames(dat)
```

### Recode variables into factors {.tabset .tabset-fade}

#### Sex

```{r recode sex}
dat <- dat %>%
  mutate(
    sex = 
      recode_factor(as_factor(sampsex),
        "1" = "Male",
        "2" = "Female"))

table(dat$sex)
```

#### Zygosity

```{r recode zygosity}
dat <- dat %>%
  mutate(
    zygosity = 
      recode_factor(as_factor(zygosity),
        "1" = "MZ",
        "2" = "DZ"))
table(dat$zygosity)
```

### Convert variables to numeric

```{r create numeric isolation variables}
dat <- dat %>%
  mutate(
    sisoe12 = as.numeric(sisoe12),
    sisoy12 = as.numeric(sisoy12),
    masce12 = as.numeric(masce12),       # anxiety
    mascy12 = as.numeric(mascy12),   
    cdie12 = as.numeric(cdie12),         # depression
    cdiy12 = as.numeric(cdiy12),
    conec12 = as.numeric(conec12),       # antisocial behaviour / conduct disorder
    conyc12 = as.numeric(conyc12),
    psysympe12 = as.numeric(psysympe12), # psychosis - why is this not the tot scale variable - to give more variation?
    psysympy12 = as.numeric(psysympy12),
    socisoe18 = as.numeric(socisoe18),
    socisoy18 = as.numeric(socisoy18),
    gadsxe18 = as.numeric(gadsxe18),     # anxiety
    gadsxy18 = as.numeric(gadsxy18),
    mdesxe18 = as.numeric(mdesxe18),     # depression
    mdesxy18 = as.numeric(mdesxy18),
    cdsxe18 = as.numeric(cdsxe18),       # antisocial behaviour / conduct disorder
    cdsxy18 = as.numeric(cdsxy18),
    psyexpe18 = as.numeric(psyexpe18),   # psychotic experiences
    psyexpy18 = as.numeric(psyexpy18)
  ) %>%
  select(                                # remove variables not needed
    -c(sampsex)
  )
```

# Variable lists

```{r select variables - raw}
# social isolation
selvars_si12 <- c("sisoe12", "sisoy12")
selvars_si18 <- c("socisoe18", "socisoy18")

# anxiety
selvars_anx12 <- c("masce12", "mascy12")
selvars_anx18 <- c("gadsxe18", "gadsxy18")

# depression
selvars_dep12 <- c("cdie12", "cdiy12")
selvars_dep18 <- c("mdesxe18", "mdesxy18")

# conduct
selvars_con12 <- c("conec12", "conyc12")
selvars_con18 <- c("cdsxe18", "cdsxy18")

# psychosis
selvars_psy12 <- c("psysympe12", "psysympy12")
selvars_psy18 <- c("psyexpe18", "psyexpy18")

# all 
selvars <- c("sisoe12", "masce12", "cdie12", "conec12",  "psysympe12", "socisoe18", "gadsxe18", "mdesxe18", "cdsxe18", "psyexpe18",
             "sisoy12", "mascy12", "cdiy12", "conyc12", "psysympy12",  "socisoy18", "gadsxy18", "mdesxy18", "cdsxy18","psyexpy18")
```

```{r select variables - standardised}
# social isolation
selvars_si12_z_score <- c("z_score_sisoe12", "z_score_sisoy12")
selvars_si18_z_score <- c("z_score_socisoe18", "z_score_socisoy18")

# anxiety
selvars_anx12_z_score <- c("z_score_masce12", "z_score_mascy12")
selvars_anx18_z_score <- c("z_score_gadsxe18", "z_score_gadsxy18")

# depression
selvars_dep12_z_score <- c("z_score_cdie12", "z_score_cdiy12")
selvars_dep18_z_score <- c("z_score_mdesxe18", "z_score_mdesxy18")

# conduct
selvars_con12_z_score <- c("z_score_conec12", "z_score_conyc12")
selvars_con18_z_score <- c("z_score_cdsxe18", "z_score_cdsxy18")

# psychosis
selvars_psy12_z_score <- c("z_score_psysympe12", "z_score_psysympy12")
selvars_psy18_z_score <- c("z_score_psyexpe18", "z_score_psyexpy18")
```

```{r select variables - normalised}
# social isolation
selvars_si12norm <- c("sisoe12norm", "sisoy12norm")
selvars_si18norm <- c("socisoe18norm", "socisoy18norm")

# anxiety
selvars_anx12norm <- c("masce12norm", "mascy12norm")
selvars_anx18norm <- c("gadsxe18norm", "gadsxy18norm")

# depression
selvars_dep12norm <- c("cdie12norm", "cdiy12norm")
selvars_dep18norm <- c("mdesxe18norm", "mdesxy18norm")

# conduct
selvars_con12norm <- c("conec12norm", "conyc12norm")
selvars_con18norm <- c("cdsxe18norm", "cdsxy18norm")

# psychosis
selvars_psy12norm <- c("psysympe12norm", "psysympy12norm")
selvars_psy18norm <- c("psyexpe18norm", "psyexpy18norm")

# all 
selvars_norm <- c("sisoe12norm", "masce12norm", "cdie12norm", "conec12norm", "psysympe12norm", "socisoe18norm", "gadsxe18norm", "mdesxe18norm", "cdsxe18norm", "psyexpe18norm",
                  "sisoy12norm", "mascy12norm", "cdiy12norm", "conyc12norm", "psysympy12norm", "socisoy18norm", "gadsxy18norm", "mdesxy18norm", "cdsxy18norm", "psyexpy18norm")

# all with non-normalised - not in the twin modelling specific order here only used to standardise all variables at once
selvars_norm_all <- c("sisoe12", "sisoy12", "masce12", "mascy12", "cdie12", "cdiy12", "conec12", "conyc12", "psysympe12", "psysympy12", 
                      "socisoe18", "socisoy18", "gadsxe18", "gadsxy18", "mdesxe18", "mdesxy18", "cdsxe18", "cdsxy18", "psyexpe18", "psyexpy18",
                      "sisoe12norm", "sisoy12norm", "masce12norm", "mascy12norm", "cdie12norm", "cdiy12norm", "conec12norm", "conyc12norm", "psysympe12norm", "psysympy12norm", 
                      "socisoe18norm", "socisoy18norm", "gadsxe18norm", "gadsxy18norm", "mdesxe18norm", "mdesxy18norm", "cdsxe18norm", "cdsxy18norm", "psyexpe18norm", "psyexpy18norm")
```

```{r select variables - standardised and normalised}
# social isolation
selvars_si12_z_score_norm <- c("z_score_sisoe12norm", "z_score_sisoy12norm")
selvars_si18_z_score_norm <- c("z_score_socisoe18norm", "z_score_socisoy18norm")

# anxiety
selvars_anx12_z_score_norm <- c("z_score_masce12norm", "z_score_mascy12norm")
selvars_anx18_z_score_norm <- c("z_score_gadsxe18norm", "z_score_gadsxy18norm")

# depression
selvars_dep12_z_score_norm <- c("z_score_cdie12norm", "z_score_cdiy12norm")
selvars_dep18_z_score_norm <- c("z_score_mdesxe18norm", "z_score_mdesxy18norm")

# conduct
selvars_con12_z_score_norm <- c("z_score_conec12", "z_score_conyc12")
selvars_con18_z_score_norm <- c("z_score_cdsxe18norm", "z_score_cdsxy18norm")

# psychosis
selvars_psy12norm_z_score_norm <- c("z_score_psysympe12norm", "z_score_psysympy12norm")
selvars_psy18norm_z_score_norm <- c("z_score_psyexpe18norm", "z_score_psyexpy18norm")
```

```{r select variables - normalised and regressed sex}
# social isolation
selvars_si12norm_reg <- c("sisoe12norm_reg", "sisoy12norm_reg")
selvars_si18norm_reg <- c("socisoe18norm_reg", "socisoy18norm_reg")

# anxiety
selvars_anx12norm_reg <- c("masce12norm_reg", "mascy12norm_reg")
selvars_anx18norm_reg <- c("gadsxe18norm_reg", "gadsxy18norm_reg")

# depression
selvars_dep12norm_reg <- c("cdie12norm_reg", "cdiy12norm_reg")
selvars_dep18norm_reg <- c("mdesxe18norm_reg", "mdesxy18norm_reg")

# conduct
selvars_con12norm_reg <- c("conec12norm_reg", "conyc12norm_reg")
selvars_con18norm_reg <- c("cdsxe18norm_reg", "cdsxy18norm_reg")

# psychosis
selvars_psy12norm_reg <- c("psysympe12norm_reg", "psysympy12norm_reg")
selvars_psy18norm_reg <- c("psyexpe18norm_reg", "psyexpy18norm_reg")

# all 
selvars_norm_reg <- c("sisoe12norm_reg", "masce12norm_reg", "cdie12norm_reg", "conec12norm_reg", "psysympe12norm_reg", "socisoe18norm_reg", "gadsxe18norm_reg", "mdesxe18norm_reg", "cdsxe18norm_reg", "psyexpe18norm_reg",
                  "sisoy12norm_reg", "mascy12norm_reg", "cdiy12norm_reg", "conyc12norm_reg", "psysympy12norm_reg", "socisoy18norm_reg", "gadsxy18norm_reg", "mdesxy18norm_reg", "cdsxy18norm_reg", "psyexpy18norm_reg")

# all with non-norm_regalised - not in the twin modelling specific order here only used to standardise all variables at once
selvars_norm_reg_all <- c("sisoe12", "sisoy12", "masce12", "mascy12", "cdie12", "cdiy12", "conec12", "conyc12", "psysympe12", "psysympy12", 
                      "socisoe18", "socisoy18", "gadsxe18", "gadsxy18", "mdesxe18", "mdesxy18", "cdsxe18", "cdsxy18", "psyexpe18", "psyexpy18",
                      "sisoe12norm_reg", "sisoy12norm_reg", "masce12norm_reg", "mascy12norm_reg", "cdie12norm_reg", "cdiy12norm_reg", "conec12norm_reg", "conyc12norm_reg", "psysympe12norm_reg", "psysympy12norm_reg", 
                      "socisoe18norm_reg", "socisoy18norm_reg", "gadsxe18norm_reg", "gadsxy18norm_reg", "mdesxe18norm_reg", "mdesxy18norm_reg", "cdsxe18norm_reg", "cdsxy18norm_reg", "psyexpe18norm_reg", "psyexpy18norm_reg")
```

# Data prep

## Skewness

```{r histograms}
# isolation
hist(dat$sisoe12)    # not normal
hist(dat$socisoe18)  # not normal
# anxiety
hist(dat$masce12)    # normal
hist(dat$gadsxe18)   # not normal
# depression
hist(dat$cdie12)     # not normal
hist(dat$mdesxe18)   # not normal
# conduct
hist(dat$conec12)    # not normal
hist(dat$cdsxe18)    # not normal
# psychosis
hist(dat$psysympe12) # not normal
hist(dat$psyexpe18)  # not normal
```

## Rank transformation

Almost all variables are non-normal. We will use the van der Waerden's rank-based transformation as used in [Rimfeld et al 2021](https://acamh.onlinelibrary.wiley.com/doi/full/10.1002/jcv2.12053). For analyses using transformed data, they conducted the van der Waerden transformation prior to residualizing for age and sex as recommended by [Pain et al. 2018](https://www.nature.com/articles/s41431-018-0159-6).  

I will transform all variables to get the normalised estimate.

```{r rank transform variables elder variables}
# isolation age 12 - test log transformation rather than bestnormalise
dat$sisoe12norm_test <- log(dat$sisoe12)
hist(dat$sisoe12norm_test)

# isolation age 12
sisoe12_n <- bestNormalize(dat$sisoe12)    # select the type of transformation needed
dat$sisoe12norm <- predict(sisoe12_n)      # create normalised variable
hist(dat$sisoe12norm)                  
summary(dat$sisoe12norm)

# isolation age 18
socisoe18_n <- bestNormalize(dat$socisoe18)    
dat$socisoe18norm <- predict(socisoe18_n)  
hist(dat$socisoe18norm)                  
summary(dat$socisoe18norm)

# anxiety age 12 - wont actually use this as it's already normally distributed
masce12_n <- bestNormalize(dat$masce12)    
dat$masce12norm <- predict(masce12_n)  
hist(dat$masce12norm)                  
summary(dat$masce12norm)

# anxiety age 18
gadsxe18_n <- bestNormalize(dat$gadsxe18)    
dat$gadsxe18norm <- predict(gadsxe18_n)  
hist(dat$gadsxe18norm)                  
summary(dat$gadsxe18norm)

# depression age 12
cdie12_n <- bestNormalize(dat$cdie12)    
dat$cdie12norm <- predict(cdie12_n)  
hist(dat$cdie12norm)                  
summary(dat$cdie12norm)

# depression age 18
mdesxe18_n <- bestNormalize(dat$mdesxe18)    
dat$mdesxe18norm <- predict(mdesxe18_n)  
hist(dat$mdesxe18norm)                  
summary(dat$mdesxe18norm)

# conduct age 12
conec12_n <- bestNormalize(dat$conec12)    
dat$conec12norm <- predict(conec12_n)  
hist(dat$conec12norm)                  
summary(dat$conec12norm)

# conduct age 18
cdsxe18_n <- bestNormalize(dat$cdsxe18)    
dat$cdsxe18norm <- predict(cdsxe18_n)  
hist(dat$cdsxe18norm)                  
summary(dat$cdsxe18norm)

# psychosis age 12
psysympe12_n <- bestNormalize(dat$psysympe12)    
dat$psysympe12norm <- predict(psysympe12_n)  
hist(dat$psysympe12norm)                  
summary(dat$psysympe12norm)

# psychosis age 18
psyexpe18_n <- bestNormalize(dat$psyexpe18)    
dat$psyexpe18norm <- predict(psyexpe18_n)  
hist(dat$psyexpe18norm)                  
summary(dat$psyexpe18norm)
```

```{r rank transform variables younger variables}
# isolation age 12
sisoy12_n <- bestNormalize(dat$sisoy12)    # select the type of transformation needed
dat$sisoy12norm <- predict(sisoy12_n)  # create normalised variable
hist(dat$sisoy12norm)                  
summary(dat$sisoy12norm)

# isolation age 18
socisoy18_n <- bestNormalize(dat$socisoy18)    
dat$socisoy18norm <- predict(socisoy18_n)  
hist(dat$socisoy18norm)                  
summary(dat$socisoy18norm)

# anxiety age 12 - wont actually use this as it's already normally distributed
mascy12_n <- bestNormalize(dat$mascy12)    
dat$mascy12norm <- predict(mascy12_n)  
hist(dat$mascy12norm)                  
summary(dat$mascy12norm)

# anxiety age 18
gadsxy18_n <- bestNormalize(dat$gadsxy18)    
dat$gadsxy18norm <- predict(gadsxy18_n)  
hist(dat$gadsxy18norm)                  
summary(dat$gadsxy18norm)

# depression age 12
cdiy12_n <- bestNormalize(dat$cdiy12)    
dat$cdiy12norm <- predict(cdiy12_n)  
hist(dat$cdiy12norm)                  
summary(dat$cdiy12norm)

# depression age 18
mdesxy18_n <- bestNormalize(dat$mdesxy18)    
dat$mdesxy18norm <- predict(mdesxy18_n)  
hist(dat$mdesxy18norm)                  
summary(dat$mdesxy18norm)

# conduct age 12
conyc12_n <- bestNormalize(dat$conyc12)    
dat$conyc12norm <- predict(conyc12_n)  
hist(dat$conyc12norm)                  
summary(dat$conyc12norm)

# conduct age 18
cdsxy18_n <- bestNormalize(dat$cdsxy18)    
dat$cdsxy18norm <- predict(cdsxy18_n)  
hist(dat$cdsxy18norm)                  
summary(dat$cdsxy18norm)

# psychosis age 12
psysympy12_n <- bestNormalize(dat$psysympy12)    
dat$psysympy12norm <- predict(psysympy12_n)  
hist(dat$psysympy12norm)                  
summary(dat$psysympy12norm)

# psychosis age 18
psyexpy18_n <- bestNormalize(dat$psyexpy18)    
dat$psyexpy18norm <- predict(psyexpy18_n)  
hist(dat$psyexpy18norm)                  
summary(dat$psyexpy18norm)
```

## Regress out sex

We first normalised the twin variables, then regress out sex. We don't regress out age here as all twins were measured as close to their birthday as possible. 

```{r Regress out age and sex}
# twin 1 - elder
## isolation
dat$sisoe12norm_reg <- (resid(lm(data = dat, sisoe12norm ~ sex, na.action = na.exclude))) +1
dat$socisoe18norm_reg <- (resid(lm(data = dat, socisoe18norm ~ sex, na.action = na.exclude))) +1
## anxiety
dat$masce12norm_reg <- (resid(lm(data = dat, masce12norm ~ sex, na.action = na.exclude))) +1
dat$gadsxe18norm_reg <- (resid(lm(data = dat, gadsxe18norm ~ sex, na.action = na.exclude))) +1
## depression
dat$cdie12norm_reg <- (resid(lm(data = dat, cdie12norm ~ sex, na.action = na.exclude))) +1
dat$mdesxe18norm_reg <- (resid(lm(data = dat, mdesxe18norm ~ sex, na.action = na.exclude))) +1
## conduct
dat$conec12norm_reg <- (resid(lm(data = dat, conec12norm ~ sex, na.action = na.exclude))) +1
dat$cdsxe18norm_reg <- (resid(lm(data = dat, cdsxe18norm ~ sex, na.action = na.exclude))) +1
## psychosis
dat$psysympe12norm_reg <- (resid(lm(data = dat, psysympe12norm ~ sex, na.action = na.exclude))) +1
dat$psyexpe18norm_reg <- (resid(lm(data = dat, psyexpe18norm ~ sex, na.action = na.exclude))) +1

# twin 2 - younger
## isolation
dat$sisoy12norm_reg <- (resid(lm(data = dat, sisoy12norm ~ sex, na.action = na.exclude))) +1
dat$socisoy18norm_reg <- (resid(lm(data = dat, socisoy18norm ~ sex, na.action = na.exclude))) +1
## anxiety
dat$mascy12norm_reg <- (resid(lm(data = dat, mascy12norm ~ sex, na.action = na.exclude))) +1
dat$gadsxy18norm_reg <- (resid(lm(data = dat, gadsxy18norm ~ sex, na.action = na.exclude))) +1
## depression
dat$cdiy12norm_reg <- (resid(lm(data = dat, cdiy12norm ~ sex, na.action = na.exclude))) +1
dat$mdesxy18norm_reg <- (resid(lm(data = dat, mdesxy18norm ~ sex, na.action = na.exclude))) +1
## conduct
dat$conyc12norm_reg <- (resid(lm(data = dat, conyc12norm ~ sex, na.action = na.exclude))) +1
dat$cdsxy18norm_reg <- (resid(lm(data = dat, cdsxy18norm ~ sex, na.action = na.exclude))) +1
## psychosis
dat$psysympy12norm_reg <- (resid(lm(data = dat, psysympy12norm ~ sex, na.action = na.exclude))) +1
dat$psyexpy18norm_reg <- (resid(lm(data = dat, psyexpy18norm ~ sex, na.action = na.exclude))) +1
```

## Standardising

Create *z scores* for all variables. 

```{r scale variables and combine to MZ dataset}
# create a scaled version of the continuous variables - z scores for all variables
scaled_continuous_data <- as.data.frame(scale(dat[selvars_norm_all], center = TRUE, scale = TRUE))

# rename variables to show that they are z scores 
colnames(scaled_continuous_data) <- paste0("z_score_", colnames(scaled_continuous_data))

# combine the scaled data to the main dataset for  and DZ twins
dat <- cbind(dat, scaled_continuous_data)

colnames(dat)
```

## Create twin dataset

To remove the double entry in the data, we will remove everyone who has a "random twin order" variable of 0. This will then remove any birth order effects. 

```{r remove one twin pair row}
dat.twin <- dat %>% filter(rorderp5 == "1")
```

```{r datasets for MZ and DZ}
dat.twin.MZ <- dat.twin %>% filter(zygosity == "MZ")
dat.twin.DZ <- dat.twin %>% filter(zygosity == "DZ")

# male only
dat.twin.MZm <- dat.twin.MZ %>% filter(sex == "Male")
dat.twin.DZm <- dat.twin.DZ %>% filter(sex == "Male")
# female only
dat.twin.MZf <- dat.twin.MZ %>% filter(sex == "Female")
dat.twin.DZf <- dat.twin.DZ %>% filter(sex == "Female")
```

## Summary of MZ and DZ data

### Overall

```{r describe MZ and DZ data}
MZ_summary <- describe(dat.twin.MZ, 
                       skew = FALSE, 
                       range = FALSE)

DZ_summary <- describe(dat.twin.DZ, 
                       skew = FALSE, 
                       range = FALSE)
```

### MZ correlations

```{r MZ matrices}
# covariance matrix
covar.mz <- cov(dat.twin.MZ[, selvars], use = "complete")
# correlation matrix (standardized covariance)
cor.mz <- cor(dat.twin.MZ[, selvars], use = "complete")
round(cor.mz, 3)
```

### DZ correlations

```{r DZ matrices}
# covariance matrix
covar.dz <- cov(dat.twin.DZ[, selvars], use = "complete")
# correlation matrix (standardized covariance)
cor.dz <- cor(dat.twin.DZ[, selvars], use = "complete")
round(cor.dz, 3)
```

# Univariate ACE model

## Specify

This model will be applied to all variables at age 12 and 18 - social isolation, anxiety, depression, conduct disorder, psychosis. 

```{r number of variables (phenotypes)}
# number of variables
nv <- 1    					      # number of variables 
ntv <- nv*2 				      # number of twin variables

# default optimizer 
mxOption(NULL, "Default optimizer", "CSOLNP")
```

```{r start values}
# start values
svM	  <- c(rep(0.7, ntv))	  # means               
svSD  <- c(rep(1.1, ntv))   # standard deviations
svRmz <- c(0.3)             # correlations for MZ
svRdz <- c(0.15)            # correlations for DZ 

rowVars	<- rep('Vars', nv)
colVars	<- rep(c('h2', 'c2', 'e2'), each = nv)
```

```{r specity ACE}
# Matrix & Algebra for expected means vector (free)
MeanMZ <- mxMatrix("Full", 1, ntv, free = T, values = c(90,90), labels = c("MZm1", "MZm2"), name = "expMeanMZ")
MeanDZ <- mxMatrix("Full", 1, ntv, free = T, values = c(90,90), labels = c("DZm1", "DZm2"), name = "expMeanDZ")

# Matrices to estimate free a, c, and e path coefficients
pathA	<- mxMatrix(type = "Full", nrow = nv, ncol = nv, free = T, values = 10, label = "a11", name = "a")
pathC	<- mxMatrix(type = "Full", nrow = nv, ncol = nv, free = T, values = 10, label = "c11", name = "c")
pathE	<- mxMatrix(type = "Full", nrow = nv, ncol = nv, free = T, values = 10, label = "e11", name = "e")

# Algebra to generate Matrices to hold A, C, and E computed Variance Components
covA <- mxAlgebra(expression = a %*% t(a), name = "A" )
covC <- mxAlgebra(expression = c %*% t(c), name = "C" )
covE <- mxAlgebra(expression = e %*% t(e), name = "E" )

# Algebra to compute Total Variance
covP <- mxAlgebra(expression = A+C+E, name = "V" )
sd   <- mxAlgebra(expression = sqrt(V), name = "SD")

# Algebra to compute standardized path estimates 
stpathA	<- mxAlgebra(expression = a/SD, name = "sta")
stpathC <- mxAlgebra(expression = c/SD, name = "stc")
stpathE <- mxAlgebra(expression = e/SD, name = "ste")

# Algebra to compute standardized variance components 
stcovA <- mxAlgebra(expression = A/V, name = "h2")
stcovC <- mxAlgebra(expression = C/V, name = "c2")
stcovE <- mxAlgebra(expression = E/V, name = "e2")

# Algebra for Expected Variance/Covariance Matrices in MZ & DZ twins
covMZ <- mxAlgebra(expression = rbind(cbind(A+C+E,A+C), cbind(A+C,A+C+E)), name = "expCovMZ")
covDZ <- mxAlgebra(expression = rbind(cbind(A+C+E,0.5%x%A+C),cbind(0.5%x%A+C,A+C+E)),	name = "expCovDZ")

# Data objects for Multiple Groups
dataMZ <-mxData(observed = dat.twin.MZ, type = "raw")
dataDZ <-mxData(observed = dat.twin.DZ, type = "raw")

fitFunction <- mxFitFunctionML()
```

## Social isolation 

### Age 12

**First, select which variable list to use: raw, standardised, normalised, or standardised and normalised**

```{r select which variables to use}
# selvars_si12_chosen <- selvars_si12                 # raw
# selvars_si12_chosen <- selvars_si12_z_score         # standardised
# selvars_si12_chosen <- selvars_si12norm             # normalised
# selvars_si12_chosen <- selvars_si12_z_score_norm    # standardised and normalised
  selvars_si12_chosen <- selvars_si12norm_reg         # normalised and regressed sex
```

```{r run age 12 isolation ACE}
# Objective objects for Multiple Groups
objMZ <- mxExpectationNormal(covariance = "expCovMZ", means = "expMeanMZ", dimnames = selvars_si12_chosen)
objDZ <- mxExpectationNormal(covariance = "expCovDZ", means = "expMeanDZ", dimnames = selvars_si12_chosen)

# Combine Groups
pars <- list(pathA, pathC, pathE, covA, covC, covE, covP, sd, stpathA, stpathC, stpathE, stcovA, stcovC, stcovE, fitFunction)

# MZ and DZ models
modelMZ	<- mxModel(pars, MeanMZ, covMZ, dataMZ, objMZ, name = "MZ")
modelDZ	<- mxModel(pars, MeanDZ, covDZ, dataDZ, objDZ, name = "DZ")

# Fitting
minus2ll	<- mxAlgebra(expression = MZ.objective + DZ.objective, name = "m2LL")
obj	    	<- mxFitFunctionAlgebra("m2LL")
Conf	  	<- mxCI(c('ACE.h2', 'ACE.c2', 'ACE.e2'))

# Model
ACEModel <- mxModel("ACE", pars, modelMZ, modelDZ, minus2ll, obj, Conf) 

# Run
ACEFit_isolation12 <- mxRun(ACEModel, intervals = TRUE)
isolation12_estimates <- summary(ACEFit_isolation12)

# Table
isolation12_table <- ACE_esitmates_table(
  data = isolation12_estimates, 
  variable = "Social isolation",
  age = "12")

isolation12_table
```

raw: 
Social isolation	12	h2	0.421	
Social isolation	12	c2	0.000	
Social isolation	12	e2	0.579	

standardized:
Social isolation	12	h2	0.421	
Social isolation	12	c2	0.000	
Social isolation	12	e2	0.579	

normalised:
Social isolation	12	h2	0.421
Social isolation	12	c2	0.000
Social isolation	12	e2	0.579

normalised and sex regressed:
Social isolation	12	h2	0.419
Social isolation	12	c2	0.000
Social isolation	12	e2	0.581

### Age 18

```{r select which variables to use}
# selvars_si18_chosen <- selvars_si18                 # raw
# selvars_si18_chosen <- selvars_si18_z_score         # standardised
# selvars_si18_chosen <- selvars_si18norm             # normalised
# selvars_si18_chosen <- selvars_si18_z_score_norm    # standardised and normalised
  selvars_si18_chosen <- selvars_si18norm_reg         # normalised and regressed sex
```

```{r run age 18 isolation ACE}
# Objective objects for Multiple Groups
objMZ <- mxExpectationNormal(covariance = "expCovMZ", means = "expMeanMZ", dimnames = selvars_si18_chosen)
objDZ <- mxExpectationNormal(covariance = "expCovDZ", means = "expMeanDZ", dimnames = selvars_si18_chosen)

# Combine Groups
pars <- list(pathA, pathC, pathE, covA, covC, covE, covP, sd, stpathA, stpathC, stpathE, stcovA, stcovC, stcovE, fitFunction)

# MZ and DZ models
modelMZ	<- mxModel(pars, MeanMZ, covMZ, dataMZ, objMZ, name = "MZ")
modelDZ	<- mxModel(pars, MeanDZ, covDZ, dataDZ, objDZ, name = "DZ")

# Fitting
minus2ll	<- mxAlgebra(expression = MZ.objective + DZ.objective, name = "m2LL")
obj	    	<- mxFitFunctionAlgebra("m2LL")
Conf	  	<- mxCI(c('ACE.h2', 'ACE.c2', 'ACE.e2'))

# Model
ACEModel <- mxModel("ACE", pars, modelMZ, modelDZ, minus2ll, obj, Conf) 

# Run
ACEFit_isolation18 <- mxRun(ACEModel, intervals = TRUE)
isolation18_estimates <- summary(ACEFit_isolation18)

# Table
isolation18_table <- ACE_esitmates_table(
  data = isolation18_estimates, 
  variable = "Social isolation",
  age = "18")

isolation18_table
```

raw:
Social isolation	18	h2	0.4575
Social isolation	18	c2	0.0000
Social isolation	18	e2	0.5425

standardised:
Social isolation	18	h2	0.4575
Social isolation	18	c2	0.0000
Social isolation	18	e2	0.5425

normalised:
Social isolation	18	h2	0.4575
Social isolation	18	c2	0.0000
Social isolation	18	e2	0.5425

normalised and sex regressed:
Social isolation	18	h2	0.45
Social isolation	18	c2	0.00
Social isolation	18	e2	0.55

## Anxiety

### Age 12

```{r select which variables to use}
# selvars_anx12_chosen <- selvars_anx12                 # raw
# selvars_anx12_chosen <- selvars_anx12_z_score         # standardised
# selvars_anx12_chosen <- selvars_anx12norm             # normalised
# selvars_anx12_chosen <- selvars_anx12_z_score_norm    # standardised and normalised
  selvars_anx12_chosen <- selvars_anx12norm_reg         # normalised and regressed sex
```

```{r run age 12 anxiety ACE}
# Objective objects for Multiple Groups
objMZ <- mxExpectationNormal(covariance = "expCovMZ", means = "expMeanMZ", dimnames = selvars_anx12_chosen)
objDZ <- mxExpectationNormal(covariance = "expCovDZ", means = "expMeanDZ", dimnames = selvars_anx12_chosen)

# Combine Groups
pars <- list(pathA, pathC, pathE, covA, covC, covE, covP, sd, stpathA, stpathC, stpathE, stcovA, stcovC, stcovE, fitFunction)

# MZ and DZ models
modelMZ	<- mxModel(pars, MeanMZ, covMZ, dataMZ, objMZ, name = "MZ")
modelDZ	<- mxModel(pars, MeanDZ, covDZ, dataDZ, objDZ, name = "DZ")

# Fitting
minus2ll	<- mxAlgebra(expression = MZ.objective + DZ.objective, name = "m2LL")
obj	    	<- mxFitFunctionAlgebra("m2LL")
Conf	  	<- mxCI(c('ACE.h2', 'ACE.c2', 'ACE.e2'))

# Model
ACEModel <- mxModel("ACE", pars, modelMZ, modelDZ, minus2ll, obj, Conf) 

# Run
ACEFit_anxiety12 <- mxRun(ACEModel, intervals = TRUE)
anxiety12_estimates <- summary(ACEFit_anxiety12)

# Table
anxiety12_table <- ACE_esitmates_table(
  data = anxiety12_estimates, 
  variable = "Anxiety",
  age = "12")

anxiety12_table
```

raw:
Anxiety	12	h2	0.289
Anxiety	12	c2	0.112
Anxiety	12	e2	0.600	

standardised:
Anxiety	12	h2	0.289
Anxiety	12	c2	0.112
Anxiety	12	e2	0.600	

normalised:
Anxiety	12	h2	0.270
Anxiety	12	c2	0.114
Anxiety	12	e2	0.615

normalised and sex regressed:
Anxiety	12	h2	0.272
Anxiety	12	c2	0.100
Anxiety	12	e2	0.628

### Age 18

```{r select which variables to use}
# selvars_anx18_chosen <- selvars_anx18                 # raw
# selvars_anx18_chosen <- selvars_anx18_z_score         # standardised
# selvars_anx18_chosen <- selvars_anx18norm             # normalised
# selvars_anx18_chosen <- selvars_anx18_z_score_norm    # standardised and normalised
  selvars_anx18_chosen <- selvars_anx18norm_reg         # normalised and regressed sex
```

```{r run age 18 anxiety ACE}
# Objective objects for Multiple Groups
objMZ <- mxExpectationNormal(covariance = "expCovMZ", means = "expMeanMZ", dimnames = selvars_anx18_chosen)
objDZ <- mxExpectationNormal(covariance = "expCovDZ", means = "expMeanDZ", dimnames = selvars_anx18_chosen)

# Combine Groups
pars <- list(pathA, pathC, pathE, covA, covC, covE, covP, sd, stpathA, stpathC, stpathE, stcovA, stcovC, stcovE, fitFunction)

# MZ and DZ models
modelMZ	<- mxModel(pars, MeanMZ, covMZ, dataMZ, objMZ, name = "MZ")
modelDZ	<- mxModel(pars, MeanDZ, covDZ, dataDZ, objDZ, name = "DZ")

# Fitting
minus2ll	<- mxAlgebra(expression = MZ.objective + DZ.objective, name = "m2LL")
obj	    	<- mxFitFunctionAlgebra("m2LL")
Conf	  	<- mxCI(c('ACE.h2', 'ACE.c2', 'ACE.e2'))

# Model
ACEModel <- mxModel("ACE", pars, modelMZ, modelDZ, minus2ll, obj, Conf) 

# Run
ACEFit_anxiety18 <- mxRun(ACEModel, intervals = TRUE)
anxiety18_estimates <- summary(ACEFit_anxiety18)

# Table
anxiety18_table <- ACE_esitmates_table(
  data = anxiety18_estimates, 
  variable = "Anxiety",
  age = "18")

anxiety18_table
```

raw:
Anxiety	18	h2	0.255
Anxiety	18	c2	0.000
Anxiety	18	e2	0.745

standardised:
Anxiety	18	h2	0.255
Anxiety	18	c2	0.000
Anxiety	18	e2	0.745

normalised:
Anxiety	18	h2	0.255
Anxiety	18	c2	0.000
Anxiety	18	e2	0.745	

normalised and sex regressed:
Anxiety	18	h2	0.235
Anxiety	18	c2	0.000
Anxiety	18	e2	0.765	

## Depression

### Age 12

```{r select which variables to use}
# selvars_dep12_chosen <- selvars_dep12                 # raw
# selvars_dep12_chosen <- selvars_dep12_z_score         # standardised
# selvars_dep12_chosen <- selvars_dep12norm             # normalised
# selvars_dep12_chosen <- selvars_dep12_z_score_norm    # standardised and normalised
  selvars_dep12_chosen <- selvars_dep12norm_reg         # normalised and regressed sex
```

```{r run age 12 depression ACE}
# Objective objects for Multiple Groups
objMZ <- mxExpectationNormal(covariance = "expCovMZ", means = "expMeanMZ", dimnames = selvars_dep12_chosen)
objDZ <- mxExpectationNormal(covariance = "expCovDZ", means = "expMeanDZ", dimnames = selvars_dep12_chosen)

# Combine Groups
pars <- list(pathA, pathC, pathE, covA, covC, covE, covP, sd, stpathA, stpathC, stpathE, stcovA, stcovC, stcovE, fitFunction)

# MZ and DZ models
modelMZ	<- mxModel(pars, MeanMZ, covMZ, dataMZ, objMZ, name = "MZ")
modelDZ	<- mxModel(pars, MeanDZ, covDZ, dataDZ, objDZ, name = "DZ")

# Fitting
minus2ll	<- mxAlgebra(expression = MZ.objective + DZ.objective, name = "m2LL")
obj	    	<- mxFitFunctionAlgebra("m2LL")
Conf	  	<- mxCI(c('ACE.h2', 'ACE.c2', 'ACE.e2'))

# Model
ACEModel <- mxModel("ACE", pars, modelMZ, modelDZ, minus2ll, obj, Conf) 

# Run
ACEFit_depression12 <- mxRun(ACEModel, intervals = TRUE)
depression12_estimates <- summary(ACEFit_depression12)

# Table
depression12_table <- ACE_esitmates_table(
  data = depression12_estimates, 
  variable = "Depression",
  age = "12")
depression12_table
```

raw:
Depression	12	h2	0.294
Depression	12	c2	0.018
Depression	12	e2	0.687	

standardised:
Depression	12	h2	0.294
Depression	12	c2	0.018
Depression	12	e2	0.687	

normalised:
Depression	12	h2	0.210
Depression	12	c2	0.147
Depression	12	e2	0.643	

normalised and sex regressed:
Depression	12	h2	0.211
Depression	12	c2	0.146
Depression	12	e2	0.643	

### Age 18

```{r select which variables to use}
# selvars_dep18_chosen <- selvars_dep18                 # raw
# selvars_dep18_chosen <- selvars_dep18_z_score         # standardised
# selvars_dep18_chosen <- selvars_dep18norm             # normalised
# selvars_dep18_chosen <- selvars_dep18_z_score_norm    # standardised and normalised
  selvars_dep18_chosen <- selvars_dep18norm_reg         # normalised and regressed sex
```

```{r run age 18 depression ACE}
# Objective objects for Multiple Groups
objMZ <- mxExpectationNormal(covariance = "expCovMZ", means = "expMeanMZ", dimnames = selvars_dep18_chosen)
objDZ <- mxExpectationNormal(covariance = "expCovDZ", means = "expMeanDZ", dimnames = selvars_dep18_chosen)

# Combine Groups
pars <- list(pathA, pathC, pathE, covA, covC, covE, covP, sd, stpathA, stpathC, stpathE, stcovA, stcovC, stcovE, fitFunction)

# MZ and DZ models
modelMZ	<- mxModel(pars, MeanMZ, covMZ, dataMZ, objMZ, name = "MZ")
modelDZ	<- mxModel(pars, MeanDZ, covDZ, dataDZ, objDZ, name = "DZ")

# Fitting
minus2ll	<- mxAlgebra(expression = MZ.objective + DZ.objective, name = "m2LL")
obj	    	<- mxFitFunctionAlgebra("m2LL")
Conf	  	<- mxCI(c('ACE.h2', 'ACE.c2', 'ACE.e2'))

# Model
ACEModel <- mxModel("ACE", pars, modelMZ, modelDZ, minus2ll, obj, Conf) 

# Run
ACEFit_depression18 <- mxRun(ACEModel, intervals = TRUE)
depression18_estimates <- summary(ACEFit_depression18)

# Table
depression18_table <- ACE_esitmates_table(
  data = depression18_estimates, 
  variable = "Depression",
  age = "18")
depression18_table
```

raw:
Depression	18	h2	0.318
Depression	18	c2	0.000
Depression	18	e2	0.682

standardised:
Depression	18	h2	0.318
Depression	18	c2	0.000
Depression	18	e2	0.682	

normalised:
Depression	18	h2	0.325
Depression	18	c2	0.000
Depression	18	e2	0.675

normalised and sex regressed:
Depression	18	h2	0.315
Depression	18	c2	0.000
Depression	18	e2	0.685

## Conduct disorder

### Age 12

```{r select which variables to use}
# selvars_con12_chosen <- selvars_con12                 # raw
# selvars_con12_chosen <- selvars_con12_z_score         # standardised
# selvars_con12_chosen <- selvars_con12norm             # normalised
# selvars_con12_chosen <- selvars_con12_z_score_norm    # standardised and normalised
  selvars_con12_chosen <- selvars_con12norm_reg         # normalised and regressed sex
```

```{r run age 12 conduct ACE}
# Objective objects for Multiple Groups
objMZ <- mxExpectationNormal(covariance = "expCovMZ", means = "expMeanMZ", dimnames = selvars_con12_chosen)
objDZ <- mxExpectationNormal(covariance = "expCovDZ", means = "expMeanDZ", dimnames = selvars_con12_chosen)

# Combine Groups
pars <- list(pathA, pathC, pathE, covA, covC, covE, covP, sd, stpathA, stpathC, stpathE, stcovA, stcovC, stcovE, fitFunction)

# MZ and DZ models
modelMZ	<- mxModel(pars, MeanMZ, covMZ, dataMZ, objMZ, name = "MZ")
modelDZ	<- mxModel(pars, MeanDZ, covDZ, dataDZ, objDZ, name = "DZ")

# Fitting
minus2ll	<- mxAlgebra(expression = MZ.objective + DZ.objective, name = "m2LL")
obj	    	<- mxFitFunctionAlgebra("m2LL")
Conf	  	<- mxCI(c('ACE.h2', 'ACE.c2', 'ACE.e2'))

# Model
ACEModel <- mxModel("ACE", pars, modelMZ, modelDZ, minus2ll, obj, Conf) 

# Run
ACEFit_conduct12 <- mxRun(ACEModel, intervals = TRUE)
conduct12_estimates <- summary(ACEFit_conduct12)

# Table
conduct12_table <- ACE_esitmates_table(
  data = conduct12_estimates, 
  variable = "Conduct disorder",
  age = "12")
conduct12_table
```

raw:
Conduct disorder	12	h2	0.137
Conduct disorder	12	c2	0.343
Conduct disorder	12	e2	0.519

standardised:
Conduct disorder	12	h2	0.137
Conduct disorder	12	c2	0.343
Conduct disorder	12	e2	0.519

normalised:
Conduct disorder	12	h2	0.187
Conduct disorder	12	c2	0.272
Conduct disorder	12	e2	0.541

normalised and sex regressed:
Conduct disorder	12	h2	0.197
Conduct disorder	12	c2	0.249
Conduct disorder	12	e2	0.554	

### Age 18

```{r select which variables to use}
# selvars_con18_chosen <- selvars_con18                 # raw
# selvars_con18_chosen <- selvars_con18_z_score         # standardised
# selvars_con18_chosen <- selvars_con18norm             # normalised
# selvars_con18_chosen <- selvars_con18_z_score_norm    # standardised and normalised
  selvars_con18_chosen <- selvars_con18norm_reg         # normalised and regressed sex
```

```{r run age 18 conduct ACE}
# Objective objects for Multiple Groups
objMZ <- mxExpectationNormal(covariance = "expCovMZ", means = "expMeanMZ", dimnames = selvars_con18_chosen)
objDZ <- mxExpectationNormal(covariance = "expCovDZ", means = "expMeanDZ", dimnames = selvars_con18_chosen)

# Combine Groups
pars <- list(pathA, pathC, pathE, covA, covC, covE, covP, sd, stpathA, stpathC, stpathE, stcovA, stcovC, stcovE, fitFunction)

# MZ and DZ models
modelMZ	<- mxModel(pars, MeanMZ, covMZ, dataMZ, objMZ, name = "MZ")
modelDZ	<- mxModel(pars, MeanDZ, covDZ, dataDZ, objDZ, name = "DZ")

# Fitting
minus2ll	<- mxAlgebra(expression = MZ.objective + DZ.objective, name = "m2LL")
obj	    	<- mxFitFunctionAlgebra("m2LL")
Conf	  	<- mxCI(c('ACE.h2', 'ACE.c2', 'ACE.e2'))

# Model
ACEModel <- mxModel("ACE", pars, modelMZ, modelDZ, minus2ll, obj, Conf) 

# Run
ACEFit_conduct18 <- mxRun(ACEModel, intervals = TRUE)
conduct18_estimates <- summary(ACEFit_conduct18)

# Table
conduct18_table <- ACE_esitmates_table(
  data = conduct18_estimates, 
  variable = "Conduct disorder",
  age = "18")
conduct18_table
```

raw:
Conduct disorder	18	h2	0.209
Conduct disorder	18	c2	0.308
Conduct disorder	18	e2	0.483	

standardised:
Conduct disorder	18	h2	0.209
Conduct disorder	18	c2	0.308
Conduct disorder	18	e2	0.483	

normalised:
Conduct disorder	18	h2	0.184
Conduct disorder	18	c2	0.310
Conduct disorder	18	e2	0.506	

normalised and sex regressed:
Conduct disorder	18	h2	0.195
Conduct disorder	18	c2	0.270
Conduct disorder	18	e2	0.535	

## Psychotic experiences

### Age 12

```{r select which variables to use}
# selvars_psy12_chosen <- selvars_psy12                 # raw
# selvars_psy12_chosen <- selvars_psy12_z_score         # standardised
# selvars_psy12_chosen <- selvars_psy12norm             # normalised
# selvars_psy12_chosen <- selvars_psy12_z_score_norm    # standardised and normalised
  selvars_psy12_chosen <- selvars_psy12norm_reg         # normalised and regressed sex
```

```{r run age 12 psychosis ACE}
# Objective objects for Multiple Groups
objMZ <- mxExpectationNormal(covariance = "expCovMZ", means = "expMeanMZ", dimnames = selvars_psy12_chosen)
objDZ <- mxExpectationNormal(covariance = "expCovDZ", means = "expMeanDZ", dimnames = selvars_psy12_chosen)

# Combine Groups
pars <- list(pathA, pathC, pathE, covA, covC, covE, covP, sd, stpathA, stpathC, stpathE, stcovA, stcovC, stcovE, fitFunction)

# MZ and DZ models
modelMZ	<- mxModel(pars, MeanMZ, covMZ, dataMZ, objMZ, name = "MZ")
modelDZ	<- mxModel(pars, MeanDZ, covDZ, dataDZ, objDZ, name = "DZ")

# Fitting
minus2ll	<- mxAlgebra(expression = MZ.objective + DZ.objective, name = "m2LL")
obj	    	<- mxFitFunctionAlgebra("m2LL")
Conf	  	<- mxCI(c('ACE.h2', 'ACE.c2', 'ACE.e2'))

# Model
ACEModel <- mxModel("ACE", pars, modelMZ, modelDZ, minus2ll, obj, Conf) 

# Run
ACEFit_psychosis12 <- mxRun(ACEModel, intervals = TRUE)
psychosis12_estimates <- summary(ACEFit_psychosis12)

# Table
psychosis12_table <- ACE_esitmates_table(
  data = psychosis12_estimates, 
  variable = "Psychosis",
  age = "12")
psychosis12_table
```

raw:
Psychosis	12	h2	0.108
Psychosis	12	c2	0.185
Psychosis	12	e2	0.708	

standardised:
Psychosis	12	h2	0.108
Psychosis	12	c2	0.185
Psychosis	12	e2	0.708	

normalised:
Psychosis	12	h2	0.108
Psychosis	12	c2	0.185
Psychosis	12	e2	0.708	

normalised and sex regressed:
Psychosis	12	h2	0.135
Psychosis	12	c2	0.149
Psychosis	12	e2	0.716	

### Age 18

```{r select which variables to use}
# selvars_psy18_chosen <- selvars_psy18                 # raw
# selvars_psy18_chosen <- selvars_psy18_z_score         # standardised
# selvars_psy18_chosen <- selvars_psy18norm             # normalised
# selvars_psy18_chosen <- selvars_psy18_z_score_norm    # standardised and normalised
  selvars_psy18_chosen <- selvars_psy18norm_reg         # normalised and regressed sex
```

```{r run age 18 psychosis ACE}
# Objective objects for Multiple Groups
objMZ <- mxExpectationNormal(covariance = "expCovMZ", means = "expMeanMZ", dimnames = selvars_psy18_chosen)
objDZ <- mxExpectationNormal(covariance = "expCovDZ", means = "expMeanDZ", dimnames = selvars_psy18_chosen)

# Combine Groups
pars <- list(pathA, pathC, pathE, covA, covC, covE, covP, sd, stpathA, stpathC, stpathE, stcovA, stcovC, stcovE, fitFunction)

# MZ and DZ models
modelMZ	<- mxModel(pars, MeanMZ, covMZ, dataMZ, objMZ, name = "MZ")
modelDZ	<- mxModel(pars, MeanDZ, covDZ, dataDZ, objDZ, name = "DZ")

# Fitting
minus2ll	<- mxAlgebra(expression = MZ.objective + DZ.objective, name = "m2LL")
obj	    	<- mxFitFunctionAlgebra("m2LL")
Conf	  	<- mxCI(c('ACE.h2', 'ACE.c2', 'ACE.e2'))

# Model
ACEModel <- mxModel("ACE", pars, modelMZ, modelDZ, minus2ll, obj, Conf) 

# Run
ACEFit_psychosis18 <- mxRun(ACEModel, intervals = TRUE)
psychosis18_estimates <- summary(ACEFit_psychosis18)

# Table 
psychosis18_table <- ACE_esitmates_table(
  data = psychosis18_estimates, 
  variable = "Psychosis",
  age = "18")
psychosis18_table
```

raw:
Psychosis	18	h2	0.237
Psychosis	18	c2	0.043
Psychosis	18	e2	0.720

standardised:
Psychosis	18	h2	0.237
Psychosis	18	c2	0.043
Psychosis	18	e2	0.720

normalised:
Psychosis	18	h2	0.237	
Psychosis	18	c2	0.043	
Psychosis	18	e2	0.720	

normalised and sex regressed:
Psychosis	18	h2	0.237	
Psychosis	18	c2	0.042	
Psychosis	18	e2	0.721	

## All ACE estimates

```{r ACE estimates table for all variables}
ACE_estimates <- rbind(isolation12_table,
                     # anxiety12_table,
                     depression12_table,
                     conduct12_table,
                     psychosis12_table, 
                     isolation18_table,
                     depression18_table,
                     # anxiety18_table,
                     conduct18_table,
                     psychosis18_table) 

ACE_estimates %>%
  filter(ACE == "e2")
```

# Multivariate correlated factors

## Age 12 variables 

Here we will run a correlated factors model on all the age 12 variables (without anxiety)

```{r number of variables (phenotypes)}
# number of variables
nv <- 4    					      # number of variables 
ntv <- nv*2 				      # number of twin variables

# default optimizer 
mxOption(NULL, "Default optimizer", "CSOLNP")

selvars_chosen <- c("sisoe12norm_reg", "cdie12norm_reg", "conec12norm_reg", "psysympe12norm_reg",
                    "sisoy12norm_reg", "cdiy12norm_reg", "conyc12norm_reg", "psysympy12norm_reg")
```

```{r start values}
# start values
svM	  <- c(rep(0.7, ntv))	  # means               
svSD  <- c(rep(1.1, ntv))   # standard deviations
svRmz <- c(rep(0.3, 6))     # correlations for MZ
svRdz <- c(rep(0.15, 6))    # correlations for DZ 

rowVars	<- rep('Vars', nv)                          
colVars	<- rep(c('h2', 'c2', 'e2'), each = nv)

# labels
means_4var <- c("m1", "m2", "m3", "m4", "m1", "m2", "m3", "m4")	        
patha_4var <- c("a11", "a21","a31","a41","a22","a32","a42","a33","a43","a44")
pathc_4var <- c("c11", "c21","c31","c41","c22","c32","c42","c33","c43","c44")
pathe_4var <- c("e11", "e21","e31","e41","e22","e32","e42","e33","e43","e44")
```

```{r model estimation}
pathA	<- mxMatrix(type = "Lower", nrow = nv, ncol = nv, free = TRUE, values = c(rep(0.5, 10)), labels = patha_4var, name = "a")
pathC	<- mxMatrix(type = "Lower", nrow = nv, ncol = nv, free = TRUE, values = c(rep(0.5, 10)), labels = pathc_4var, name = "c")
pathE	<- mxMatrix(type = "Lower", nrow = nv, ncol = nv, free = TRUE, values = c(rep(0.5, 10)), labels = pathe_4var, name = "e")

MeanG	<- mxMatrix(type = "Full", nrow = 1, ncol = ntv, free = TRUE, values = svM, labels = means_4var, name = "ExpMean")

# Non-standardized variance components
covA	<- mxAlgebra(expression = a %*% t(a), name = "A")
covC	<- mxAlgebra(expression = c %*% t(c), name = "C") 
covE	<- mxAlgebra(expression = e %*% t(e), name = "E")

# Standardized variance components
covP <- mxAlgebra(expression = A + C + E, name = "V" )  # total variance in the phenotype
StA	<- mxAlgebra(expression = A/V, name = "h2")         # proportion of variance explained by additive genetic factors
StC	<- mxAlgebra(expression = C/V, name = "c2")         # proportion of variance explained by shared environment
StE	<- mxAlgebra(expression = E/V, name = "e2")         # proportion of variance explained by unique environment

matI <- mxMatrix(type = "Iden", nrow = nv, ncol = nv, name = "I")
# matIsd <-mxAlgebra(solve(sqrt(I*V)), name = "isd") # extracting the variances from the diagonal of the covariance matrix V 
rph	<- mxAlgebra(expression = solve(sqrt(I*V)) %*% V %*% solve(sqrt(I*V)), name = "Rph") # new identity matrix for standardising 
rA	<- mxAlgebra(expression = solve(sqrt(I*A)) %*% A %*% solve(sqrt(I*A)), name = "Ra")
rC	<- mxAlgebra(expression = solve(sqrt(I*C)) %*% C %*% solve(sqrt(I*C)), name = "Rc") 
rE	<- mxAlgebra(expression = solve(sqrt(I*E)) %*% E %*% solve(sqrt(I*E)), name = "Re")

rphace <- mxAlgebra(expression = cbind((sqrt(h2[1,1])*Ra[2,1]*sqrt(h2[2,2])),  # path tracing var1 to var2 A
                                       (sqrt(h2[1,1])*Ra[3,1]*sqrt(h2[3,3])),  # path tracing var1 to var3 A
                                       (sqrt(h2[1,1])*Ra[4,1]*sqrt(h2[4,4])),  # path tracing var1 to var4 A
                                       (sqrt(h2[2,2])*Ra[3,2]*sqrt(h2[3,3])),  # path tracing var2 to var3 A
                                       (sqrt(h2[2,2])*Ra[4,2]*sqrt(h2[4,4])),  # path tracing var2 to var4 A
                                       (sqrt(h2[3,3])*Ra[4,3]*sqrt(h2[4,4])),  # path tracing var3 to var4 A
                                       
                                       (sqrt(c2[1,1])*Rc[2,1]*sqrt(c2[2,2])),  # path tracing var1 to var2 C
                                       (sqrt(c2[1,1])*Rc[3,1]*sqrt(c2[3,3])),  # path tracing var1 to var3 C
                                       (sqrt(c2[1,1])*Rc[4,1]*sqrt(c2[4,4])),  # path tracing var1 to var4 C
                                       (sqrt(c2[2,2])*Rc[3,2]*sqrt(c2[3,3])),  # path tracing var2 to var3 C
                                       (sqrt(c2[2,2])*Rc[4,2]*sqrt(c2[4,4])),  # path tracing var2 to var4 C
                                       (sqrt(c2[3,3])*Rc[4,3]*sqrt(c2[4,4])),  # path tracing var3 to var4 C
                                       
                                       (sqrt(e2[1,1])*Re[2,1]*sqrt(e2[2,2])),  # path tracing var1 to var2 E
                                       (sqrt(e2[1,1])*Re[3,1]*sqrt(e2[3,3])),  # path tracing var1 to var3 E
                                       (sqrt(e2[1,1])*Re[4,1]*sqrt(e2[4,4])),  # path tracing var1 to var4 E
                                       (sqrt(e2[2,2])*Re[3,2]*sqrt(e2[3,3])),  # path tracing var2 to var3 E
                                       (sqrt(e2[2,2])*Re[4,2]*sqrt(e2[4,4])),  # path tracing var2 to var4 E
                                       (sqrt(e2[3,3])*Re[4,3]*sqrt(e2[4,4]))   # path tracing var3 to var4 E
                                       ), 
                    name = "RphACE" )

# standardise estimates
#estVars	<- mxAlgebra(expression = cbind(h2, c2, e2), name = "Est", dimnames = list(rowVars,colVars)) # is this needed?

# expected variance/covariance matrices
covMZ	<- mxAlgebra(expression = rbind(cbind(A+C+E, A+C),
                                          cbind(A+C, A+C+E)), name = "expCovMZ" )
covDZ	<- mxAlgebra(expression = rbind(cbind(A+C+E, 0.5%x%A+C),
                                          cbind(0.5%x%A+C, A+C+E)), name = "expCovDZ" )

# data objects 
dataMZ <- mxData(observed = dat.twin.MZ, type = "raw")
dataDZ <- mxData(observed = dat.twin.DZ, type = "raw")

fitFunction <- mxFitFunctionML()
```

```{r ACE confidence intervals}
# h2, c2, e2 
Conf1	<- mxCI(c('h2[1,1]', 'h2[2,2]','h2[3,3]', 'h2[4,4]', 'c2[1,1]', 'c2[2,2]', 'c2[3,3]', 'c2[4,4]', 'e2[1,1]', 'e2[2,2]', 'e2[3,3]', 'e2[4,4]'))
# factor correlation - off-diagonal
Conf2	<- mxCI(c('Rph[2,1]', 'Ra[2,1]', 'Rc[2,1]', 'Re[2,1]', 'Rph[3,1]', 'Ra[3,1]', 'Rc[3,1]', 'Re[3,1]', 'Rph[4,1]', 'Ra[4,1]', 'Rc[4,1]', 'Re[4,1]', 'Rph[3,2]', 'Ra[3,2]', 'Rc[3,2]', 'Re[3,2]', 'Rph[4,2]', 'Ra[4,2]', 'Rc[4,2]', 'Re[4,2]', 'Rph[4,3]', 'Ra[4,3]', 'Rc[4,3]', 'Re[4,3]')) 
```

```{r ACE model estimation}
# enter the variables 
objMZ	<- mxExpectationNormal(covariance = "expCovMZ", means = "ExpMean", dimnames = selvars_chosen)
objDZ	<- mxExpectationNormal(covariance = "expCovDZ", means = "ExpMean", dimnames = selvars_chosen)

# all parameters to be estimated 
pars <- list(pathA, pathC, pathE, covA, covC, covE, covP, StA, StC, StE, matI, rph, rA, rC, rE, MeanG, rphace)

# add these to the model for MZ and DZ with the matrices we have created
modelMZ	<- mxModel(pars, covMZ, dataMZ, objMZ, fitFunction, name = "MZ")
modelDZ	<- mxModel(pars, covDZ, dataDZ, objDZ, fitFunction, name = "DZ")

# fitting
minus2ll <- mxAlgebra(expression = MZ.objective + DZ.objective, name = "m2LL")
obj <- mxFitFunctionAlgebra("m2LL")

# full model
AceModel_4var <- mxModel("ACE", pars, modelMZ, modelDZ, minus2ll, obj, Conf1)

# run ACE
AceFit_4var12 <- mxTryHard(AceModel_4var, intervals = TRUE)
```

```{r run ACE model}
# summary - this shows the position in the cells for each matrix 
AceSumm12 <- summary(AceFit_4var12, verbose = TRUE)

# h2 
round(mxEval(ACE.h2, AceFit_4var12), 3) 

# c2
round(mxEval(ACE.c2, AceFit_4var12), 3) 

# e2
round(mxEval(ACE.e2, AceFit_4var12), 3) 

table12 <- as.tibble(AceSumm12$CI) %>%
    mutate(ACE = c(rep("h2", 4), rep("c2", 4), rep("e2", 4))) %>%
    mutate(Variable = rep(c("Isolation12",
                            "Depression12",
                            "Conduct12", 
                            "Psychosis12"), 3)) %>%
    select(Variable, ACE, lbound, estimate, ubound) %>%
    mutate(across(is.numeric, round, digits = 3))

table12
```

## Age 18 variables

Here we will run a correlated factors model on all the age 18 variables (without anxiety)

```{r number of variables (phenotypes)}
# number of variables
nv <- 4    					      # number of variables 
ntv <- nv*2 				      # number of twin variables

# default optimizer 
mxOption(NULL, "Default optimizer", "CSOLNP")

selvars_chosen <- c("socisoe18norm_reg", "mdesxe18norm_reg", "cdsxe18norm_reg", "psyexpe18norm_reg",
                    "socisoy18norm_reg", "mdesxy18norm_reg", "cdsxy18norm_reg", "psyexpy18norm_reg")
```

```{r start values}
# start values
svM	  <- c(rep(0.7, ntv))	  # means               
svSD  <- c(rep(1.1, ntv))   # standard deviations
svRmz <- c(rep(0.3, 6))     # correlations for MZ
svRdz <- c(rep(0.15, 6))    # correlations for DZ 

rowVars	<- rep('Vars', nv)                          
colVars	<- rep(c('h2', 'c2', 'e2'), each = nv)

# labels
means_4var <- c("m1", "m2", "m3", "m4", "m1", "m2", "m3", "m4")	        
patha_4var <- c("a11", "a21","a31","a41","a22","a32","a42","a33","a43","a44")
pathc_4var <- c("c11", "c21","c31","c41","c22","c32","c42","c33","c43","c44")
pathe_4var <- c("e11", "e21","e31","e41","e22","e32","e42","e33","e43","e44")
```

```{r model estimation}
pathA	<- mxMatrix(type = "Lower", nrow = nv, ncol = nv, free = TRUE, values = c(rep(0.5, 10)), labels = patha_4var, name = "a")
pathC	<- mxMatrix(type = "Lower", nrow = nv, ncol = nv, free = TRUE, values = c(rep(0.5, 10)), labels = pathc_4var, name = "c")
pathE	<- mxMatrix(type = "Lower", nrow = nv, ncol = nv, free = TRUE, values = c(rep(0.5, 10)), labels = pathe_4var, name = "e")

MeanG	<- mxMatrix(type = "Full", nrow = 1, ncol = ntv, free = TRUE, values = svM, labels = means_4var, name = "ExpMean")

# Non-standardized variance components
covA	<- mxAlgebra(expression = a %*% t(a), name = "A")
covC	<- mxAlgebra(expression = c %*% t(c), name = "C") 
covE	<- mxAlgebra(expression = e %*% t(e), name = "E")

# Standardized variance components
covP <- mxAlgebra(expression = A + C + E, name = "V" )  # total variance in the phenotype
StA	<- mxAlgebra(expression = A/V, name = "h2")         # proportion of variance explained by additive genetic factors
StC	<- mxAlgebra(expression = C/V, name = "c2")         # proportion of variance explained by shared environment
StE	<- mxAlgebra(expression = E/V, name = "e2")         # proportion of variance explained by unique environment

matI <- mxMatrix(type = "Iden", nrow = nv, ncol = nv, name = "I")
# matIsd <-mxAlgebra(solve(sqrt(I*V)), name = "isd") # extracting the variances from the diagonal of the covariance matrix V 
rph	<- mxAlgebra(expression = solve(sqrt(I*V)) %*% V %*% solve(sqrt(I*V)), name = "Rph") # new identity matrix for standardising 
rA	<- mxAlgebra(expression = solve(sqrt(I*A)) %*% A %*% solve(sqrt(I*A)), name = "Ra")
rC	<- mxAlgebra(expression = solve(sqrt(I*C)) %*% C %*% solve(sqrt(I*C)), name = "Rc") 
rE	<- mxAlgebra(expression = solve(sqrt(I*E)) %*% E %*% solve(sqrt(I*E)), name = "Re")

rphace <- mxAlgebra(expression = cbind((sqrt(h2[1,1])*Ra[2,1]*sqrt(h2[2,2])),  # path tracing var1 to var2 A
                                       (sqrt(h2[1,1])*Ra[3,1]*sqrt(h2[3,3])),  # path tracing var1 to var3 A
                                       (sqrt(h2[1,1])*Ra[4,1]*sqrt(h2[4,4])),  # path tracing var1 to var4 A
                                       (sqrt(h2[2,2])*Ra[3,2]*sqrt(h2[3,3])),  # path tracing var2 to var3 A
                                       (sqrt(h2[2,2])*Ra[4,2]*sqrt(h2[4,4])),  # path tracing var2 to var4 A
                                       (sqrt(h2[3,3])*Ra[4,3]*sqrt(h2[4,4])),  # path tracing var3 to var4 A
                                       
                                       (sqrt(c2[1,1])*Rc[2,1]*sqrt(c2[2,2])),  # path tracing var1 to var2 C
                                       (sqrt(c2[1,1])*Rc[3,1]*sqrt(c2[3,3])),  # path tracing var1 to var3 C
                                       (sqrt(c2[1,1])*Rc[4,1]*sqrt(c2[4,4])),  # path tracing var1 to var4 C
                                       (sqrt(c2[2,2])*Rc[3,2]*sqrt(c2[3,3])),  # path tracing var2 to var3 C
                                       (sqrt(c2[2,2])*Rc[4,2]*sqrt(c2[4,4])),  # path tracing var2 to var4 C
                                       (sqrt(c2[3,3])*Rc[4,3]*sqrt(c2[4,4])),  # path tracing var3 to var4 C
                                       
                                       (sqrt(e2[1,1])*Re[2,1]*sqrt(e2[2,2])),  # path tracing var1 to var2 E
                                       (sqrt(e2[1,1])*Re[3,1]*sqrt(e2[3,3])),  # path tracing var1 to var3 E
                                       (sqrt(e2[1,1])*Re[4,1]*sqrt(e2[4,4])),  # path tracing var1 to var4 E
                                       (sqrt(e2[2,2])*Re[3,2]*sqrt(e2[3,3])),  # path tracing var2 to var3 E
                                       (sqrt(e2[2,2])*Re[4,2]*sqrt(e2[4,4])),  # path tracing var2 to var4 E
                                       (sqrt(e2[3,3])*Re[4,3]*sqrt(e2[4,4]))   # path tracing var3 to var4 E
                                       ), 
                    name = "RphACE" )

# standardise estimates
#estVars	<- mxAlgebra(expression = cbind(h2, c2, e2), name = "Est", dimnames = list(rowVars,colVars)) # is this needed?

# expected variance/covariance matrices
covMZ	<- mxAlgebra(expression = rbind(cbind(A+C+E, A+C),
                                          cbind(A+C, A+C+E)), name = "expCovMZ" )
covDZ	<- mxAlgebra(expression = rbind(cbind(A+C+E, 0.5%x%A+C),
                                          cbind(0.5%x%A+C, A+C+E)), name = "expCovDZ" )

# data objects 
dataMZ <- mxData(observed = dat.twin.MZ, type = "raw")
dataDZ <- mxData(observed = dat.twin.DZ, type = "raw")

fitFunction <- mxFitFunctionML()
```

```{r ACE confidence intervals}
# h2, c2, e2 
Conf1	<- mxCI(c('h2[1,1]', 'h2[2,2]','h2[3,3]', 'h2[4,4]', 'c2[1,1]', 'c2[2,2]', 'c2[3,3]', 'c2[4,4]', 'e2[1,1]', 'e2[2,2]', 'e2[3,3]', 'e2[4,4]'))
# factor correlation - off-diagonal
Conf2	<- mxCI(c('Rph[2,1]', 'Ra[2,1]', 'Rc[2,1]', 'Re[2,1]', 'Rph[3,1]', 'Ra[3,1]', 'Rc[3,1]', 'Re[3,1]', 'Rph[4,1]', 'Ra[4,1]', 'Rc[4,1]', 'Re[4,1]', 'Rph[3,2]', 'Ra[3,2]', 'Rc[3,2]', 'Re[3,2]', 'Rph[4,2]', 'Ra[4,2]', 'Rc[4,2]', 'Re[4,2]', 'Rph[4,3]', 'Ra[4,3]', 'Rc[4,3]', 'Re[4,3]')) 
```

```{r ACE model estimation}
# enter the variables 
objMZ	<- mxExpectationNormal(covariance = "expCovMZ", means = "ExpMean", dimnames = selvars_chosen)
objDZ	<- mxExpectationNormal(covariance = "expCovDZ", means = "ExpMean", dimnames = selvars_chosen)

# all parameters to be estimated 
pars <- list(pathA, pathC, pathE, covA, covC, covE, covP, StA, StC, StE, matI, rph, rA, rC, rE, MeanG, rphace)

# add these to the model for MZ and DZ with the matrices we have created
modelMZ	<- mxModel(pars, covMZ, dataMZ, objMZ, fitFunction, name = "MZ")
modelDZ	<- mxModel(pars, covDZ, dataDZ, objDZ, fitFunction, name = "DZ")

# fitting
minus2ll <- mxAlgebra(expression = MZ.objective + DZ.objective, name = "m2LL")
obj <- mxFitFunctionAlgebra("m2LL")

# full model
AceModel_4var18 <- mxModel("ACE", pars, modelMZ, modelDZ, minus2ll, obj, Conf1)

# run ACE
AceFit_4var18 <- mxTryHard(AceModel_4var18, intervals = TRUE)
```

```{r run ACE model}
# summary - this shows the position in the cells for each matrix 
AceSumm18 <- summary(AceFit_4var18, verbose = TRUE)

# h2 
round(mxEval(ACE.h2, AceFit_4var18), 3) 

# c2
round(mxEval(ACE.c2, AceFit_4var18), 3) 

# e2
round(mxEval(ACE.e2, AceFit_4var18), 3) 

table18 <- as.tibble(AceSumm18$CI) %>%
    mutate(ACE = c(rep("h2", 4), rep("c2", 4), rep("e2", 4))) %>%
    mutate(Variable = rep(c("Isolation18",
                            "Depression18",
                            "Conduct18", 
                            "Psychosis18"), 3)) %>%
    select(Variable, ACE, lbound, estimate, ubound) %>%
    mutate(across(is.numeric, round, digits = 3))

table18
```

## All variables (w/o anxiety)

Here we will run a correlated factors model on all the age 18 variables (without anxiety)

```{r number of variables (phenotypes)}
# number of variables
nv <- 8    					      # number of variables 
ntv <- nv*2 				      # number of twin variables

# default optimizer 
mxOption(NULL, "Default optimizer", "CSOLNP")

selvars_chosen <- c("sisoe12norm",   "cdie12norm",   "conec12norm", "psysympe12norm", 
                    "socisoe18norm", "mdesxe18norm", "cdsxe18norm", "psyexpe18norm",
                    "sisoy12norm",   "cdiy12norm",   "conyc12norm", "psysympy12norm", 
                    "socisoy18norm", "mdesxy18norm", "cdsxy18norm", "psyexpy18norm")
```

```{r start values}
# start values
svM	  <- c(rep(0.7, ntv))	  # means               
svSD  <- c(rep(1.1, ntv))   # standard deviations
svRmz <- c(rep(0.3, 6))     # correlations for MZ
svRdz <- c(rep(0.15, 6))    # correlations for DZ 

rowVars	<- rep('Vars', nv)                          
colVars	<- rep(c('h2', 'c2', 'e2'), each = nv)

# labels
means_8var <- c("m1", "m2", "m3", "m4", "m5", "m6", "m7", "m8", "m1", "m2", "m3", "m4", "m5", "m6", "m7", "m8")
patha_8var <- c("a11","a21","a31","a41","a51","a61","a71","a81",
                "a22","a32","a42","a52","a62","a72","a82",
                "a33","a43","a53","a63","a73","a83",
                "a44","a54","a64","a74","a84",
                "a55","a65","a75","a85",
                "a66","a76","a86",
                "a77","a87",
                "a88")
pathc_8var <- c("c11","c21","c31","c41","c51","c61","c71","c81",
                "c22","c32","c42","c52","c62","c72","c82",
                "c33","c43","c53","c63","c73","c83",
                "c44","c54","c64","c74","c84",
                "c55","c65","c75","c85",
                "c66","c76","c86",
                "c77","c87",
                "c88")
pathe_8var <- c("e11","e21","e31","e41","e51","e61","e71","e81",
                "e22","e32","e42","e52","e62","e72","e82",
                "e33","e43","e53","e63","e73","e83",
                "e44","e54","e64","e74","e84",
                "e55","e65","e75","e85",
                "e66","e76","e86",
                "e77","e87",
                "e88")
```

```{r model estimation}
pathA	<- mxMatrix(type = "Lower", nrow = nv, ncol = nv, free = TRUE, values = c(rep(0.5, 36)), labels = patha_8var, name = "a")
pathC	<- mxMatrix(type = "Lower", nrow = nv, ncol = nv, free = TRUE, values = c(rep(0.5, 36)), labels = pathc_8var, name = "c")
pathE	<- mxMatrix(type = "Lower", nrow = nv, ncol = nv, free = TRUE, values = c(rep(0.5, 36)), labels = pathe_8var, name = "e")

MeanG	<- mxMatrix(type = "Full", nrow = 1, ncol = ntv, free = TRUE, values = svM, labels = means_8var, name = "ExpMean")

# Non-standardized variance components
covA	<- mxAlgebra(expression = a %*% t(a), name = "A")
covC	<- mxAlgebra(expression = c %*% t(c), name = "C") 
covE	<- mxAlgebra(expression = e %*% t(e), name = "E")

# Standardized variance components
covP <- mxAlgebra(expression = A + C + E, name = "V" )  # total variance in the phenotype
StA	<- mxAlgebra(expression = A/V, name = "h2")         # proportion of variance explained by additive genetic factors
StC	<- mxAlgebra(expression = C/V, name = "c2")         # proportion of variance explained by shared environment
StE	<- mxAlgebra(expression = E/V, name = "e2")         # proportion of variance explained by unique environment

matI <- mxMatrix(type = "Iden", nrow = nv, ncol = nv, name = "I")
# matIsd <-mxAlgebra(solve(sqrt(I*V)), name = "isd") # extracting the variances from the diagonal of the covariance matrix V 
rph	<- mxAlgebra(expression = solve(sqrt(I*V)) %*% V %*% solve(sqrt(I*V)), name = "Rph") # new identity matrix for standardising 
rA	<- mxAlgebra(expression = solve(sqrt(I*A)) %*% A %*% solve(sqrt(I*A)), name = "Ra")
rC	<- mxAlgebra(expression = solve(sqrt(I*C)) %*% C %*% solve(sqrt(I*C)), name = "Rc") 
rE	<- mxAlgebra(expression = solve(sqrt(I*E)) %*% E %*% solve(sqrt(I*E)), name = "Re")

rphace <- mxAlgebra(expression = cbind((sqrt(h2[1,1])*Ra[2,1]*sqrt(h2[2,2]))/Rph[2,1],  # path tracing var1 to var2 A 
                                       (sqrt(h2[1,1])*Ra[3,1]*sqrt(h2[3,3]))/Rph[3,1],  # path tracing var1 to var3 A
                                       (sqrt(h2[1,1])*Ra[4,1]*sqrt(h2[4,4]))/Rph[4,1],  # path tracing var1 to var4 A
                                       (sqrt(h2[1,1])*Ra[5,1]*sqrt(h2[5,5]))/Rph[5,1],  # path tracing var1 to var5 A
                                       (sqrt(h2[1,1])*Ra[6,1]*sqrt(h2[6,6]))/Rph[6,1],  # path tracing var1 to var6 A
                                       (sqrt(h2[1,1])*Ra[7,1]*sqrt(h2[7,7]))/Rph[7,1],  # path tracing var1 to var7 A
                                       (sqrt(h2[1,1])*Ra[8,1]*sqrt(h2[8,8]))/Rph[8,1],  # path tracing var1 to var8 A
                                       (sqrt(h2[2,2])*Ra[3,2]*sqrt(h2[3,3]))/Rph[3,2],  # path tracing var2 to var3 A
                                       (sqrt(h2[2,2])*Ra[4,2]*sqrt(h2[4,4]))/Rph[4,2],  # path tracing var2 to var4 A
                                       (sqrt(h2[2,2])*Ra[5,2]*sqrt(h2[5,5]))/Rph[5,2],  # path tracing var2 to var5 A
                                       (sqrt(h2[2,2])*Ra[6,2]*sqrt(h2[6,6]))/Rph[6,2],  # path tracing var2 to var6 A
                                       (sqrt(h2[2,2])*Ra[7,2]*sqrt(h2[7,7]))/Rph[7,2],  # path tracing var2 to var7 A
                                       (sqrt(h2[2,2])*Ra[8,2]*sqrt(h2[8,8]))/Rph[8,2],  # path tracing var2 to var8 A
                                       (sqrt(h2[3,3])*Ra[4,3]*sqrt(h2[4,4]))/Rph[4,3],  # path tracing var3 to var4 A
                                       (sqrt(h2[3,3])*Ra[5,3]*sqrt(h2[5,5]))/Rph[5,3],  # path tracing var3 to var5 A
                                       (sqrt(h2[3,3])*Ra[6,3]*sqrt(h2[6,6]))/Rph[6,3],  # path tracing var3 to var6 A
                                       (sqrt(h2[3,3])*Ra[7,3]*sqrt(h2[7,7]))/Rph[7,3],  # path tracing var3 to var7 A
                                       (sqrt(h2[3,3])*Ra[8,3]*sqrt(h2[8,8]))/Rph[8,3],  # path tracing var3 to var8 A
                                       (sqrt(h2[4,4])*Ra[5,4]*sqrt(h2[5,5]))/Rph[5,4],  # path tracing var4 to var5 A
                                       (sqrt(h2[4,4])*Ra[6,4]*sqrt(h2[6,6]))/Rph[6,4],  # path tracing var4 to var6 A
                                       (sqrt(h2[4,4])*Ra[7,4]*sqrt(h2[7,7]))/Rph[7,4],  # path tracing var4 to var7 A
                                       (sqrt(h2[4,4])*Ra[8,4]*sqrt(h2[8,8]))/Rph[8,4],  # path tracing var4 to var8 A
                                       (sqrt(h2[5,5])*Ra[6,5]*sqrt(h2[6,6]))/Rph[6,5],  # path tracing var5 to var6 A
                                       (sqrt(h2[5,5])*Ra[7,5]*sqrt(h2[7,7]))/Rph[7,5],  # path tracing var5 to var7 A
                                       (sqrt(h2[5,5])*Ra[8,5]*sqrt(h2[8,8]))/Rph[8,5],  # path tracing var5 to var8 A
                                       (sqrt(h2[6,6])*Ra[6,5]*sqrt(h2[7,7]))/Rph[6,5],  # path tracing var6 to var7 A
                                       (sqrt(h2[6,6])*Ra[8,5]*sqrt(h2[8,8]))/Rph[8,5],  # path tracing var6 to var8 A
                                       (sqrt(h2[7,7])*Ra[8,7]*sqrt(h2[8,8]))/Rph[8,7],  # path tracing var7 to var8 A
                                       
                                       (sqrt(c2[1,1])*Rc[2,1]*sqrt(c2[2,2]))/Rph[2,1],  # path tracing var1 to var2 C 
                                       (sqrt(c2[1,1])*Rc[3,1]*sqrt(c2[3,3]))/Rph[3,1],  # path tracing var1 to var3 C
                                       (sqrt(c2[1,1])*Rc[4,1]*sqrt(c2[4,4]))/Rph[4,1],  # path tracing var1 to var4 C
                                       (sqrt(c2[1,1])*Rc[5,1]*sqrt(c2[5,5]))/Rph[5,1],  # path tracing var1 to var5 C
                                       (sqrt(c2[1,1])*Rc[6,1]*sqrt(c2[6,6]))/Rph[6,1],  # path tracing var1 to var6 C
                                       (sqrt(c2[1,1])*Rc[7,1]*sqrt(c2[7,7]))/Rph[7,1],  # path tracing var1 to var7 C
                                       (sqrt(c2[1,1])*Rc[8,1]*sqrt(c2[8,8]))/Rph[8,1],  # path tracing var1 to var8 C
                                       (sqrt(c2[2,2])*Rc[3,2]*sqrt(c2[3,3]))/Rph[3,2],  # path tracing var2 to var3 C
                                       (sqrt(c2[2,2])*Rc[4,2]*sqrt(c2[4,4]))/Rph[4,2],  # path tracing var2 to var4 C
                                       (sqrt(c2[2,2])*Rc[5,2]*sqrt(c2[5,5]))/Rph[5,2],  # path tracing var2 to var5 C
                                       (sqrt(c2[2,2])*Rc[6,2]*sqrt(c2[6,6]))/Rph[6,2],  # path tracing var2 to var6 C
                                       (sqrt(c2[2,2])*Rc[7,2]*sqrt(c2[7,7]))/Rph[7,2],  # path tracing var2 to var7 C
                                       (sqrt(c2[2,2])*Rc[8,2]*sqrt(c2[8,8]))/Rph[8,2],  # path tracing var2 to var8 C
                                       (sqrt(c2[3,3])*Rc[4,3]*sqrt(c2[4,4]))/Rph[4,3],  # path tracing var3 to var4 C
                                       (sqrt(c2[3,3])*Rc[5,3]*sqrt(c2[5,5]))/Rph[5,3],  # path tracing var3 to var5 C
                                       (sqrt(c2[3,3])*Rc[6,3]*sqrt(c2[6,6]))/Rph[6,3],  # path tracing var3 to var6 C
                                       (sqrt(c2[3,3])*Rc[7,3]*sqrt(c2[7,7]))/Rph[7,3],  # path tracing var3 to var7 C
                                       (sqrt(c2[3,3])*Rc[8,3]*sqrt(c2[8,8]))/Rph[8,3],  # path tracing var3 to var8 C
                                       (sqrt(c2[4,4])*Rc[5,4]*sqrt(c2[5,5]))/Rph[5,4],  # path tracing var4 to var5 C
                                       (sqrt(c2[4,4])*Rc[6,4]*sqrt(c2[6,6]))/Rph[6,4],  # path tracing var4 to var6 C
                                       (sqrt(c2[4,4])*Rc[7,4]*sqrt(c2[7,7]))/Rph[7,4],  # path tracing var4 to var7 C
                                       (sqrt(c2[4,4])*Rc[8,4]*sqrt(c2[8,8]))/Rph[8,4],  # path tracing var4 to var8 C
                                       (sqrt(c2[5,5])*Rc[6,5]*sqrt(c2[6,6]))/Rph[6,5],  # path tracing var5 to var6 C
                                       (sqrt(c2[5,5])*Rc[7,5]*sqrt(c2[7,7]))/Rph[7,5],  # path tracing var5 to var7 C
                                       (sqrt(c2[5,5])*Rc[8,5]*sqrt(c2[8,8]))/Rph[8,5],  # path tracing var5 to var8 C
                                       (sqrt(c2[6,6])*Rc[6,5]*sqrt(c2[7,7]))/Rph[6,5],  # path tracing var6 to var7 C
                                       (sqrt(c2[6,6])*Rc[8,5]*sqrt(c2[8,8]))/Rph[8,5],  # path tracing var6 to var8 C
                                       (sqrt(c2[7,7])*Rc[8,7]*sqrt(c2[8,8]))/Rph[8,7],  # path tracing var7 to var8 C
                                       
                                       (sqrt(e2[1,1])*Re[2,1]*sqrt(e2[2,2]))/Rph[2,1],  # path tracing var1 to var2 E 
                                       (sqrt(e2[1,1])*Re[3,1]*sqrt(e2[3,3]))/Rph[3,1],  # path tracing var1 to var3 E
                                       (sqrt(e2[1,1])*Re[4,1]*sqrt(e2[4,4]))/Rph[4,1],  # path tracing var1 to var4 E
                                       (sqrt(e2[1,1])*Re[5,1]*sqrt(e2[5,5]))/Rph[5,1],  # path tracing var1 to var5 E
                                       (sqrt(e2[1,1])*Re[6,1]*sqrt(e2[6,6]))/Rph[6,1],  # path tracing var1 to var6 E
                                       (sqrt(e2[1,1])*Re[7,1]*sqrt(e2[7,7]))/Rph[7,1],  # path tracing var1 to var7 E
                                       (sqrt(e2[1,1])*Re[8,1]*sqrt(e2[8,8]))/Rph[8,1],  # path tracing var1 to var8 E
                                       (sqrt(e2[2,2])*Re[3,2]*sqrt(e2[3,3]))/Rph[3,2],  # path tracing var2 to var3 E
                                       (sqrt(e2[2,2])*Re[4,2]*sqrt(e2[4,4]))/Rph[4,2],  # path tracing var2 to var4 E
                                       (sqrt(e2[2,2])*Re[5,2]*sqrt(e2[5,5]))/Rph[5,2],  # path tracing var2 to var5 E
                                       (sqrt(e2[2,2])*Re[6,2]*sqrt(e2[6,6]))/Rph[6,2],  # path tracing var2 to var6 E
                                       (sqrt(e2[2,2])*Re[7,2]*sqrt(e2[7,7]))/Rph[7,2],  # path tracing var2 to var7 E
                                       (sqrt(e2[2,2])*Re[8,2]*sqrt(e2[8,8]))/Rph[8,2],  # path tracing var2 to var8 E
                                       (sqrt(e2[3,3])*Re[4,3]*sqrt(e2[4,4]))/Rph[4,3],  # path tracing var3 to var4 E
                                       (sqrt(e2[3,3])*Re[5,3]*sqrt(e2[5,5]))/Rph[5,3],  # path tracing var3 to var5 E
                                       (sqrt(e2[3,3])*Re[6,3]*sqrt(e2[6,6]))/Rph[6,3],  # path tracing var3 to var6 E
                                       (sqrt(e2[3,3])*Re[7,3]*sqrt(e2[7,7]))/Rph[7,3],  # path tracing var3 to var7 E
                                       (sqrt(e2[3,3])*Re[8,3]*sqrt(e2[8,8]))/Rph[8,3],  # path tracing var3 to var8 E
                                       (sqrt(e2[4,4])*Re[5,4]*sqrt(e2[5,5]))/Rph[5,4],  # path tracing var4 to var5 E
                                       (sqrt(e2[4,4])*Re[6,4]*sqrt(e2[6,6]))/Rph[6,4],  # path tracing var4 to var6 E
                                       (sqrt(e2[4,4])*Re[7,4]*sqrt(e2[7,7]))/Rph[7,4],  # path tracing var4 to var7 E
                                       (sqrt(e2[4,4])*Re[8,4]*sqrt(e2[8,8]))/Rph[8,4],  # path tracing var4 to var8 E
                                       (sqrt(e2[5,5])*Re[6,5]*sqrt(e2[6,6]))/Rph[6,5],  # path tracing var5 to var6 E
                                       (sqrt(e2[5,5])*Re[7,5]*sqrt(e2[7,7]))/Rph[7,5],  # path tracing var5 to var7 E
                                       (sqrt(e2[5,5])*Re[8,5]*sqrt(e2[8,8]))/Rph[8,5],  # path tracing var5 to var8 E
                                       (sqrt(e2[6,6])*Re[6,5]*sqrt(e2[7,7]))/Rph[6,5],  # path tracing var6 to var7 E
                                       (sqrt(e2[6,6])*Re[8,5]*sqrt(e2[8,8]))/Rph[8,5],  # path tracing var6 to var8 E
                                       (sqrt(e2[7,7])*Re[8,7]*sqrt(e2[8,8]))/Rph[8,7]   # path tracing var7 to var8 E
                                      ), 
                    name = "RphACE" ) # added /Rph to work out the % of the phenotypic correlation is due to these associations

# standardise estimates
#estVars	<- mxAlgebra(expression = cbind(h2, c2, e2), name = "Est", dimnames = list(rowVars,colVars)) # is this needed?

# expected variance/covariance matrices
covMZ	<- mxAlgebra(expression = rbind(cbind(A+C+E, A+C),
                                          cbind(A+C, A+C+E)), name = "expCovMZ" )
covDZ	<- mxAlgebra(expression = rbind(cbind(A+C+E, 0.5%x%A+C),
                                          cbind(0.5%x%A+C, A+C+E)), name = "expCovDZ" )

# data objects 
dataMZ <- mxData(observed = dat.twin.MZ, type = "raw")
dataDZ <- mxData(observed = dat.twin.DZ, type = "raw")

fitFunction <- mxFitFunctionML()
```

```{r ACE confidence intervals}
# h2, c2, e2 
Conf1	<- mxCI(c('h2[1,1]', 'h2[2,2]','h2[3,3]', 'h2[4,4]', 'h2[5,5]', 'h2[6,6]', 'h2[7,7]', 'h2[8,8]', 'c2[1,1]', 'c2[2,2]', 'c2[3,3]', 'c2[4,4]', 'c2[5,5]', 'c2[6,6]', 'c2[7,7]', 'c2[8,8]', 'e2[1,1]', 'e2[2,2]', 'e2[3,3]', 'e2[4,4]', 'e2[5,5]', 'e2[6,6]', 'e2[7,7]', 'e2[8,8]'))
# factor correlation - off-diagonal
# Conf2	<- mxCI(c('Rph[2,1]', 'Ra[2,1]', 'Rc[2,1]', 'Re[2,1]', 'Rph[3,1]', 'Ra[3,1]', 'Rc[3,1]', 'Re[3,1]', 'Rph[4,1]', 'Ra[4,1]', 'Rc[4,1]', 'Re[4,1]', 'Rph[3,2]', 'Ra[3,2]', 'Rc[3,2]', 'Re[3,2]', 'Rph[4,2]', 'Ra[4,2]', 'Rc[4,2]', 'Re[4,2]', 'Rph[4,3]', 'Ra[4,3]', 'Rc[4,3]', 'Re[4,3]')) 
```

```{r ACE model estimation}
# enter the variables 
objMZ	<- mxExpectationNormal(covariance = "expCovMZ", means = "ExpMean", dimnames = selvars_chosen)
objDZ	<- mxExpectationNormal(covariance = "expCovDZ", means = "ExpMean", dimnames = selvars_chosen)

# all parameters to be estimated 
pars <- list(pathA, pathC, pathE, covA, covC, covE, covP, StA, StC, StE, matI, rph, rA, rC, rE, MeanG, rphace)

# add these to the model for MZ and DZ with the matrices we have created
modelMZ	<- mxModel(pars, covMZ, dataMZ, objMZ, fitFunction, name = "MZ")
modelDZ	<- mxModel(pars, covDZ, dataDZ, objDZ, fitFunction, name = "DZ")

# fitting
minus2ll <- mxAlgebra(expression = MZ.objective + DZ.objective, name = "m2LL")
obj <- mxFitFunctionAlgebra("m2LL")

# full model
AceModel_8var <- mxModel("ACE", pars, modelMZ, modelDZ, minus2ll, obj, Conf1)

# run ACE
AceFit_8var <- mxRun(AceModel_8var, intervals = TRUE)
```

```{r run ACE model}
# summary - this shows the position in the cells for each matrix 
AceSumm_8var <- summary(AceFit_8var, verbose = TRUE)

AceSumm_8var$AIC.Mx

# h2 
round(diag(mxEval(ACE.h2, AceFit_8var)), 3) 

# c2
round(diag(mxEval(ACE.c2, AceFit_8var)), 3) 

# e2
round(diag(mxEval(ACE.e2, AceFit_8var)), 3) 

ACE_esitmates_table_8varCI(data = AceSumm_8var,
                       variables = c("Isolation12", 
                                     "Depression12", 
                                     "Conduct12", 
                                     "Psychosis12", 
                                     "Isolation18", 
                                     "Depression18", 
                                     "Conduct18", 
                                     "Psychosis18"))

# correlation between the A, C, and E factors - to what extend is variable one the same as variable two 
AceFit_8var$ACE.Rph # total phenotypic correlation (including A, C, and E)
AceFit_8var$ACE.Ra  # correlations between the a factors
AceFit_8var$ACE.Rc  # correlations between the c factors
AceFit_8var$ACE.Re  # correlations between the e factors

t(as.data.frame(mxEval(ACE.RphACE, AceFit_8var))) # need to look at which association this is referring to 
```

***

## All variables scalar

```{r number of variables (phenotypes)}
# number of variables
nv <- 8    					      # number of variables 
ntv <- nv*2 				      # number of twin variables

# default optimizer 
mxOption(NULL, "Default optimizer", "CSOLNP")

selvars_chosen <- c("sisoe12norm",   "cdie12norm",   "conec12norm", "psysympe12norm", 
                    "socisoe18norm", "mdesxe18norm", "cdsxe18norm", "psyexpe18norm",
                    "sisoy12norm",   "cdiy12norm",   "conyc12norm", "psysympy12norm", 
                    "socisoy18norm", "mdesxy18norm", "cdsxy18norm", "psyexpy18norm")
```

```{r start values}
# start values
svM	  <- c(rep(0.7, ntv))	  # means               
svSD  <- c(rep(1.1, ntv))   # standard deviations
svRmz <- c(rep(0.3, 6))     # correlations for MZ
svRdz <- c(rep(0.15, 6))    # correlations for DZ 

rowVars	<- rep('Vars', nv)                          
colVars	<- rep(c('h2', 'c2', 'e2'), each = nv)

# labels
means_8var <- c("m1", "m2", "m3", "m4", "m5", "m6", "m7", "m8", "m1", "m2", "m3", "m4", "m5", "m6", "m7", "m8")
patha_8var <- c("a11","a21","a31","a41","a51","a61","a71","a81",
                "a22","a32","a42","a52","a62","a72","a82",
                "a33","a43","a53","a63","a73","a83",
                "a44","a54","a64","a74","a84",
                "a55","a65","a75","a85",
                "a66","a76","a86",
                "a77","a87",
                "a88")
pathc_8var <- c("c11","c21","c31","c41","c51","c61","c71","c81",
                "c22","c32","c42","c52","c62","c72","c82",
                "c33","c43","c53","c63","c73","c83",
                "c44","c54","c64","c74","c84",
                "c55","c65","c75","c85",
                "c66","c76","c86",
                "c77","c87",
                "c88")
pathe_8var <- c("e11","e21","e31","e41","e51","e61","e71","e81",
                "e22","e32","e42","e52","e62","e72","e82",
                "e33","e43","e53","e63","e73","e83",
                "e44","e54","e64","e74","e84",
                "e55","e65","e75","e85",
                "e66","e76","e86",
                "e77","e87",
                "e88")
```

```{r labels for means, sds, and scalar}
# labels for the means
LabMM	  <- paste("mm", 1:nv, sep = "")		# Male singleton
LabMF	  <- paste("mf", 1:nv, sep = "")		# Female singleton
LabMMM	<- c(LabMM, LabMM)			          # male-male pairs
LabMFF	<- c(LabMF, LabMF)			          # female-female pairs

# labels for the A, C and E standard deviation matrices (paths from latent factors to variables) no sex dif
LabAm	  <- paste("apm", 1:nv, sep = "")		
LabCm	  <- paste("cpm", 1:nv, sep = "")		
LabEm	  <- paste("epm", 1:nv, sep = "")		

# labels for the scalar matrix
LabS		<- paste("s", 1:nv, sep = "")		
LabSS  	<- c(LabS, LabS)
LabNA	  <- c("NA")
# Labdos	<- c(LabNA, LabS) # dont think we need this one
PatF		<- c(F)
PatT		<- c(T)
Pat	  	<- c(PatF, PatT)
```

```{r start values}
Stpath	  <- c(.6) 			# change here according to the variances of the variables
Stcor		  <- c(.6)
Stmean	  <- 4.6
StScalar	<-c(.8)				# change here to >1 if female variance is larger than males or if it is mixed
DumOnes	  <-c(1)
StSdos	  <- c(DumOnes,StScalar)		# Scalar for Males is just 1 - do we need this??
```

```{r model estimation}
pathA	<- mxMatrix(type = "Lower", nrow = nv, ncol = nv, free = TRUE, values = c(rep(0.5, 36)), labels = patha_8var, name = "a")
pathC	<- mxMatrix(type = "Lower", nrow = nv, ncol = nv, free = TRUE, values = c(rep(0.5, 36)), labels = pathc_8var, name = "c")
pathE	<- mxMatrix(type = "Lower", nrow = nv, ncol = nv, free = TRUE, values = c(rep(0.5, 36)), labels = pathe_8var, name = "e")

# Matrices to estimate Means for Male/Female pairs
MeanMM	<- mxMatrix("Full", 1, ntv, free = TRUE, values = c(Stmean, Stmean), labels = LabMMM, name = "expMeanMM")
MeanM		<- mxMatrix("Full", 1, nv,  free = TRUE, values = c(Stmean), 		     labels = LabMM, 	name = "expMeanM")
MeanFF	<- mxMatrix("Full", 1, ntv, free = TRUE, values = c(Stmean, Stmean), labels = LabMFF,	name = "expMeanFF")
MeanF		<- mxMatrix("Full", 1, nv,  free = TRUE, values = c(Stmean), 		     labels = LabMF, 	name = "expMeanF")

# Non-standardized variance components
covA	<- mxAlgebra(expression = a %*% t(a), name = "A")
covC	<- mxAlgebra(expression = c %*% t(c), name = "C") 
covE	<- mxAlgebra(expression = e %*% t(e), name = "E")

# Standardized variance components
covP <- mxAlgebra(expression = A + C + E, name = "V" )  # total variance in the phenotype
StA	<- mxAlgebra(expression = A/V, name = "h2")         # proportion of variance explained by additive genetic factors
StC	<- mxAlgebra(expression = C/V, name = "c2")         # proportion of variance explained by shared environment
StE	<- mxAlgebra(expression = E/V, name = "e2")         # proportion of variance explained by unique environment

# scalar
ScalarF	<- mxMatrix(type = "Diag", nrow = ntv, ncol = ntv, free = TRUE, values = StScalar, label = LabSS, name = "ScF")

matI <- mxMatrix(type = "Iden", nrow = nv, ncol = nv, name = "I")
# matIsd <-mxAlgebra(solve(sqrt(I*V)), name = "isd") # extracting the variances from the diagonal of the covariance matrix V 
rph	<- mxAlgebra(expression = solve(sqrt(I*V)) %*% V %*% solve(sqrt(I*V)), name = "Rph") # new identity matrix for standardising 
rA	<- mxAlgebra(expression = solve(sqrt(I*A)) %*% A %*% solve(sqrt(I*A)), name = "Ra")
rC	<- mxAlgebra(expression = solve(sqrt(I*C)) %*% C %*% solve(sqrt(I*C)), name = "Rc") 
rE	<- mxAlgebra(expression = solve(sqrt(I*E)) %*% E %*% solve(sqrt(I*E)), name = "Re")

# standardise estimates
#estVars	<- mxAlgebra(expression = cbind(h2, c2, e2), name = "Est", dimnames = list(rowVars,colVars)) # is this needed?

# expected variance/covariance matrices
covMZM	<- mxAlgebra(expression = rbind(cbind(A+C+E, A+C),
                                          cbind(A+C, A+C+E)), name = "expCovMZM" )
covDZM	<- mxAlgebra(expression = rbind(cbind(A+C+E, 0.5%x%A+C),
                                          cbind(0.5%x%A+C, A+C+E)), name = "expCovDZM" )

covMZF	<- mxAlgebra(expression = ScF %&%(rbind(cbind(A+C+E, A+C),
                                          cbind(A+C, A+C+E))), name = "expCovMZF" )
covDZF	<- mxAlgebra(expression = ScF %&%(rbind(cbind(A+C+E, 0.5%x%A+C),
                                          cbind(0.5%x%A+C, A+C+E))), name = "expCovDZF" )

# data objects 
dataMZM	<- mxData(dat.twin.MZm, type = "raw")
dataMZF	<- mxData(dat.twin.MZf, type = "raw")
dataDZM	<- mxData(dat.twin.DZm, type = "raw")
dataDZF	<- mxData(dat.twin.DZf, type = "raw")

fitFunction <- mxFitFunctionML()
```

```{r ACE confidence intervals}
# h2, c2, e2 
Conf1	<- mxCI(c('h2[1,1]', 'h2[2,2]','h2[3,3]', 'h2[4,4]', 'h2[5,5]', 'h2[6,6]', 'h2[7,7]', 'h2[8,8]', 'c2[1,1]', 'c2[2,2]', 'c2[3,3]', 'c2[4,4]', 'c2[5,5]', 'c2[6,6]', 'c2[7,7]', 'c2[8,8]', 'e2[1,1]', 'e2[2,2]', 'e2[3,3]', 'e2[4,4]', 'e2[5,5]', 'e2[6,6]', 'e2[7,7]', 'e2[8,8]'))
# factor correlation - off-diagonal
# Conf2	<- mxCI(c('Rph[2,1]', 'Ra[2,1]', 'Rc[2,1]', 'Re[2,1]', 'Rph[3,1]', 'Ra[3,1]', 'Rc[3,1]', 'Re[3,1]', 'Rph[4,1]', 'Ra[4,1]', 'Rc[4,1]', 'Re[4,1]', 'Rph[3,2]', 'Ra[3,2]', 'Rc[3,2]', 'Re[3,2]', 'Rph[4,2]', 'Ra[4,2]', 'Rc[4,2]', 'Re[4,2]', 'Rph[4,3]', 'Ra[4,3]', 'Rc[4,3]', 'Re[4,3]')) 
```

**can't get this to run for some reason**

```{r ACE model estimation}
# enter the variables 
objMZM	<- mxExpectationNormal(covariance = "expCovMZM", means = "ExpMeanMM", dimnames = selvars_chosen)
objDZM	<- mxExpectationNormal(covariance = "expCovDZM", means = "ExpMeanMM", dimnames = selvars_chosen)
objMZF	<- mxExpectationNormal(covariance = "expCovMZF", means = "ExpMeanFF", dimnames = selvars_chosen)
objDZF	<- mxExpectationNormal(covariance = "expCovDZF", means = "ExpMeanFF", dimnames = selvars_chosen)

# all parameters to be estimated 
pars <- list(pathA, pathC, pathE, covA, covC, covE, covP, StA, StC, StE, matI, rph, rA, rC, rE)

# add these to the model for MZ and DZ with the matrices we have created
modelMZM	<- mxModel(pars, MeanM, MeanMM, covMZM, dataMZM, objMZM, fitFunction, name = "MZM")
modelDZM	<- mxModel(pars, MeanM, MeanMM, covDZM, dataDZM, objDZM, fitFunction, name = "DZM")
modelMZF	<- mxModel(pars, MeanF, MeanFF, covMZF, dataMZF, objMZF, fitFunction, name = "MZF")
modelDZF	<- mxModel(pars, MeanF, MeanFF, covDZF, dataDZF, objDZF, fitFunction, name = "DZF")

# fitting
minus2ll <- mxAlgebra(expression = MZM.objective + DZM.objective + MZF.objective + DZF.objective, name = "m2LL")
obj <- mxFitFunctionAlgebra("m2LL")

# full model
AceModel_8var_scalar <- mxModel("ACE", pars, modelMZM, modelDZM, modelMZF, modelDZF, minus2ll, obj, Conf1)

# run ACE
AceFit_8var_scalar <- mxRun(AceModel_8var_scalar, intervals = TRUE)
AceFit_8var_scalar_sum <- summary(AceFit_8var_scalar)
```



















