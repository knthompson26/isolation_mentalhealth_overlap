---
title: "The overlap between social isolation and mental health problems: ACE model" 
output:  
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: false
    number_sections: false
    highlight: monochrome
    theme: flatly
    code_folding: show
    includes:
      after_body: footer.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      comment = NA,
                      prompt = FALSE,
                      cache = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      results = 'markup')

options(bitmapType = 'quartz') # to render fonts better
```

```{r Clear global environment, include=FALSE}
remove(list = ls())
```

```{r Load packages, include=FALSE}
library(knitr)
library(haven)
library(psych)   
library(bestNormalize)
library(OpenMx)
library(tidyr)
library(tidyverse)
library(dplyr) #conflicts with tidyverse for e.g. rename and row_number
```

```{r source the data file path, include=FALSE}
# source raw data directory
source("../isolation_mentalhealth_data_path.R")
```

```{r read in dta data file, include=FALSE}
dat.raw <- read_dta(paste0(data_path_raw, "Katie_23Sep22.dta"))
colnames(dat.raw)
```

# Functions

```{r function}
# table for ACE estimates
ACE_esitmates_table <- function(data, variable, age){
  table <- as.tibble(data$CI) %>%
  mutate(ACE = c("h2", "c2", "e2")) %>%
  mutate(Variable = variable) %>%
  mutate(Age = age) %>%
  select(Variable, Age, ACE, estimate, lbound, ubound) %>%
  mutate(across(is.numeric, round, digits = 3))
  
  return(table)
}
```
 
# Data prep

### Column names

```{r select variables needed}
dat <- dat.raw %>%
  dplyr::select(
         atwinid,
         btwinid,
         familyid,
         rorderp5,
         torder,
         zygosity,
         sampsex,
         sisoe12,
         sisoy12,
         masce12,     # anxiety
         mascy12,   
         cdie12,      # depression
         cdiy12,
         conec12,     # antisocial behaviour / conduct disorder
         conyc12,
         psysympe12,  # psychosis - why is this not the tot scale variable - to give more variation?
         psysympy12,
         socisoe18,
         socisoy18,
         gadsxe18,    # anxiety
         gadsxy18,
         mdesxe18,    # depression
         mdesxy18,
         cdsxe18,     # antisocial behaviour / conduct disorder
         cdsxy18,
         psyexpe18,   # psychotic experiences
         psyexpy18
  )

colnames(dat)
```

### Recode variables into factors {.tabset .tabset-fade}

#### Sex

```{r recode sex}
dat <- dat %>%
  mutate(
    sex = 
      recode_factor(as_factor(sampsex),
        "1" = "Male",
        "2" = "Female"))

table(dat$sex)
```

#### Zygosity

```{r recode zygosity}
dat <- dat %>%
  mutate(
    zygosity = 
      recode_factor(as_factor(zygosity),
        "1" = "MZ",
        "2" = "DZ"))
table(dat$zygosity)
```

### Convert variables to numeric

```{r create numeric isolation variables}
dat <- dat %>%
  mutate(
    sisoe12 = as.numeric(sisoe12),
    sisoy12 = as.numeric(sisoy12),
    masce12 = as.numeric(masce12),       # anxiety
    mascy12 = as.numeric(mascy12),   
    cdie12 = as.numeric(cdie12),         # depression
    cdiy12 = as.numeric(cdiy12),
    conec12 = as.numeric(conec12),       # antisocial behaviour / conduct disorder
    conyc12 = as.numeric(conyc12),
    psysympe12 = as.numeric(psysympe12), # psychosis - why is this not the tot scale variable - to give more variation?
    psysympy12 = as.numeric(psysympy12),
    socisoe18 = as.numeric(socisoe18),
    socisoy18 = as.numeric(socisoy18),
    gadsxe18 = as.numeric(gadsxe18),     # anxiety
    gadsxy18 = as.numeric(gadsxy18),
    mdesxe18 = as.numeric(mdesxe18),     # depression
    mdesxy18 = as.numeric(mdesxy18),
    cdsxe18 = as.numeric(cdsxe18),       # antisocial behaviour / conduct disorder
    cdsxy18 = as.numeric(cdsxy18),
    psyexpe18 = as.numeric(psyexpe18),   # psychotic experiences
    psyexpy18 = as.numeric(psyexpy18)
  ) %>%
  select(                                # remove variables not needed
    -c(sampsex)
  )
```

# Variable lists

```{r select variables - raw}
# social isolation
selvars_si12 <- c("sisoe12", "sisoy12")
selvars_si18 <- c("socisoe18", "socisoy18")

# anxiety
selvars_anx12 <- c("masce12", "mascy12")
selvars_anx18 <- c("gadsxe18", "gadsxy18")

# depression
selvars_dep12 <- c("cdie12", "cdiy12")
selvars_dep18 <- c("mdesxe18", "mdesxy18")

# conduct
selvars_con12 <- c("conec12", "conyc12")
selvars_con18 <- c("cdsxe18", "cdsxy18")

# psychosis
selvars_psy12 <- c("psysympe12", "psysympy12")
selvars_psy18 <- c("psyexpe18", "psyexpy18")

# all 
selvars <- c("sisoe12", "masce12", "cdie12", "conec12",  "psysympe12", "socisoe18", "gadsxe18", "mdesxe18", "cdsxe18", "psyexpe18",
             "sisoy12", "mascy12", "cdiy12", "conyc12", "psysympy12",  "socisoy18", "gadsxy18", "mdesxy18", "cdsxy18","psyexpy18")
```

```{r select variables - standardised}
# social isolation
selvars_si12_z_score <- c("z_score_sisoe12", "z_score_sisoy12")
selvars_si18_z_score <- c("z_score_socisoe18", "z_score_socisoy18")

# anxiety
selvars_anx12_z_score <- c("z_score_masce12", "z_score_mascy12")
selvars_anx18_z_score <- c("z_score_gadsxe18", "z_score_gadsxy18")

# depression
selvars_dep12_z_score <- c("z_score_cdie12", "z_score_cdiy12")
selvars_dep18_z_score <- c("z_score_mdesxe18", "z_score_mdesxy18")

# conduct
selvars_con12_z_score <- c("z_score_conec12", "z_score_conyc12")
selvars_con18_z_score <- c("z_score_cdsxe18", "z_score_cdsxy18")

# psychosis
selvars_psy12_z_score <- c("z_score_psysympe12", "z_score_psysympy12")
selvars_psy18_z_score <- c("z_score_psyexpe18", "z_score_psyexpy18")
```

```{r select variables - normalised}
# social isolation
selvars_si12norm <- c("sisoe12norm", "sisoy12norm")
selvars_si18norm <- c("socisoe18norm", "socisoy18norm")

# anxiety
selvars_anx12norm <- c("masce12norm", "mascy12norm")
selvars_anx18norm <- c("gadsxe18norm", "gadsxy18norm")

# depression
selvars_dep12norm <- c("cdie12norm", "cdiy12norm")
selvars_dep18norm <- c("mdesxe18norm", "mdesxy18norm")

# conduct
selvars_con12norm <- c("conec12norm", "conyc12norm")
selvars_con18norm <- c("cdsxe18norm", "cdsxy18norm")

# psychosis
selvars_psy12norm <- c("psysympe12norm", "psysympy12norm")
selvars_psy18norm <- c("psyexpe18norm", "psyexpy18norm")

# all 
selvars_norm <- c("sisoe12norm", "masce12norm", "cdie12norm", "conec12norm", "psysympe12norm", "socisoe18norm", "gadsxe18norm", "mdesxe18norm", "cdsxe18norm", "psyexpe18norm",
                  "sisoy12norm", "mascy12norm", "cdiy12norm", "conyc12norm", "psysympy12norm", "socisoy18norm", "gadsxy18norm", "mdesxy18norm", "cdsxy18norm", "psyexpy18norm")

# all with non-normalised - not in the twin modelling specific order here only used to standardise all variables at once
selvars_norm_all <- c("sisoe12", "sisoy12", "masce12", "mascy12", "cdie12", "cdiy12", "conec12", "conyc12", "psysympe12", "psysympy12", 
                      "socisoe18", "socisoy18", "gadsxe18", "gadsxy18", "mdesxe18", "mdesxy18", "cdsxe18", "cdsxy18", "psyexpe18", "psyexpy18",
                      "sisoe12norm", "sisoy12norm", "masce12norm", "mascy12norm", "cdie12norm", "cdiy12norm", "conec12norm", "conyc12norm", "psysympe12norm", "psysympy12norm", 
                      "socisoe18norm", "socisoy18norm", "gadsxe18norm", "gadsxy18norm", "mdesxe18norm", "mdesxy18norm", "cdsxe18norm", "cdsxy18norm", "psyexpe18norm", "psyexpy18norm")
```

```{r select variables - standardised and normalised}
# social isolation
selvars_si12_z_score_norm <- c("z_score_sisoe12norm", "z_score_sisoy12norm")
selvars_si18_z_score_norm <- c("z_score_socisoe18norm", "z_score_socisoy18norm")

# anxiety
selvars_anx12_z_score_norm <- c("z_score_masce12norm", "z_score_mascy12norm")
selvars_anx18_z_score_norm <- c("z_score_gadsxe18norm", "z_score_gadsxy18norm")

# depression
selvars_dep12_z_score_norm <- c("z_score_cdie12norm", "z_score_cdiy12norm")
selvars_dep18_z_score_norm <- c("z_score_mdesxe18norm", "z_score_mdesxy18norm")

# conduct
selvars_con12_z_score_norm <- c("z_score_conec12", "z_score_conyc12")
selvars_con18_z_score_norm <- c("z_score_cdsxe18norm", "z_score_cdsxy18norm")

# psychosis
selvars_psy12norm_z_score_norm <- c("z_score_psysympe12norm", "z_score_psysympy12norm")
selvars_psy18norm_z_score_norm <- c("z_score_psyexpe18norm", "z_score_psyexpy18norm")
```

# Data prep

## Skewness

```{r histograms}
# isolation
hist(dat$sisoe12)    # not normal
hist(dat$socisoe18)  # not normal
# anxiety
hist(dat$masce12)    # normal
hist(dat$gadsxe18)   # not normal
# depression
hist(dat$cdie12)     # not normal
hist(dat$mdesxe18)   # not normal
# conduct
hist(dat$conec12)    # not normal
hist(dat$cdsxe18)    # not normal
# psychosis
hist(dat$psysympe12) # not normal
hist(dat$psyexpe18)  # not normal
```


## Regress out age and sex

*** 
NEED TO GET TWIN AGE VARIABLES?
***

```{r Regress out age and sex}
# # twin 1
# dat$sisoe12_reg <- (resid(lm(data = dat, sisoe12 ~ tagee12 * sex, na.action = na.exclude))) # The * operator denotes factor crossing: a*b interpreted as a+b+a:b
# dat$socisoe18_reg <- (resid(lm(data = dat, socisoe18 ~ tagee18 * sex, na.action = na.exclude)))
# dat$masce12_reg <- (resid(lm(data = dat, masce12 ~ tagee12 * sex, na.action = na.exclude)))
# dat$sisoe12_reg <- (resid(lm(data = dat, sisoe12 ~ tagee12 * sex, na.action = na.exclude)))
# dat$sisoe12_reg <- (resid(lm(data = dat, sisoe12 ~ tagee12 * sex, na.action = na.exclude)))
# 
# #Twin 2
# dat$sisoy12_reg <- (resid(lm(data = dat, sisoy12 ~ tagey12 * sex, na.action = na.exclude)))
# dat$socisoy18_reg <- (resid(lm(data = dat, socisoy18 ~ tagey18 * sex, na.action = na.exclude)))
# dat$sisoe12_reg <- (resid(lm(data = dat, sisoe12 ~ tagee12 * sex, na.action = na.exclude)))
# dat$sisoe12_reg <- (resid(lm(data = dat, sisoe12 ~ tagee12 * sex, na.action = na.exclude)))
# dat$sisoe12_reg <- (resid(lm(data = dat, sisoe12 ~ tagee12 * sex, na.action = na.exclude)))
```

## Rank transformation

Almost all variables are non-normal, therefore, we will use the van der Waerden's rank-based transformation in Kaili's paper [here](https://acamh.onlinelibrary.wiley.com/doi/full/10.1002/jcv2.12053), where for analyses using transformed data, they conducted the van der Waerden transformation prior to residualizing for age and sex as has been recommended by [Pain et al. 2018](https://www.nature.com/articles/s41431-018-0159-6).  

I will transform all variables to get the normalised estimate, but will use the raw anxiety at age 12 as it's already normal. 

```{r rank transform variables elder variables}
# isolation age 12
sisoe12_n <- bestNormalize(dat$sisoe12)    # select the type of transformation needed
dat$sisoe12norm <- predict(sisoe12_n)      # create normalised variable
hist(dat$sisoe12norm)                  
summary(dat$sisoe12norm)

# isolation age 18
socisoe18_n <- bestNormalize(dat$socisoe18)    
dat$socisoe18norm <- predict(socisoe18_n)  
hist(dat$socisoe18norm)                  
summary(dat$socisoe18norm)

# anxiety age 12 - wont actually use this as it's already normally distributed
masce12_n <- bestNormalize(dat$masce12)    
dat$masce12norm <- predict(masce12_n)  
hist(dat$masce12norm)                  
summary(dat$masce12norm)

# anxiety age 18
gadsxe18_n <- bestNormalize(dat$gadsxe18)    
dat$gadsxe18norm <- predict(gadsxe18_n)  
hist(dat$gadsxe18norm)                  
summary(dat$gadsxe18norm)

# depression age 12
cdie12_n <- bestNormalize(dat$cdie12)    
dat$cdie12norm <- predict(cdie12_n)  
hist(dat$cdie12norm)                  
summary(dat$cdie12norm)

# depression age 18
mdesxe18_n <- bestNormalize(dat$mdesxe18)    
dat$mdesxe18norm <- predict(mdesxe18_n)  
hist(dat$mdesxe18norm)                  
summary(dat$mdesxe18norm)

# conduct age 12
conec12_n <- bestNormalize(dat$conec12)    
dat$conec12norm <- predict(conec12_n)  
hist(dat$conec12norm)                  
summary(dat$conec12norm)

# conduct age 18
cdsxe18_n <- bestNormalize(dat$cdsxe18)    
dat$cdsxe18norm <- predict(cdsxe18_n)  
hist(dat$cdsxe18norm)                  
summary(dat$cdsxe18norm)

# psychosis age 12
psysympe12_n <- bestNormalize(dat$psysympe12)    
dat$psysympe12norm <- predict(psysympe12_n)  
hist(dat$psysympe12norm)                  
summary(dat$psysympe12norm)

# psychosis age 18
psyexpe18_n <- bestNormalize(dat$psyexpe18)    
dat$psyexpe18norm <- predict(psyexpe18_n)  
hist(dat$psyexpe18norm)                  
summary(dat$psyexpe18norm)
```

```{r rank transform variables younger variables}
# isolation age 12
sisoy12_n <- bestNormalize(dat$sisoy12)    # select the type of transformation needed
dat$sisoy12norm <- predict(sisoy12_n)  # create normalised variable
hist(dat$sisoy12norm)                  
summary(dat$sisoy12norm)

# isolation age 18
socisoy18_n <- bestNormalize(dat$socisoy18)    
dat$socisoy18norm <- predict(socisoy18_n)  
hist(dat$socisoy18norm)                  
summary(dat$socisoy18norm)

# anxiety age 12 - wont actually use this as it's already normally distributed
mascy12_n <- bestNormalize(dat$mascy12)    
dat$mascy12norm <- predict(mascy12_n)  
hist(dat$mascy12norm)                  
summary(dat$mascy12norm)

# anxiety age 18
gadsxy18_n <- bestNormalize(dat$gadsxy18)    
dat$gadsxy18norm <- predict(gadsxy18_n)  
hist(dat$gadsxy18norm)                  
summary(dat$gadsxy18norm)

# depression age 12
cdiy12_n <- bestNormalize(dat$cdiy12)    
dat$cdiy12norm <- predict(cdiy12_n)  
hist(dat$cdiy12norm)                  
summary(dat$cdiy12norm)

# depression age 18
mdesxy18_n <- bestNormalize(dat$mdesxy18)    
dat$mdesxy18norm <- predict(mdesxy18_n)  
hist(dat$mdesxy18norm)                  
summary(dat$mdesxy18norm)

# conduct age 12
conyc12_n <- bestNormalize(dat$conyc12)    
dat$conyc12norm <- predict(conyc12_n)  
hist(dat$conyc12norm)                  
summary(dat$conyc12norm)

# conduct age 18
cdsxy18_n <- bestNormalize(dat$cdsxy18)    
dat$cdsxy18norm <- predict(cdsxy18_n)  
hist(dat$cdsxy18norm)                  
summary(dat$cdsxy18norm)

# psychosis age 12
psysympy12_n <- bestNormalize(dat$psysympy12)    
dat$psysympy12norm <- predict(psysympy12_n)  
hist(dat$psysympy12norm)                  
summary(dat$psysympy12norm)

# psychosis age 18
psyexpy18_n <- bestNormalize(dat$psyexpy18)    
dat$psyexpy18norm <- predict(psyexpy18_n)  
hist(dat$psyexpy18norm)                  
summary(dat$psyexpy18norm)
```

## Standardising

Create *z scores* for all variables. 

```{r scale variables and combine to MZ dataset}
# create a scaled version of the continuous variables - z scores for all variables
scaled_continuous_data <- as.data.frame(scale(dat[selvars_norm_all], center = TRUE, scale = TRUE))

# rename variables to show that they are z scores 
colnames(scaled_continuous_data) <- paste0("z_score_", colnames(scaled_continuous_data))

# combine the scaled data to the main dataset for  and DZ twins
dat <- cbind(dat, scaled_continuous_data)

colnames(dat)
```

### Create twin dataset

To remove the double entry in the data, we will remove everyone who has a "random twin order" variable of 0. This will then remove any birth order effects. 

```{r remove one twin pair row}
dat.twin <- dat %>% filter(rorderp5 == "1")
```

```{r datasets for MZ and DZ}
dat.twin.MZ <- dat.twin %>% filter(zygosity == "MZ")
dat.twin.DZ <- dat.twin %>% filter(zygosity == "DZ")

# male only
dat.twin.MZm <- dat.twin.MZ %>% filter(sex == "Male")
dat.twin.DZm <- dat.twin.DZ %>% filter(sex == "Male")
# female only
dat.twin.MZf <- dat.twin.MZ %>% filter(sex == "Female")
dat.twin.DZf <- dat.twin.DZ %>% filter(sex == "Female")
```

### Summary of MZ and DZ data

```{r describe MZ and DZ data}
MZ_summary <- describe(dat.twin.MZ, 
                       skew = FALSE, 
                       range = FALSE)

DZ_summary <- describe(dat.twin.DZ, 
                       skew = FALSE, 
                       range = FALSE)
```

## MZ

```{r MZ matrices}
# covariance matrix
covar.mz <- cov(dat.twin.MZ[, selvars], use = "complete")
# correlation matrix (standardized covariance)
cor.mz <- cor(dat.twin.MZ[, selvars], use = "complete")
# round(cor.mz, 3)
```

## DZ

```{r DZ matrices}
# covariance matrix
covar.dz <- cov(dat.twin.DZ[, selvars], use = "complete")
# correlation matrix (standardized covariance)
cor.dz <- cor(dat.twin.DZ[, selvars], use = "complete")
# round(cor.dz, 3)
```

# Set up univariate ACE model

```{r number of variables (phenotypes)}
# number of variables
nv <- 1    					      # number of variables 
ntv <- nv*2 				      # number of twin variables

# default optimizer 
mxOption(NULL, "Default optimizer", "CSOLNP")
```

```{r start values}
# start values
svM	  <- c(rep(0.7, ntv))	  # means               
svSD  <- c(rep(1.1, ntv))   # standard deviations
svRmz <- c(0.3)             # correlations for MZ
svRdz <- c(0.15)            # correlations for DZ 

rowVars	<- rep('Vars', nv)
colVars	<- rep(c('h2', 'c2', 'e2'), each = nv)
```

```{r specity ACE}
# Matrix & Algebra for expected means vector (free)
MeanMZ <- mxMatrix("Full", 1, ntv, free = T, values = c(90,90), labels = c("MZm1", "MZm2"), name = "expMeanMZ")
MeanDZ <- mxMatrix("Full", 1, ntv, free = T, values = c(90,90), labels = c("DZm1", "DZm2"), name = "expMeanDZ")

# Matrices to estimate free a, c, and e path coefficients
pathA	<- mxMatrix(type = "Full", nrow = nv, ncol = nv, free = T, values = 10, label = "a11", name = "a")
pathC	<- mxMatrix(type = "Full", nrow = nv, ncol = nv, free = T, values = 10, label = "c11", name = "c")
pathE	<- mxMatrix(type = "Full", nrow = nv, ncol = nv, free = T, values = 10, label = "e11", name = "e")

# Algebra to generate Matrices to hold A, C, and E computed Variance Components
covA <- mxAlgebra(expression = a %*% t(a), name = "A" )
covC <- mxAlgebra(expression = c %*% t(c), name = "C" )
covE <- mxAlgebra(expression = e %*% t(e), name = "E" )

# Algebra to compute Total Variance
covP <- mxAlgebra(expression = A+C+E, name = "V" )
sd   <- mxAlgebra(expression = sqrt(V), name = "SD")

# Algebra to compute standardized path estimates 
stpathA	<- mxAlgebra(expression = a/SD, name = "sta")
stpathC <- mxAlgebra(expression = c/SD, name = "stc")
stpathE <- mxAlgebra(expression = e/SD, name = "ste")

# Algebra to compute standardized variance components 
stcovA <- mxAlgebra(expression = A/V, name = "h2")
stcovC <- mxAlgebra(expression = C/V, name = "c2")
stcovE <- mxAlgebra(expression = E/V, name = "e2")

# Algebra for Expected Variance/Covariance Matrices in MZ & DZ twins
covMZ <- mxAlgebra(expression = rbind(cbind(A+C+E,A+C), cbind(A+C,A+C+E)), name = "expCovMZ")
covDZ <- mxAlgebra(expression = rbind(cbind(A+C+E,0.5%x%A+C),cbind(0.5%x%A+C,A+C+E)),	name = "expCovDZ")

# Data objects for Multiple Groups
dataMZ <-mxData(observed = dat.twin.MZ, type = "raw")
dataDZ <-mxData(observed = dat.twin.DZ, type = "raw")

fitFunction <- mxFitFunctionML()
```

# Social isolation 

## Age 12

**First, select which variable list to use: raw, standardised, normalised, or standardised and normalised**

```{r select which variables to use}
# selvars_si12_chosen <- selvars_si12                 # raw
# selvars_si12_chosen <- selvars_si12_z_score         # standardised
selvars_si12_chosen <- selvars_si12norm             # normalised
# selvars_si12_chosen <- selvars_si12_z_score_norm    # standardised and normalised
```

```{r run age 12 isolation ACE}
# Objective objects for Multiple Groups
objMZ <- mxExpectationNormal(covariance = "expCovMZ", means = "expMeanMZ", dimnames = selvars_si12_chosen)
objDZ <- mxExpectationNormal(covariance = "expCovDZ", means = "expMeanDZ", dimnames = selvars_si12_chosen)

# Combine Groups
pars <- list(pathA, pathC, pathE, covA, covC, covE, covP, sd, stpathA, stpathC, stpathE, stcovA, stcovC, stcovE, fitFunction)

# MZ and DZ models
modelMZ	<- mxModel(pars, MeanMZ, covMZ, dataMZ, objMZ, name = "MZ")
modelDZ	<- mxModel(pars, MeanDZ, covDZ, dataDZ, objDZ, name = "DZ")

# Fitting
minus2ll	<- mxAlgebra(expression = MZ.objective + DZ.objective, name = "m2LL")
obj	    	<- mxFitFunctionAlgebra("m2LL")
Conf	  	<- mxCI(c('ACE.h2', 'ACE.c2', 'ACE.e2'))

# Model
ACEModel <- mxModel("ACE", pars, modelMZ, modelDZ, minus2ll, obj, Conf) 

# Run
ACEFit_isolation12 <- mxRun(ACEModel, intervals = TRUE)
isolation12_estimates <- summary(ACEFit_isolation12)

# Table
isolation12_table <- ACE_esitmates_table(
  data = isolation12_estimates, 
  variable = "Social isolation",
  age = "12")

isolation12_table
```

raw: 
Social isolation	12	h2	0.421	
Social isolation	12	c2	0.000	
Social isolation	12	e2	0.579	

standardized:
Social isolation	12	h2	0.421	
Social isolation	12	c2	0.000	
Social isolation	12	e2	0.579	

normalised:
Social isolation	12	h2	0.421
Social isolation	12	c2	0.000
Social isolation	12	e2	0.579

## Age 18

```{r select which variables to use}
# selvars_si18_chosen <- selvars_si18                 # raw
# selvars_si18_chosen <- selvars_si18_z_score         # standardised
selvars_si18_chosen <- selvars_si18norm             # normalised
# selvars_si18_chosen <- selvars_si18_z_score_norm    # standardised and normalised
```

```{r run age 18 isolation ACE}
# Objective objects for Multiple Groups
objMZ <- mxExpectationNormal(covariance = "expCovMZ", means = "expMeanMZ", dimnames = selvars_si18_chosen)
objDZ <- mxExpectationNormal(covariance = "expCovDZ", means = "expMeanDZ", dimnames = selvars_si18_chosen)

# Combine Groups
pars <- list(pathA, pathC, pathE, covA, covC, covE, covP, sd, stpathA, stpathC, stpathE, stcovA, stcovC, stcovE, fitFunction)

# MZ and DZ models
modelMZ	<- mxModel(pars, MeanMZ, covMZ, dataMZ, objMZ, name = "MZ")
modelDZ	<- mxModel(pars, MeanDZ, covDZ, dataDZ, objDZ, name = "DZ")

# Fitting
minus2ll	<- mxAlgebra(expression = MZ.objective + DZ.objective, name = "m2LL")
obj	    	<- mxFitFunctionAlgebra("m2LL")
Conf	  	<- mxCI(c('ACE.h2', 'ACE.c2', 'ACE.e2'))

# Model
ACEModel <- mxModel("ACE", pars, modelMZ, modelDZ, minus2ll, obj, Conf) 

# Run
ACEFit_isolation18 <- mxRun(ACEModel, intervals = TRUE)
isolation18_estimates <- summary(ACEFit_isolation18)

# Table
isolation18_table <- ACE_esitmates_table(
  data = isolation18_estimates, 
  variable = "Social isolation",
  age = "18")

isolation18_table
```

raw:
Social isolation	18	h2	0.4575
Social isolation	18	c2	0.0000
Social isolation	18	e2	0.5425

standardised:
Social isolation	18	h2	0.4575
Social isolation	18	c2	0.0000
Social isolation	18	e2	0.5425

normalised:
Social isolation	18	h2	0.4575
Social isolation	18	c2	0.0000
Social isolation	18	e2	0.5425

# Anxiety

## Age 12

```{r select which variables to use}
# selvars_anx12_chosen <- selvars_anx12                 # raw
# selvars_anx12_chosen <- selvars_anx12_z_score         # standardised
selvars_anx12_chosen <- selvars_anx12norm             # normalised
# selvars_anx12_chosen <- selvars_anx12_z_score_norm    # standardised and normalised
```

```{r run age 12 anxiety ACE}
# Objective objects for Multiple Groups
objMZ <- mxExpectationNormal(covariance = "expCovMZ", means = "expMeanMZ", dimnames = selvars_anx12_chosen)
objDZ <- mxExpectationNormal(covariance = "expCovDZ", means = "expMeanDZ", dimnames = selvars_anx12_chosen)

# Combine Groups
pars <- list(pathA, pathC, pathE, covA, covC, covE, covP, sd, stpathA, stpathC, stpathE, stcovA, stcovC, stcovE, fitFunction)

# MZ and DZ models
modelMZ	<- mxModel(pars, MeanMZ, covMZ, dataMZ, objMZ, name = "MZ")
modelDZ	<- mxModel(pars, MeanDZ, covDZ, dataDZ, objDZ, name = "DZ")

# Fitting
minus2ll	<- mxAlgebra(expression = MZ.objective + DZ.objective, name = "m2LL")
obj	    	<- mxFitFunctionAlgebra("m2LL")
Conf	  	<- mxCI(c('ACE.h2', 'ACE.c2', 'ACE.e2'))

# Model
ACEModel <- mxModel("ACE", pars, modelMZ, modelDZ, minus2ll, obj, Conf) 

# Run
ACEFit_anxiety12 <- mxRun(ACEModel, intervals = TRUE)
anxiety12_estimates <- summary(ACEFit_anxiety12)

# Table
anxiety12_table <- ACE_esitmates_table(
  data = anxiety12_estimates, 
  variable = "Anxiety",
  age = "12")

anxiety12_table
```

raw:
Anxiety	12	h2	0.289
Anxiety	12	c2	0.112
Anxiety	12	e2	0.600	

standardised:
Anxiety	12	h2	0.289
Anxiety	12	c2	0.112
Anxiety	12	e2	0.600	

normalised:
Anxiety	12	h2	0.270
Anxiety	12	c2	0.114
Anxiety	12	e2	0.615

## Age 18

```{r select which variables to use}
# selvars_anx18_chosen <- selvars_anx18                 # raw
# selvars_anx18_chosen <- selvars_anx18_z_score         # standardised
selvars_anx18_chosen <- selvars_anx18norm             # normalised
# selvars_anx18_chosen <- selvars_anx18_z_score_norm    # standardised and normalised
```

```{r run age 18 anxiety ACE}
# Objective objects for Multiple Groups
objMZ <- mxExpectationNormal(covariance = "expCovMZ", means = "expMeanMZ", dimnames = selvars_anx18_chosen)
objDZ <- mxExpectationNormal(covariance = "expCovDZ", means = "expMeanDZ", dimnames = selvars_anx18_chosen)

# Combine Groups
pars <- list(pathA, pathC, pathE, covA, covC, covE, covP, sd, stpathA, stpathC, stpathE, stcovA, stcovC, stcovE, fitFunction)

# MZ and DZ models
modelMZ	<- mxModel(pars, MeanMZ, covMZ, dataMZ, objMZ, name = "MZ")
modelDZ	<- mxModel(pars, MeanDZ, covDZ, dataDZ, objDZ, name = "DZ")

# Fitting
minus2ll	<- mxAlgebra(expression = MZ.objective + DZ.objective, name = "m2LL")
obj	    	<- mxFitFunctionAlgebra("m2LL")
Conf	  	<- mxCI(c('ACE.h2', 'ACE.c2', 'ACE.e2'))

# Model
ACEModel <- mxModel("ACE", pars, modelMZ, modelDZ, minus2ll, obj, Conf) 

# Run
ACEFit_anxiety18 <- mxRun(ACEModel, intervals = TRUE)
anxiety18_estimates <- summary(ACEFit_anxiety18)

# Table
anxiety18_table <- ACE_esitmates_table(
  data = anxiety18_estimates, 
  variable = "Anxiety",
  age = "18")

anxiety18_table
```

raw:
Anxiety	18	h2	0.255
Anxiety	18	c2	0.000
Anxiety	18	e2	0.745

standardised:
Anxiety	18	h2	0.255
Anxiety	18	c2	0.000
Anxiety	18	e2	0.745

normalised:
Anxiety	18	h2	0.255
Anxiety	18	c2	0.000
Anxiety	18	e2	0.745	

# Depression

## Age 12

```{r select which variables to use}
# selvars_dep12_chosen <- selvars_dep12                 # raw
# selvars_dep12_chosen <- selvars_dep12_z_score         # standardised
selvars_dep12_chosen <- selvars_dep12norm             # normalised
# selvars_dep12_chosen <- selvars_dep12_z_score_norm    # standardised and normalised
```

```{r run age 12 depression ACE}
# Objective objects for Multiple Groups
objMZ <- mxExpectationNormal(covariance = "expCovMZ", means = "expMeanMZ", dimnames = selvars_dep12_chosen)
objDZ <- mxExpectationNormal(covariance = "expCovDZ", means = "expMeanDZ", dimnames = selvars_dep12_chosen)

# Combine Groups
pars <- list(pathA, pathC, pathE, covA, covC, covE, covP, sd, stpathA, stpathC, stpathE, stcovA, stcovC, stcovE, fitFunction)

# MZ and DZ models
modelMZ	<- mxModel(pars, MeanMZ, covMZ, dataMZ, objMZ, name = "MZ")
modelDZ	<- mxModel(pars, MeanDZ, covDZ, dataDZ, objDZ, name = "DZ")

# Fitting
minus2ll	<- mxAlgebra(expression = MZ.objective + DZ.objective, name = "m2LL")
obj	    	<- mxFitFunctionAlgebra("m2LL")
Conf	  	<- mxCI(c('ACE.h2', 'ACE.c2', 'ACE.e2'))

# Model
ACEModel <- mxModel("ACE", pars, modelMZ, modelDZ, minus2ll, obj, Conf) 

# Run
ACEFit_depression12 <- mxRun(ACEModel, intervals = TRUE)
depression12_estimates <- summary(ACEFit_depression12)

# Table
depression12_table <- ACE_esitmates_table(
  data = depression12_estimates, 
  variable = "Depression",
  age = "12")
depression12_table
```

raw:
Depression	12	h2	0.294
Depression	12	c2	0.018
Depression	12	e2	0.687	

standardised:
Depression	12	h2	0.294
Depression	12	c2	0.018
Depression	12	e2	0.687	

normalised:
Depression	12	h2	0.210
Depression	12	c2	0.147
Depression	12	e2	0.643	

## Age 18

```{r select which variables to use}
# selvars_dep18_chosen <- selvars_dep18                 # raw
# selvars_dep18_chosen <- selvars_dep18_z_score         # standardised
selvars_dep18_chosen <- selvars_dep18norm             # normalised
# selvars_dep18_chosen <- selvars_dep18_z_score_norm    # standardised and normalised
```

```{r run age 18 depression ACE}
# Objective objects for Multiple Groups
objMZ <- mxExpectationNormal(covariance = "expCovMZ", means = "expMeanMZ", dimnames = selvars_dep18_chosen)
objDZ <- mxExpectationNormal(covariance = "expCovDZ", means = "expMeanDZ", dimnames = selvars_dep18_chosen)

# Combine Groups
pars <- list(pathA, pathC, pathE, covA, covC, covE, covP, sd, stpathA, stpathC, stpathE, stcovA, stcovC, stcovE, fitFunction)

# MZ and DZ models
modelMZ	<- mxModel(pars, MeanMZ, covMZ, dataMZ, objMZ, name = "MZ")
modelDZ	<- mxModel(pars, MeanDZ, covDZ, dataDZ, objDZ, name = "DZ")

# Fitting
minus2ll	<- mxAlgebra(expression = MZ.objective + DZ.objective, name = "m2LL")
obj	    	<- mxFitFunctionAlgebra("m2LL")
Conf	  	<- mxCI(c('ACE.h2', 'ACE.c2', 'ACE.e2'))

# Model
ACEModel <- mxModel("ACE", pars, modelMZ, modelDZ, minus2ll, obj, Conf) 

# Run
ACEFit_depression18 <- mxRun(ACEModel, intervals = TRUE)
depression18_estimates <- summary(ACEFit_depression18)

# Table
depression18_table <- ACE_esitmates_table(
  data = depression18_estimates, 
  variable = "Depression",
  age = "18")
depression18_table
```

raw:
Depression	18	h2	0.318
Depression	18	c2	0.000
Depression	18	e2	0.682

standardised:
Depression	18	h2	0.318
Depression	18	c2	0.000
Depression	18	e2	0.682	

normalised:
Depression	18	h2	0.325
Depression	18	c2	0.000
Depression	18	e2	0.675

# Conduct disorder

## Age 12

```{r select which variables to use}
# selvars_con12_chosen <- selvars_con12                 # raw
# selvars_con12_chosen <- selvars_con12_z_score         # standardised
selvars_con12_chosen <- selvars_con12norm             # normalised
# selvars_con12_chosen <- selvars_con12_z_score_norm    # standardised and normalised
```

```{r run age 12 conduct ACE}
# Objective objects for Multiple Groups
objMZ <- mxExpectationNormal(covariance = "expCovMZ", means = "expMeanMZ", dimnames = selvars_con12_chosen)
objDZ <- mxExpectationNormal(covariance = "expCovDZ", means = "expMeanDZ", dimnames = selvars_con12_chosen)

# Combine Groups
pars <- list(pathA, pathC, pathE, covA, covC, covE, covP, sd, stpathA, stpathC, stpathE, stcovA, stcovC, stcovE, fitFunction)

# MZ and DZ models
modelMZ	<- mxModel(pars, MeanMZ, covMZ, dataMZ, objMZ, name = "MZ")
modelDZ	<- mxModel(pars, MeanDZ, covDZ, dataDZ, objDZ, name = "DZ")

# Fitting
minus2ll	<- mxAlgebra(expression = MZ.objective + DZ.objective, name = "m2LL")
obj	    	<- mxFitFunctionAlgebra("m2LL")
Conf	  	<- mxCI(c('ACE.h2', 'ACE.c2', 'ACE.e2'))

# Model
ACEModel <- mxModel("ACE", pars, modelMZ, modelDZ, minus2ll, obj, Conf) 

# Run
ACEFit_conduct12 <- mxRun(ACEModel, intervals = TRUE)
conduct12_estimates <- summary(ACEFit_conduct12)

# Table
conduct12_table <- ACE_esitmates_table(
  data = conduct12_estimates, 
  variable = "Conduct disorder",
  age = "12")
conduct12_table
```

raw:
Conduct disorder	12	h2	0.137
Conduct disorder	12	c2	0.343
Conduct disorder	12	e2	0.519

standardised:
Conduct disorder	12	h2	0.137
Conduct disorder	12	c2	0.343
Conduct disorder	12	e2	0.519

normalised:
Conduct disorder	12	h2	0.187
Conduct disorder	12	c2	0.272
Conduct disorder	12	e2	0.541	


## Age 18

```{r select which variables to use}
# selvars_con18_chosen <- selvars_con18                 # raw
# selvars_con18_chosen <- selvars_con18_z_score         # standardised
selvars_con18_chosen <- selvars_con18norm             # normalised
# selvars_con18_chosen <- selvars_con18_z_score_norm    # standardised and normalised
```

```{r run age 18 conduct ACE}
# Objective objects for Multiple Groups
objMZ <- mxExpectationNormal(covariance = "expCovMZ", means = "expMeanMZ", dimnames = selvars_con18_chosen)
objDZ <- mxExpectationNormal(covariance = "expCovDZ", means = "expMeanDZ", dimnames = selvars_con18_chosen)

# Combine Groups
pars <- list(pathA, pathC, pathE, covA, covC, covE, covP, sd, stpathA, stpathC, stpathE, stcovA, stcovC, stcovE, fitFunction)

# MZ and DZ models
modelMZ	<- mxModel(pars, MeanMZ, covMZ, dataMZ, objMZ, name = "MZ")
modelDZ	<- mxModel(pars, MeanDZ, covDZ, dataDZ, objDZ, name = "DZ")

# Fitting
minus2ll	<- mxAlgebra(expression = MZ.objective + DZ.objective, name = "m2LL")
obj	    	<- mxFitFunctionAlgebra("m2LL")
Conf	  	<- mxCI(c('ACE.h2', 'ACE.c2', 'ACE.e2'))

# Model
ACEModel <- mxModel("ACE", pars, modelMZ, modelDZ, minus2ll, obj, Conf) 

# Run
ACEFit_conduct18 <- mxRun(ACEModel, intervals = TRUE)
conduct18_estimates <- summary(ACEFit_conduct18)

# Table
conduct18_table <- ACE_esitmates_table(
  data = conduct18_estimates, 
  variable = "Conduct disorder",
  age = "18")
conduct18_table
```

raw:
Conduct disorder	18	h2	0.209
Conduct disorder	18	c2	0.308
Conduct disorder	18	e2	0.483	

standardised:
Conduct disorder	18	h2	0.209
Conduct disorder	18	c2	0.308
Conduct disorder	18	e2	0.483	

normalised:
Conduct disorder	18	h2	0.184
Conduct disorder	18	c2	0.310
Conduct disorder	18	e2	0.506	

# Psychotic experiences

## Age 12

```{r select which variables to use}
# selvars_psy12_chosen <- selvars_psy12                 # raw
# selvars_psy12_chosen <- selvars_psy12_z_score         # standardised
selvars_psy12_chosen <- selvars_psy12norm             # normalised
# selvars_psy12_chosen <- selvars_psy12_z_score_norm    # standardised and normalised
```

```{r run age 12 psychosis ACE}
# Objective objects for Multiple Groups
objMZ <- mxExpectationNormal(covariance = "expCovMZ", means = "expMeanMZ", dimnames = selvars_psy12_chosen)
objDZ <- mxExpectationNormal(covariance = "expCovDZ", means = "expMeanDZ", dimnames = selvars_psy12_chosen)

# Combine Groups
pars <- list(pathA, pathC, pathE, covA, covC, covE, covP, sd, stpathA, stpathC, stpathE, stcovA, stcovC, stcovE, fitFunction)

# MZ and DZ models
modelMZ	<- mxModel(pars, MeanMZ, covMZ, dataMZ, objMZ, name = "MZ")
modelDZ	<- mxModel(pars, MeanDZ, covDZ, dataDZ, objDZ, name = "DZ")

# Fitting
minus2ll	<- mxAlgebra(expression = MZ.objective + DZ.objective, name = "m2LL")
obj	    	<- mxFitFunctionAlgebra("m2LL")
Conf	  	<- mxCI(c('ACE.h2', 'ACE.c2', 'ACE.e2'))

# Model
ACEModel <- mxModel("ACE", pars, modelMZ, modelDZ, minus2ll, obj, Conf) 

# Run
ACEFit_psychosis12 <- mxRun(ACEModel, intervals = TRUE)
psychosis12_estimates <- summary(ACEFit_psychosis12)

# Table
psychosis12_table <- ACE_esitmates_table(
  data = psychosis12_estimates, 
  variable = "Psychosis",
  age = "12")
psychosis12_table
```

raw:
Psychosis	12	h2	0.108
Psychosis	12	c2	0.185
Psychosis	12	e2	0.708	

standardised:
Psychosis	12	h2	0.108
Psychosis	12	c2	0.185
Psychosis	12	e2	0.708	

normalised:
Psychosis	12	h2	0.108
Psychosis	12	c2	0.185
Psychosis	12	e2	0.708	

## Age 18

```{r select which variables to use}
# selvars_psy18_chosen <- selvars_psy18                 # raw
# selvars_psy18_chosen <- selvars_psy18_z_score         # standardised
 selvars_psy18_chosen <- selvars_psy18norm             # normalised
# selvars_psy18_chosen <- selvars_psy18_z_score_norm    # standardised and normalised
```

```{r run age 18 psychosis ACE}
# Objective objects for Multiple Groups
objMZ <- mxExpectationNormal(covariance = "expCovMZ", means = "expMeanMZ", dimnames = selvars_psy18_chosen)
objDZ <- mxExpectationNormal(covariance = "expCovDZ", means = "expMeanDZ", dimnames = selvars_psy18_chosen)

# Combine Groups
pars <- list(pathA, pathC, pathE, covA, covC, covE, covP, sd, stpathA, stpathC, stpathE, stcovA, stcovC, stcovE, fitFunction)

# MZ and DZ models
modelMZ	<- mxModel(pars, MeanMZ, covMZ, dataMZ, objMZ, name = "MZ")
modelDZ	<- mxModel(pars, MeanDZ, covDZ, dataDZ, objDZ, name = "DZ")

# Fitting
minus2ll	<- mxAlgebra(expression = MZ.objective + DZ.objective, name = "m2LL")
obj	    	<- mxFitFunctionAlgebra("m2LL")
Conf	  	<- mxCI(c('ACE.h2', 'ACE.c2', 'ACE.e2'))

# Model
ACEModel <- mxModel("ACE", pars, modelMZ, modelDZ, minus2ll, obj, Conf) 

# Run
ACEFit_psychosis18 <- mxRun(ACEModel, intervals = TRUE)
psychosis18_estimates <- summary(ACEFit_psychosis18)

# Table 
psychosis18_table <- ACE_esitmates_table(
  data = psychosis18_estimates, 
  variable = "Psychosis",
  age = "18")
psychosis18_table
```

raw:
Psychosis	18	h2	0.237
Psychosis	18	c2	0.043
Psychosis	18	e2	0.720

standardised:
Psychosis	18	h2	0.237
Psychosis	18	c2	0.043
Psychosis	18	e2	0.720

normalised:
Psychosis	18	h2	0.237	
Psychosis	18	c2	0.043	
Psychosis	18	e2	0.720	

# Full estimates table 

```{r ACE estimates table for all variables}
ACE_estimates <- rbind(isolation12_table, 
                             isolation18_table,
                             anxiety12_table,
                             anxiety18_table,
                             depression12_table,
                             depression18_table,
                             conduct12_table,
                             conduct18_table,
                             psychosis12_table, 
                             psychosis18_table) 

ACE_estimates
```

