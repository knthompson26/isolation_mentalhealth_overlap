---
title: "Overlap between social isolation and mental health problems"
output:  
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: false
    number_sections: false
    highlight: monochrome
    theme: flatly
    code_folding: hide
    includes:
      after_body: footer.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      comment = NA,
                      prompt = FALSE,
                      cache = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      results = 'asis')

options(bitmapType = 'quartz') # to render fonts better
```

```{r Clear global environment, include=FALSE}
remove(list = ls())
```

```{r Load packages, include=FALSE}
library(knitr)
library(haven)
library(lavaan)
library(psych)   
library(OpenMx)
library(tidyr)
library(tidyverse)
library(dplyr) #conflicts with tidyverse for e.g. rename and row_number
```

```{r source the data file path, include=FALSE}
#source raw data directory: data_raw and data included
source("../isolation_mentalhealth_data_path.R")
```

```{r read in dta data file}
dat.raw <- read_dta(paste0(data_path_raw, "Katie_21Sep22.dta"))
colnames(dat.raw)
```

```{r select variables needed}
dat <- dat.raw %>%
  dplyr::select(
         atwinid,
         btwinid,
         familyid,
         rorderp5,
         torder,
         zygosity,
         sampsex,
         seswq35,
         sisoe5,
         sisoe7,
         sisoe10,
         sisoe12,
         sisoy5,
         sisoy7,
         sisoy10,
         sisoy12,
         tadhdem5,  
         tadhdem7,
         tadhdem10,
         tadhdem12,
         tadhdym5,  
         tadhdym7,
         tadhdym10,
         tadhdym12
  )

colnames(dat.old)
```

# Recode variables into factors

```{r recode sex}
dat <- dat %>%
  mutate(
    sex = 
      recode_factor(as_factor(sampsex),
        "1" = "Male",
        "2" = "Female"))

table(dat$sex)
```

```{r recode SES}
dat <- dat %>%
  mutate(
    SES = 
      recode_factor(as_factor(seswq35),
        "1" = "Low",
        "2" = "Middle", 
        "3" = "High"))

table(dat$SES)
```

```{r recode zygosity}
dat <- dat %>%
  mutate(
    zygosity = 
      recode_factor(as_factor(zygosity),
        "1" = "MZ",
        "2" = "DZ"))

table(dat$zygosity)
```

# Create variables as numeric versions

```{r create numeric isolation variables}
dat <- dat %>%
  mutate(
    sisoe5 = as.numeric(sisoe5),      # isolation elder
    sisoe7 = as.numeric(sisoe7),
    sisoe10 = as.numeric(sisoe10),
    sisoe12 = as.numeric(sisoe12),
    sisoy5 = as.numeric(sisoy5),      # isolation younger
    sisoy7 = as.numeric(sisoy7),
    sisoy10 = as.numeric(sisoy10),
    sisoy12 = as.numeric(sisoy12),
    tadhdem5 = as.numeric(tadhdem5),  # adhd elder
    tadhdem7 = as.numeric(tadhdem7),
    tadhdem10 = as.numeric(tadhdem10),
    tadhdem12 = as.numeric(tadhdem12),
    tadhdym5 = as.numeric(tadhdym5),  # adhd younger
    tadhdym7 = as.numeric(tadhdym7),
    tadhdym10 = as.numeric(tadhdym10),
    tadhdym12 = as.numeric(tadhdym12)
  )
colnames(dat)
```

# Creating twin datasets

```{r remove variables not needed}
dat <- dat %>% select(
      -c(sampsex, 
         seswq35)
         )
colnames(dat)
```

I guess to get the right layout for the data, you want to remove the double entering of the data. So you want to remove based on the random twin order variable? *need to check this with Tim*

```{r datasets for twin alalyses}
dat.twin <- dat %>% filter(rorderp5 == "1")
```

```{r datasets for MZ and DZ}
# with all data to check numbers
dat.MZ <- dat %>% filter(zygosity == "MZ")
dat.DZ <- dat %>% filter (zygosity == "DZ")

# twin layout
dat.twin.MZ <- dat.twin %>% filter(zygosity == "MZ")
dat.twin.DZ <- dat.twin %>% filter (zygosity == "DZ")
```

```{r describe MZ and DZ data}
MZ_summary <- describe(dat.twin.MZ, 
                       skew = FALSE, 
                       range = FALSE)
MZ_summary

DZ_summary <- describe(dat.twin.DZ, 
                       skew = FALSE, 
                       range = FALSE)
DZ_summary
```

# MZ and DZ correlation and covariance matrices

```{r select variables for correlations}
selvars <- c("sisoe5",
            "sisoe7",
            "sisoe10", 
            "sisoe12",
            "sisoy5",
            "sisoy7",
            "sisoy10",
            "sisoy12",
            "tadhdem5",
            "tadhdem7",
            "tadhdem10",
            "tadhdem12",
            "tadhdym5",
            "tadhdym7",
            "tadhdym10",
            "tadhdym12"
            )
```

Need to check the within-twin MZ and DZ phenotypic correlations (rmz, rdz) of each phenotype (correlations between elder and younger twin for each phenotype)

The rule of thumb is: 
 - if 2*rdz>rmz, choose an ACE model; 
 - if 2*rdz<rmz, choose a ADE model
 
Social isolation age 5: 
- rMZ = 0.585
- rDZ = 0.056 *seems very low?*
- 2*rDZ = 0.112
- 0.112<0.585 = ADE*?*

Social isolation age 7: 
- rMZ = 0.444
- rDZ = 0.159 
- 2*rDZ = 0.318
- 0.318<0.444 = ADE*?*

Social isolation age 10: 
- rMZ = 0.453
- rDZ = 0.174 
- 2*rDZ = 0.348
- 0.348<0.453 = ADE*?*

Social isolation age 12: 
- rMZ = 0.453
- rDZ = 0.110 
- 2*rDZ = 0.220
- 0.220<0.453 = ADE*?*

**surely this can't be right - ACE model would be the way to go here??**

Using Falconer's equations, we can obtain preliminary estimates of the standardized A, D, E variance components. 

For ADE:
VA = 4*rdz-rmz 
VD = 2*rmz-4*rdz
VE = 1-VA-VD

For ACE: *need to check this against my notes from boulder course*
VA = 2*rmz-rdz
VC = 1-VA+VE
VE= 1-rmz

```{r MZ matrices}
covar.mz <- cov(dat.twin.MZ[, selvars], use = "complete")
round(covar.mz, 3)

cor.mz <- cor(dat.twin.MZ[, selvars], use = "complete")
round(cor.mz, 3)
```

```{r DZ matrices}
covar.dz <- cov(dat.twin.DZ[, selvars], use = "complete")
round(covar.dz, 3)

cor.dz <- cor(dat.twin.DZ[, selvars], use = "complete")
round(cor.dz, 3)
```

I don't think much of the below is needed for analyses - this is just showing how to manipulate the matrices to get what you want 

```{r express covariance matrix using SD and correlations}
# variances from covariance matrix - diagonal is one variable with itself
var.mz <- diag(covar.mz) 
round(var.mz, 3)

# creating the standard deviation into a vector (sd is the square root of the variance) then put this into a matrix
sd.mz <- diag(sqrt(var.mz))
round(sd.mz, 3)

# re-calculating variance of mz (I think??)
Smz <- sd.mz%*%cor.mz%*%t(sd.mz) # boulder course says this is good to know but I'm not sure why
round(Smz, 3)
round(covar.mz - Smz, 3) # compare with previous calculation

# Therefore, you can also obtain the correlation matrix as follows
rMZ = cov2cor(covar.mz)
round(rMZ, 3)
```

--- KT LEFT OFF HERE ---

To check if we should account for main effects of sex, we will conduct linear regressions of the phenotypes on sex. We do this for the twin 1 then twin 2. 

```{r sex differences check}
r11=summary(lm(bic_T1~sex_T1, data=skinfold))
r12=summary(lm(tri_T1~sex_T1, data=skinfold))
r13=summary(lm(ssc_T1~sex_T1, data=skinfold))
r14=summary(lm(sil_T1~sex_T1, data=skinfold))
```


# OpenMX fitting

```{r mx set up}
mxOption(NULL, "Default optimizer","CSOLNP") #what does this actually do???? 
```




